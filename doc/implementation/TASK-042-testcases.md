# TDDテストケース仕様 - TASK-042 設定UI

**【機能名】**: TASK-042 設定UI（seed/count/テンプレート/リトライ）

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript
  - **言語選択の理由**: プロジェクト全体でTypeScriptを使用、型安全性によりテストの信頼性が向上
  - **テストに適した機能**: インターフェース定義による契約明確化、コンパイル時エラー検出
- **テストフレームワーク**: Vitest + Happy-DOM
  - **フレームワーク選択の理由**: 既存プロジェクトパターンに準拠、高速なViteベースのテストランナー
  - **テスト実行環境**: DOM操作テスト用Happy-DOM、Chrome API用包括的モック環境
- 🟢 **青信号**: 既存のプロジェクト構成から確定済み

## 1. 正常系テストケース（基本的な動作）

### TC-001-001: デフォルト設定値での初期化
- **テスト名**: デフォルト設定値での初期化
  - **何をテストするか**: SettingsUIコンポーネントが適切なデフォルト値で初期化されること
  - **期待される動作**: 未設定状態から標準的なデフォルト値がUI要素に表示される
- **入力値**: なし（初期化時）
  - **入力データの意味**: 新規ユーザーの初回利用時を想定
- **期待される結果**:
  ```typescript
  {
    imageCount: 1,
    seedMode: "random",
    seedValue: undefined,
    filenameTemplate: "{date}_{prompt}_{seed}_{idx}",
    retrySettings: {
      maxRetries: 5,
      baseDelay: 500,
      factor: 2.0
    }
  }
  ```
  - **期待結果の理由**: 要件定義書のデフォルト値仕様に準拠、安全な初期値設定
- **テストの目的**: UI初期化の正確性確認
  - **確認ポイント**: 全フォーム要素にデフォルト値が正しく設定されること
- 🟢 **青信号**: 要件定義書の仕様から確定

### TC-001-002: 有効な設定値の保存と復元
- **テスト名**: 有効な設定値の保存と復元サイクル
  - **何をテストするか**: 正常な入力値がchrome.storageに保存され、正確に復元されること
  - **期待される動作**: 設定変更→保存→再読込で同じ値が復元される
- **入力値**:
  ```typescript
  {
    imageCount: 5,
    seedMode: "fixed",
    seedValue: 12345,
    filenameTemplate: "art_{date}_{prompt}",
    retrySettings: {
      maxRetries: 3,
      baseDelay: 1000,
      factor: 1.5
    }
  }
  ```
  - **入力データの意味**: 一般的なユーザーがカスタマイズする実際的な設定値
- **期待される結果**: chrome.storage.local.setが呼ばれ、同じ値で復元されること
  - **期待結果の理由**: 設定の永続化がユーザビリティの基本要件
- **テストの目的**: 設定永続化の完全性確認
  - **確認ポイント**: ストレージAPIの呼び出しと値の一致性検証
- 🟢 **青信号**: 既存のstorageパターンから確定

### TC-001-003: seedMode切り替え時のUI動作
- **テスト名**: シードモード切り替え時のUI要素表示制御
  - **何をテストするか**: randomとfixedモード切り替え時にseedValue入力欄が適切に表示/非表示されること
  - **期待される動作**: random選択時はseedValue非表示、fixed選択時は表示・入力可能
- **入力値**: seedMode変更イベント（"random" ↔ "fixed"）
  - **入力データの意味**: ユーザーのラジオボタン操作を模擬
- **期待される結果**: seedValue入力欄のdisabled属性とvisibility適切な制御
  - **期待結果の理由**: UXの一貫性とユーザーの混乱防止
- **テストの目的**: 動的UI制御の正確性確認
  - **確認ポイント**: DOM要素の表示状態とフォーカス管理
- 🟡 **黄信号**: 要件から妥当な推測（UI動作パターン）

## 2. 異常系テストケース（エラーハンドリング）

### TC-002-001: 範囲外imageCount値の入力
- **テスト名**: 生成枚数範囲外値エラーハンドリング
  - **エラーケースの概要**: imageCountが1-100範囲外の値が入力された場合
  - **エラー処理の重要性**: 無効な枚数での処理実行を防ぎシステム安定性確保
- **入力値**: imageCount = 0, 101, -5, 999
  - **不正な理由**: 0は生成不可、100超過はパフォーマンス問題、負数は論理的に無効
  - **実際の発生シナリオ**: ユーザーの手動入力ミス、JavaScriptでの計算エラー
- **期待される結果**:
  - エラーメッセージ: "生成枚数は1〜100の範囲で入力してください"
  - フォーム送信ブロック、該当フィールドのハイライト
  - **エラーメッセージの内容**: 日本語での明確な範囲指示、修正方法の示唆
  - **システムの安全性**: 不正値での処理実行を完全に防止
- **テストの目的**: 入力値検証とユーザーフィードバックの確認
  - **品質保証の観点**: 不正入力による予期しない動作の防止
- 🟢 **青信号**: 既存テストケースで定義済み

### TC-002-002: chrome.storage操作失敗時の処理
- **テスト名**: ストレージ保存失敗時のエラーハンドリング
  - **エラーケースの概要**: chrome.storage.local.setがPermissionエラーや容量超過で失敗
  - **エラー処理の重要性**: 設定消失を防ぎ、ユーザーに適切な対処法を提示
- **入力値**: chrome.storage.local.set mock reject with QuotaExceededError
  - **不正な理由**: ストレージ容量制限、拡張機能権限の問題
  - **実際の発生シナリオ**: 他の拡張機能によるストレージ圧迫、権限変更
- **期待される結果**:
  - エラー通知: "設定の保存に失敗しました。ストレージ容量を確認してください"
  - 前回の設定値を保持、再試行オプション提供
  - **エラーメッセージの内容**: 技術的詳細と具体的な対処法の併記
  - **システムの安全性**: 部分的な設定保存による不整合状態の回避
- **テストの目的**: ストレージ障害時の堅牢性確認
  - **品質保証の観点**: 外部依存の失敗に対する適切な回復処理
- 🟢 **青信号**: 既存テストケースで定義済み

### TC-002-003: 不正な文字列を含むfilenameTemplateの処理
- **テスト名**: ファイル名テンプレート不正文字エラーハンドリング
  - **エラーケースの概要**: Windows禁止文字（<>:|?）が含まれるテンプレート
  - **エラー処理の重要性**: ファイル保存失敗とダウンロードエラーの予防
- **入力値**: filenameTemplate = "image<test>:file|name?.jpg"
  - **不正な理由**: Windows/Linuxファイルシステムで禁止された文字
  - **実際の発生シナリオ**: ユーザーの自由入力、他システムからのコピペ
- **期待される結果**:
  - エラーメッセージ: "ファイル名に使用できない文字が含まれています: < > : | ?"
  - 自動サニタイズオプションの提示
  - **エラーメッセージの内容**: 具体的な禁止文字の列挙と代替案
  - **システムの安全性**: ダウンロード時のファイル名エラー完全回避
- **テストの目的**: ファイル名検証とサニタイズ機能の確認
  - **品質保証の観点**: クロスプラットフォーム互換性の保証
- 🟢 **青信号**: EDGE-103要件とファイル名サニタイズ実装から確定

### TC-002-004: 不正なseedValue入力の処理
- **テスト名**: シード値範囲外・非数値エラーハンドリング
  - **エラーケースの概要**: seedValueが0未満、2^32以上、または非数値文字列
  - **エラー処理の重要性**: NovelAI APIの制約遵守と予期しない生成結果の防止
- **入力値**: seedValue = -1, 4294967296, "abc", null
  - **不正な理由**: NovelAI API仕様の制約、JavaScriptの安全な整数範囲
  - **実際の発生シナリオ**: ユーザーの直接入力、他のツールからの値コピー
- **期待される結果**:
  - エラーメッセージ: "シード値は0以上4294967295以下の整数を入力してください"
  - 無効値の自動クリアまたは最近接有効値への修正
  - **エラーメッセージの内容**: 具体的な数値範囲と整数制約の明示
  - **システムの安全性**: API呼び出し時のエラー防止
- **テストの目的**: 数値入力検証の厳密性確認
  - **品質保証の観点**: 外部API制約の確実な遵守
- 🟡 **黄信号**: NovelAI API仕様から妥当な推測

## 3. 境界値テストケース（最小値、最大値、null等）

### TC-003-001: imageCount境界値テスト（1, 100）
- **テスト名**: 生成枚数の最小値・最大値境界テスト
  - **境界値の意味**: システムが処理可能な最小・最大枚数での動作確認
  - **境界値での動作保証**: 1枚時と100枚時の処理安定性確保
- **入力値**: imageCount = 1, 100
  - **境界値選択の根拠**: REQ-005で規定された範囲の端点値
  - **実際の使用場面**: 1枚は単体テスト用、100枚は大量生成時の上限
- **期待される結果**:
  - 両方とも正常にバリデーション通過
  - UIの表示・保存・復元が正確に動作
  - **境界での正確性**: エラーなく処理され、期待値通りに保存
  - **一貫した動作**: 中間値と同じ処理フローで実行
- **テストの目的**: 境界値での処理安定性確認
  - **堅牢性の確認**: 極端な設定値でのシステム動作保証
- 🟢 **青信号**: 要件定義の範囲制約から確定

### TC-003-002: retrySettings境界値テスト
- **テスト名**: リトライ設定の各パラメータ境界値テスト
  - **境界値の意味**: 指数バックオフアルゴリズムの有効範囲での動作確認
  - **境界値での動作保証**: 最小・最大設定での安定したリトライ動作
- **入力値**:
  ```typescript
  // 最小値
  { maxRetries: 1, baseDelay: 100, factor: 1.1 }
  // 最大値
  { maxRetries: 10, baseDelay: 5000, factor: 3.0 }
  ```
  - **境界値選択の根拠**: アーキテクチャ制約とパフォーマンス要件から
  - **実際の使用場面**: 最小は高速処理優先、最大は堅牢性重視の場面
- **期待される結果**:
  - 全て正常にバリデーション通過
  - 数学的に妥当な指数バックオフ計算
  - **境界での正確性**: 極値での計算オーバーフローやアンダーフロー回避
  - **一貫した動作**: 境界内外での判定が明確
- **テストの目的**: リトライ機能の数学的正確性確認
  - **堅牢性の確認**: 極端な設定での安定動作と性能保証
- 🟢 **青信号**: 既存リトライエンジン実装から確定

### TC-003-003: filenameTemplate長さ境界テスト（1文字、255文字）
- **テスト名**: ファイル名テンプレート長さ境界値テスト
  - **境界値の意味**: ファイルシステムの制約内での有効性確認
  - **境界値での動作保証**: 極端に短い・長いテンプレートでの安全性
- **入力値**:
  - 最小: "a" (1文字)
  - 最大: "a".repeat(255) (255文字)
  - **境界値選択の根拠**: 一般的なファイルシステムのパス長制限
  - **実際の使用場面**: 最小は簡素化重視、最大は詳細情報記録時
- **期待される結果**:
  - 両方ともバリデーション通過
  - 実際のファイル名生成時に問題なく展開
  - **境界での正確性**: テンプレート展開後のファイル名が有効
  - **一貫した動作**: 長さ制限の判定が正確
- **テストの目的**: ファイル名生成の境界条件確認
  - **堅牢性の確認**: ファイルシステム制約の確実な遵守
- 🟡 **黄信号**: ファイルシステム制約から妥当な推測

### TC-003-004: null/undefined値の処理
- **テスト名**: null・undefined・空文字列の堅牢な処理
  - **境界値の意味**: JavaScript環境での予期しない値に対する防御
  - **境界値での動作保証**: 異常値入力時の安全なフォールバック
- **入力値**:
  ```typescript
  {
    imageCount: null,
    seedMode: undefined,
    filenameTemplate: "",
    retrySettings: null
  }
  ```
  - **境界値選択の根拠**: JavaScript特有の「値なし」状態の代表例
  - **実際の使用場面**: API通信エラー、データ破損、不正操作時
- **期待される結果**:
  - デフォルト値への安全なフォールバック
  - エラーログの記録とユーザー通知
  - **境界での正確性**: 部分的null値でも全体が破綻しない
  - **一貫した動作**: 予期しない値での挙動が予測可能
- **テストの目的**: 異常値に対する堅牢性確認
  - **堅牢性の確認**: JavaScript特有の問題に対する完全な防御
- 🟢 **青信号**: 既存ストレージ実装の防御的プログラミングパターンから確定

## テストケース実装時の日本語コメント指針

### テストケース開始時のコメント
```typescript
// 【テスト目的】: [このテストで何を確認するかを日本語で明記]
// 【テスト内容】: [具体的にどのような処理をテストするかを説明]
// 【期待される動作】: [正常に動作した場合の結果を説明]
// 🟢🟡🔴 この内容の信頼性レベルを記載
```

### Given（準備フェーズ）のコメント
```typescript
// 【テストデータ準備】: [なぜこのデータを用意するかの理由]
// 【初期条件設定】: [テスト実行前の状態を説明]
// 【前提条件確認】: [テスト実行に必要な前提条件を明記]
```

### When（実行フェーズ）のコメント
```typescript
// 【実際の処理実行】: [どの機能/メソッドを呼び出すかを説明]
// 【処理内容】: [実行される処理の内容を日本語で説明]
// 【実行タイミング】: [なぜこのタイミングで実行するかを説明]
```

### Then（検証フェーズ）のコメント
```typescript
// 【結果検証】: [何を検証するかを具体的に説明]
// 【期待値確認】: [期待される結果とその理由を説明]
// 【品質保証】: [この検証がシステム品質にどう貢献するかを説明]
```

### 各expectステートメントのコメント
```typescript
// 【検証項目】: [この検証で確認している具体的な項目]
// 🟢🟡🔴 この内容の信頼性レベルを記載
expect(result.success).toBe(true); // 【確認内容】: 設定保存が成功したことを確認
expect(mockStorage.set).toHaveBeenCalledWith(expectedData); // 【確認内容】: 適切なデータでストレージが呼ばれたことを確認
```

## 品質判定

✅ **高品質**:
- テストケース分類: 正常系・異常系・境界値が網羅されている（11ケース定義済み）
- 期待値定義: 各テストケースの期待値が明確（TypeScript型定義付き）
- 技術選択: プログラミング言語・テストフレームワークが確定（TypeScript + Vitest）
- 実装可能性: 現在の技術スタックで実現可能（既存パターンと整合）

**次のお勧めステップ**: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。