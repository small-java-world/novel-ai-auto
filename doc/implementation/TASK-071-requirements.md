# TDD要件定義 - TASK-071: オフライン/復帰ハンドリング

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

🟢 **信頼性レベル**: EARS要件定義書・設計文書を参考にして構成

### 何をする機能か（ユーザストーリーから抽出）
- ネットワーク接続の状態変化（offline/online）を監視し、オフライン時には進行中のジョブを一時停止し、オンライン復帰時に自動的にジョブを再開する機能

### どのような問題を解決するか（As a / So that から抽出）
- **問題**: ネットワーク不安定やオフライン状態により、長時間の画像生成処理が中断され、ユーザーが手動で再開する必要がある
- **解決**: ネットワーク状態の自動監視により、接続復旧後の自動再開を提供し、ユーザーの介入なしに処理を継続

### 想定されるユーザー（As a から抽出）
- 作業効率を重視するNovelAIユーザー（不安定なネットワーク環境下でも継続的な画像生成を必要とする）

### システム内での位置づけ（アーキテクチャ設計から抽出）
- **コンポーネント**: Service Worker（イベント監視・ジョブ制御）+ Content Script（DOM状態監視）
- **通信**: Message Passing でネットワーク状態変化を各コンポーネント間で通知
- **データフロー**: ネットワーク監視 → 状態変化検出 → ジョブ一時停止/再開 → プログレス通知

**参照したEARS要件**: EDGE-002
**参照した設計文書**: architecture.md（アーキテクチャパターン：MV3 Event-driven Extension + Message Passing）

## 2. 入力・出力の仕様（EARS機能要件・TypeScript型定義ベース）

🟢 **信頼性レベル**: 既存のMessage interfaces・dataflow.mdに基づく

### 入力パラメータ
- **ネットワークイベント**: `navigator.onLine`、`online`/`offline`イベント
- **現在のジョブ状態**: `GenerationJob.status = 'running'` 状態のジョブ
- **RetryEngine設定**: 既存のTASK-032リトライ設定（指数バックオフ）

### 出力値
- **ネットワーク状態変化メッセージ**:
  ```typescript
  interface NetworkStateMessage extends Message {
    type: 'NETWORK_STATE_CHANGED';
    isOnline: boolean;
    timestamp: number;
    affectedJobs?: string[];
  }
  ```
- **ジョブ一時停止メッセージ**:
  ```typescript
  interface JobPausedMessage extends Message {
    type: 'JOB_PAUSED';
    jobId: string;
    reason: 'network_offline';
    pausedAt: number;
  }
  ```
- **ジョブ再開メッセージ**:
  ```typescript
  interface JobResumedMessage extends Message {
    type: 'JOB_RESUMED';
    jobId: string;
    reason: 'network_restored';
    resumedAt: number;
  }
  ```

### 入出力の関係性
- オフライン検出 → 実行中ジョブ一時停止 → 状態保存
- オンライン復帰検出 → 一時停止ジョブ復元 → 再開実行

**参照したEARS要件**: REQ-006（メッセージ受信機能）
**参照した設計文書**: types.ts（Message interfaces）、dataflow.md（データ処理フロー）

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

🟡 **信頼性レベル**: アーキテクチャ設計から妥当な推測

### パフォーマンス要件
- **監視周期**: `navigator.onLine`ポーリングは最大1秒間隔、イベントベース検出を優先
- **フラッピング対策**: 5秒以内の連続状態変化は無視し、安定した状態変化のみ処理

### セキュリティ要件
- **権限制限**: 既存権限（`activeTab`, `scripting`）内で実装、追加権限不要
- **データ保護**: ネットワーク状態情報のみ監視、通信内容は監視しない

### 互換性要件
- **Browser API**: `navigator.onLine`、`window.addEventListener('online/offline')`使用
- **Chrome API**: Manifest V3制約下での`chrome.storage`と既存メッセージング活用

### アーキテクチャ制約
- **既存コンポーネント活用**: TASK-031メッセージルータ、TASK-032リトライエンジンを基盤とする
- **レジリエンス**: 既存の指数バックオフ機能と統合し、ネットワーク復旧時の段階的再開

**参照したEARS要件**: NFR-001（パフォーマンス要件）、REQ-403（権限最小化）
**参照した設計文書**: architecture.md（権限制約、メッセージ駆動アーキテクチャ）

## 4. 想定される使用例（EARSEdgeケース・データフローベース）

🟢 **信頼性レベル**: EDGE-002から具体的な要件を抽出

### 基本的な使用パターン
1. **WiFi切断**: ユーザーのWiFi接続が一時的に切断され、自動復旧する
2. **モバイル接続切り替え**: WiFiからモバイルデータへの切り替え時の一時的断線
3. **ネットワーク メンテナンス**: ISPのメンテナンスによる計画的なネットワーク断線

### エッジケース
1. **フラッピング防止**:
   - 短時間内での連続オン/オフ状態変化を真の状態変化と誤判定しない
   - 最低5秒間安定した状態が続く場合のみ状態変化として認識
2. **同時復旧制御**:
   - 複数ジョブが一時停止中の場合、段階的再開で負荷分散
   - 一度に全ジョブを再開せず、RetryEngineの遅延を活用
3. **偽オンライン対応**:
   - `navigator.onLine=true`でも実際にはネットワーク到達不可の場合への対処

### エラーケース
1. **状態検出失敗**: ネットワーク状態の判定が不可能な場合は既定値（オンライン）とみなす
2. **一時停止失敗**: ジョブ一時停止に失敗した場合はエラーログを記録し、強制停止を実行
3. **再開失敗**: ネットワーク復旧後のジョブ再開に失敗した場合は既存リトライ機構に委譲

**参照したEARS要件**: EDGE-002（ネットワーク不安定時の待機・復帰後再開）
**参照した設計文書**: dataflow.md（失敗時リトライフロー）

## 5. EARS要件・設計文書との対応関係

### 参照したユーザストーリー
- ストーリー3: 進捗と異常時の再試行（ネットワーク断線を異常事態として扱い、復旧後の自動再開で対応）

### 参照した機能要件
- **REQ-006**: システムはメッセージ受信機能を提供しなければならない（ネットワーク状態変化の通知）

### 参照した非機能要件
- **NFR-001**: パフォーマンス要件（監視オーバーヘッドの最小化）
- **REQ-403**: 最小権限での実装（追加権限なしでの機能提供）

### 参照したEdgeケース
- **EDGE-002**: ネットワーク不安定時（オフライン/復帰）時は待機し復帰後に再開する

### 参照した受け入れ基準
- オフライン→オンラインの再開が安定
- ネットワーク断続（フラッピング）時の抑制/バックオフ

### 参照した設計文書
- **アーキテクチャ**: architecture.md（MV3 Event-driven Extension パターン）
- **データフロー**: dataflow.md（失敗時リトライフロー）
- **型定義**: types.ts（Message interfaces）、shared/messages.ts（MESSAGE_TYPES）
- **API仕様**: api-endpoints.md（既存メッセージ仕様）
- **依存コンポーネント**: messagingRouter.ts（メッセージ配信）、retry-engine.ts（指数バックオフ）

## 品質判定

✅ **高品質**:
- 要件の曖昧さ: なし（EARS要件EDGE-002から明確に定義）
- 入出力定義: 完全（既存TypeScript型定義に基づく新しいMessage型定義）
- 制約条件: 明確（既存アーキテクチャ制約内での実装方針）
- 実装可能性: 確実（既存のTASK-031、TASK-032の成果物を基盤として活用）

次のお勧めステップ: `/tdd-testcases` でテストケースの洗い出しを行います。