# TASK-081: E2Eテスト テストケース定義

## 正常系テストケース

- 🟢 **テスト名**: 拡張機能の起動と既定状態確認
  - **何をテストするか**: Playwright で拡張機能を読み込み、バックグラウンド/ポップアップが起動することを検証する
  - **期待される動作**: Chrome 拡張が有効化され、バックグラウンドログとポップアップの既定 UI 要素が描画される
- **入力値**: chromium.launchPersistentContext() に Manifest V3 拡張を登録
  - **入力データの意味**: REQ-081-001 で要求される拡張の読み込みパスを再現
- **期待される結果**: バックグラウンドログ NovelAI Auto Generator Service Worker loaded が取得でき、ポップアップ内に主要要素（生成ボタン等）が存在
  - **期待結果の理由**: 拡張が正常起動すればログと UI が揃うため
- **テストの目的**: 拡張初期化の成功と基本 UI の存在確認
  - **確認ポイント**: サービスワーカー登録 / ポップアップ DOM の描画
- 🟢 **信頼性レベル**: REQ-081-001, architecture メモ参照

- 🟢 **テスト名**: NovelAI ダッシュボードへの遷移とログイン判定
  - **何をテストするか**: 自動で NovelAI ページに移動し、ログイン状態（既ログイン or ログイン要求）を検出できるか
  - **期待される動作**: ログイン済みであればダッシュボード要素が表示、未ログインならログインフォームが表示される
- **入力値**: context.newPage() で https://novelai.net/ をオープン
  - **入力データの意味**: REQ-081-002 のアクセス要件、EDGE-081-002 の失敗検出に備えた標準フロー
- **期待される結果**: 期待する DOM セレクタ（ログインフォーム または ログイン済みプロンプト入力）が取得可能
  - **期待結果の理由**: NovelAI UI の公式 DOM 構造に基づく
- **テストの目的**: ページ遷移とログイン状態検出の確認
  - **確認ポイント**: ページロード完了の待機・セレクタ判定ロジック
- 🟡 **信頼性レベル**: REQ-081-002（UI 構造の一部は妥当推測）

- 🟢 **テスト名**: ポップアップからの生成パラメータ設定と送信
  - **何をテストするか**: ポップアップ UI 操作でプロンプト・枚数・シード設定をし、生成実行コマンドを送出する
  - **期待される動作**: 設定値が保存され、生成ボタン押下でコンテンツスクリプトへメッセージが飛ぶ
- **入力値**: プロンプト「Sunset over mountain」、枚数 3, シード 123456
  - **入力データの意味**: REQ-081-003 に基づく代表例で EDGE-081-101（設定多様化）にも備える
- **期待される結果**: storage API に設定が保存され、START_GENERATION メッセージが送信される
  - **期待結果の理由**: 設定操作→メッセージ送信が正常フロー
- **テストの目的**: UI 操作から生成命令が正しく伝播するか確認
  - **確認ポイント**: ストレージ更新、runtime message 内容
- 🟢 **信頼性レベル**: REQ-081-003, dataflow.md のメッセージ図参照

- 🟢 **テスト名**: 画像生成フローの完走
  - **何をテストするか**: 生成開始から NovelAI での完了通知取得、ポップアップ進捗更新まで
  - **期待される動作**: 生成ステータスが completed となり、完了トーストが表示される
- **入力値**: プロンプト Test prompt, 枚数 1
  - **入力データの意味**: REQ-081-004 の最短成功シナリオ
- **期待される結果**: 進捗 UI が100%になり、完了メッセージが表示される
  - **期待結果の理由**: 成功時の標準挙動
- **テストの目的**: 生成プロセスの成功パス検証
  - **確認ポイント**: 進捗 DOM 更新、ログ出力
- 🟢 **信頼性レベル**: REQ-081-004, progress display 設計資料

- 🟢 **テスト名**: 生成画像のダウンロード完了検証
  - **何をテストするか**: ダウンロード要求とファイル存在確認、命名規則検証
  - **期待される動作**: 指定ディレクトリに画像が保存され命名テンプレートに一致
- **入力値**: プロンプト Galaxy, outputDir downloads/
  - **入力データの意味**: REQ-081-005 で要求される保存ディレクトリ
- **期待される結果**: downloads/ に YYYYMMDD_* 命名のファイルが存在
  - **期待結果の理由**: ファイル名テンプレート仕様
- **テストの目的**: ダウンロード完了と命名ルールの整合性確認
  - **確認ポイント**: ダウンロード完了待機とファイル検出
- 🟢 **信頼性レベル**: REQ-081-005, fileNameTemplate 設計

## 異常系テストケース

- 🟢 **テスト名**: 拡張読み込み失敗時のエラー通知
  - **エラーケースの概要**: プレイライト起動時に拡張ディレクトリが欠落
  - **エラー処理の重要性**: REQ-081-101 を満たし、テスト実行者へ明確な失敗要因を返す
- **入力値**: 存在しないパスを --disable-extensions-except に指定
  - **不正な理由**: 拡張フォルダ欠落
  - **実際の発生シナリオ**: CI 設定ミス
- **期待される結果**: Playwright ログにエラーが残り、テストはスキップ／失敗として扱う
  - **エラーメッセージの内容**: Extension load error が含まれる
  - **システムの安全性**: 以後のテストを中断
- **テストの目的**: 初期化失敗時の明示的な失敗通知
  - **品質保証の観点**: CI での早期検知
- 🟢 **信頼性レベル**: REQ-081-101, Playwright ドキュメント

- 🟡 **テスト名**: NovelAI サイト応答遅延時のリトライ処理
  - **エラーケースの概要**: ページロードがタイムアウト
  - **エラー処理の重要性**: REQ-081-102 のリトライ要件
- **入力値**: ネットワーク条件を 3G 遅延に設定
  - **不正な理由**: ロード時間超過
  - **実際の発生シナリオ**: ネットワーク障害
- **期待される結果**: 既定回数リトライ後に詳細ログを残し失敗
  - **エラーメッセージの内容**: page.goto timeout とリトライ回数
  - **システムの安全性**: 状態を元に戻す
- **テストの目的**: タイムアウト処理の確認
  - **品質保証の観点**: 外部依存に対する耐性
- 🟡 **信頼性レベル**: REQ-081-102（リトライ戦略は合理的推測）

- 🟡 **テスト名**: 画像生成タイムアウト時の警告
  - **エラーケースの概要**: 一定時間内に生成完了しない
  - **エラー処理の重要性**: REQ-081-103（タイムアウト監視）
- **入力値**: waitForResponse に長時間応答しないモック
  - **不正な理由**: タイムアウト
  - **実際の発生シナリオ**: NovelAI サーバ混雑
- **期待される結果**: 警告トーストとログ、後続処理の停止
  - **エラーメッセージの内容**: generation timeout
  - **システムの安全性**: タスクをキャンセル
- **テストの目的**: タイムアウト時のユーザー通知
  - **品質保証の観点**: 長時間ハング防止
- 🟡 **信頼性レベル**: REQ-081-103（通知文言は推測）

- 🟢 **テスト名**: ダウンロード失敗時の再試行
  - **エラーケースの概要**: ダウンロード API が失敗／アクセス拒否
  - **エラー処理の重要性**: REQ-081-104
- **入力値**: chrome.downloads.download をエラーにモック
  - **不正な理由**: API 失敗
  - **実際の発生シナリオ**: ストレージ不足
- **期待される結果**: 最大 N 回リトライし、失敗ログを出力
  - **エラーメッセージの内容**: download failed
  - **システムの安全性**: 部分的成功を記録
- **テストの目的**: ダウンロード失敗時の挙動確認
  - **品質保証の観点**: データ喪失防止
- 🟢 **信頼性レベル**: REQ-081-104, download-handler 実装仕様

## 境界値テストケース

- 🟢 **テスト名**: 最小生成回数 (1枚) の安定動作
  - **境界値の意味**: 最少枚数でフローが成立するか
  - **境界値での動作保証**: 1 枚でも全工程が完了
- **入力値**: 枚数 1
  - **選択根拠**: REQ-081-004 最少値
  - **実際の使用場面**: 単枚生成が多い
- **期待される結果**: 生成成功、ファイル 1 枚のみ保存
  - **正確性**: カウントズレ無
  - **一貫した動作**: 基本テストと同じ
- **テストの目的**: 最小ケースの堅牢性
  - **堅牢性**: 過剰処理が発生しない
- 🟢 **信頼性レベル**: REQ-081-004

- 🟡 **テスト名**: 最大生成回数 (10枚) の性能検証
  - **境界値の意味**: パフォーマンステスト要件
  - **境界値での動作保証**: 10 枚生成が 5 分以内
- **入力値**: 枚数 10
  - **選択根拠**: NFR-081-001〜003, REQ-081-005
  - **実使用**: バッチ生成
- **期待される結果**: 5 分以内に全画像がダウンロード
  - **正確性**: 計測ログにパス
  - **一貫性**: 再実行でも維持
- **テストの目的**: 最大負荷でのパフォーマンス確認
  - **堅牢性**: メモリ 2GB 以下の確認
- 🟡 **信頼性レベル**: NFR-081-001〜003（実測値は測定が必要）

- 🟡 **テスト名**: メモリ使用量 2GB 付近での安定度
  - **境界値の意味**: 上限近くの動作
  - **保証**: 2GB に近い状況でも落ちない
- **入力値**: 高解像度生成設定（768x1344 など）
  - **選択根拠**: メモリ負荷最大
  - **使用場面**: 高画質生成
- **期待結果**: メモリ監視が 2GB 以下、アプリ継続
  - **正確性**: 計測ログ
  - **一貫性**: テスト反復でも持続
- **テスト目的**: メモリ境界での堅牢性
  - **堅牢性**: クラッシュ防止
- 🟡 **信頼性レベル**: NFR-081-003（測定手法は推測）

## プログラミング言語・テストフレームワーク

- **プログラミング言語**: TypeScript
  - **言語選択の理由**: 既存拡張が TypeScript 製で型安全なテストが書ける
  - **テストに適した機能**: 型補完・ESM サポート
  - 🟢 **信頼性レベル**: 既存リポジトリ構成
- **テストフレームワーク**: Playwright Test
  - **フレームワーク選択の理由**: E2E/UI 自動化に最適、拡張やネットワーク制御 API が豊富
  - **テスト実行環境**: Node.js 18 / Playwright 1.40 / Chromium チャネル
  - 🟢 **信頼性レベル**: REQ-081-401、package.json devDependencies

## テスト実装コメント指針

テスト実装では以下のコメントテンプレートを各フェーズで付与する。

`	s
// 【テスト目的】: [確認事項]
// 【テスト内容】: [処理概要]
// 【期待される動作】: [正常結果]
// 🟢🟡🔴 信頼性レベル
`

Given/When/Then、expect、beforeEach/afterEach コメントも指示通り付与する。

## 品質判定

- 分類網羅: 正常系5 / 異常系4 / 境界値3 → ✅
- 期待値: 各テストで具体的に記述 → ✅
- 技術選択: TypeScript & Playwright Test → ✅
- 実装可能性: 既存スタックと一致 → ✅

**判定**: ✅ 高品質

## 次のステップ

次のお勧めステップ: /tdd-red TASK-081 でRedフェーズ（失敗テスト作成）を開始します。
