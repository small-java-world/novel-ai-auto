# TDD要件定義・機能仕様の整理

TDD開発を開始します。以下の機能について要件を整理しました：

**【機能名】**: TASK-043 進捗/残枚数/ETA/ログ表示 + キャンセル

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

- 🟢 **機能の目的**: NovelAI Auto Generatorのポップアップ画面で、画像生成の進捗状況をリアルタイム表示し、ユーザーがいつでも処理をキャンセルできる機能
- 🟢 **解決する問題**: 長時間実行される複数枚画像生成において、現在の進捗が不明で不安になる問題と、途中で処理を停止できない問題を解決
- 🟢 **想定ユーザー**: NovelAIで複数枚画像生成を行うユーザー（EARS要件定義書のユーザーストーリー3参照）
- 🟢 **システム内での位置づけ**: Popup UIコンポーネントの中核機能として、Service WorkerからのPROGRESS_UPDATEメッセージを受信し、リアルタイム表示とキャンセル制御を担う
- **参照したEARS要件**: REQ-003, NFR-201, NFR-202
- **参照した設計文書**: architecture.md のメッセージ駆動アーキテクチャ、Popup UI設計

## 2. 入力・出力の仕様（EARS機能要件・TypeScript型定義ベース）

### 入力パラメータ
- 🟢 **PROGRESS_UPDATEメッセージ**: Service Workerから500ms周期で受信するメッセージ
  ```typescript
  {
    type: 'PROGRESS_UPDATE',
    currentIndex: number,     // 現在処理中のインデックス（0ベース）
    totalCount: number,       // 総生成枚数
    status: 'waiting' | 'generating' | 'downloading' | 'completed' | 'error' | 'cancelled',
    eta?: number,            // 推定残り時間（秒）
    error?: string,          // エラーメッセージ
    timestamp: number        // タイムスタンプ
  }
  ```
- 🟢 **ユーザーキャンセル操作**: キャンセルボタンのクリックイベント
- 🟢 **ログエントリ**: 直近の処理ログ（成功・失敗・警告）

### 出力値
- 🟢 **UI表示更新**:
  - 進捗バー（現在位置/総数）
  - 残枚数表示
  - ETA（推定完了時間）
  - 現在の状態（待機中・生成中・ダウンロード中・完了・エラー・キャンセル済み）
  - 直近ログエントリ（最大5件）
- 🟢 **CANCEL_JOBメッセージ**: ユーザーキャンセル時にService Workerへ送信
  ```typescript
  {
    type: 'CANCEL_JOB',
    jobId: string,
    reason: 'user_requested'
  }
  ```

### 入出力の関係性
- 🟢 PROGRESS_UPDATEメッセージ受信 → UI状態更新 → 画面描画
- 🟢 ユーザーキャンセル操作 → CANCEL_JOBメッセージ送信 → UI状態を「キャンセル中」に変更

**参照したEARS要件**: REQ-003, REQ-006 (メッセージ通信), NFR-002 (500ms周期)
**参照した設計文書**: src/utils/messaging-router.ts のメッセージ型定義, src/popup/ui-state-manager.ts の状態管理

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

### パフォーマンス要件
- 🟢 **応答性**: PROGRESS_UPDATEメッセージ受信から画面更新まで100ms以内（NFR-002準拠）
- 🟢 **更新周期**: 500ms周期での進捗更新に追従し、UI描画の遅延を発生させない
- 🟢 **キャンセル応答**: キャンセルボタン押下から処理停止まで1秒以内

### セキュリティ要件
- 🟢 **XSS対策**: ログメッセージ・エラーメッセージのHTMLエスケープ処理
- 🟢 **メッセージ検証**: 受信したPROGRESS_UPDATEメッセージの形式検証

### 互換性要件
- 🟢 **Chrome拡張制約**: Manifest V3環境でのメッセージパッシング制約
- 🟢 **DOM操作**: 既存popup.htmlの構造を活用し、進捗表示エリアを追加

### アーキテクチャ制約
- 🟢 **指数バックオフ**: リトライエンジン（TASK-032）との連携
- 🟢 **ジョブキュー管理**: ジョブキューマネージャー（TASK-034）との連携
- 🟢 **メッセージルーティング**: メッセージルーター（TASK-031）との連携

### アクセシビリティ制約
- 🟢 **キーボード操作**: キャンセルボタンのキーボードアクセス（Enter/Space）
- 🟢 **スクリーンリーダー**: 進捗変更時のaria-live通知
- 🟢 **視覚表示**: 高コントラスト表示（NFR-203準拠）

**参照したEARS要件**: NFR-001 (30秒以内), NFR-002 (500ms周期), NFR-201 (明確な表示), NFR-202 (キャンセル機能), NFR-203 (アクセシビリティ)
**参照した設計文書**: architecture.md の主要設計決定（メッセージ駆動、アクセシビリティ）

## 4. 想定される使用例（EARSEdgeケース・データフローベース）

### 基本的な使用パターン
- 🟢 **正常フロー**: 生成開始 → 進捗表示更新（500ms周期） → 完了表示
- 🟢 **キャンセルフロー**: 生成中 → キャンセルボタン押下 → 処理停止 → キャンセル完了表示
- 🟢 **エラー回復フロー**: エラー発生 → エラー表示 → リトライ実行 → 進捗再開

### エッジケース
- 🟡 **メッセージ断絶**: PROGRESS_UPDATEメッセージが5秒以上来ない場合の「通信中断」表示
- 🟡 **高速完了**: 生成時間が1秒未満の場合でも進捗表示が適切に動作
- 🟢 **キャンセル競合**: キャンセル処理中に完了した場合の状態整合性確保
- 🟡 **ブラウザ最小化**: ポップアップが非表示の間も進捗状態を保持

### エラーケース
- 🟡 **Service Worker停止**: バックグラウンド処理停止時の状態検出とエラー表示
- 🟡 **メッセージ形式不正**: 不正なPROGRESS_UPDATEメッセージ受信時のフォールバック表示
- 🟢 **ダブルキャンセル**: キャンセルボタン連続押下時の重複処理防止

**参照したEARS要件**: EDGE-001 (DOM操作失敗), EDGE-002 (ネットワーク不安定), REQ-006 (メッセージ通信エラー)
**参照した設計文書**: src/utils/retry-engine.ts のリトライロジック, src/utils/job-queue-manager.ts のキャンセル制御

## 5. EARS要件・設計文書との対応関係

### 参照したユーザストーリー
- **ユーザーストーリー3**: 進捗と異常時の再試行（As a 作業効率を重視するユーザー, I want 進捗表示・キャンセル・異常時の自動再試行, So that 長い待ち時間や不測な異常に適切に対処できる）

### 参照した機能要件
- **REQ-003**: システムは生成進捗（待機・実行・完了・異常）をポップアップに表示しなければならない
- **REQ-006**: システムはコンテントスクリプト、ポップアップ、Service Worker間でメッセージを適切に通信しなければならない

### 参照した非機能要件
- **NFR-001**: 各種設定から単一画像生成・ダウンロード完了まで30秒以内（標準的性能）とする
- **NFR-002**: 進捗表示・ログ更新は500ms以内の周期でユーザに反映する
- **NFR-201**: 進捗・残枚数・推定完了時間・直近のエラーを明確に表示する
- **NFR-202**: 生成処理をユーザがいつでもキャンセルできる
- **NFR-203**: 主要UIはキーボード操作に対応し、視認性の高いコントラストで提供する

### 参照したEdgeケース
- **EDGE-001**: DOM操作失敗/タイムアウト時の処理継続・ユーザー通知・設定に応じてリトライ
- **EDGE-002**: ネットワーク不安定（オフライン/接続断続）時の待機し接続後に再試行

### 参照した設計文書
- **アーキテクチャ**: docs/design/novelai-auto-generator/architecture.md のメッセージ駆動パターン
- **メッセージルーティング**: src/utils/messaging-router.ts のPROGRESS_UPDATE/CANCEL_JOBハンドラ
- **ジョブ管理**: src/utils/job-queue-manager.ts のキャンセル制御とステート管理
- **リトライエンジン**: src/utils/retry-engine.ts の指数バックオフ制御
- **UI状態管理**: src/popup/ui-state-manager.ts の状態同期パターン

## 品質判定

✅ **高品質**:
- 要件の曖昧さ: なし（EARS要件REQ-003, NFR-201, NFR-202に基づく明確な仕様）
- 入出力定義: 完全（既存TypeScript型定義と依存タスクの実装を活用）
- 制約条件: 明確（パフォーマンス・セキュリティ・アクセシビリティ・アーキテクチャ制約すべて定義済み）
- 実装可能性: 確実（依存タスクTASK-031/032/034が完了し、基盤コンポーネントが利用可能）

## 次のステップ

**次のお勧めステップ**: `/tdd-testcases` でテストケースの洗い出しを行います。