# TDDテストケース洗い出し: TASK-034 ジョブキュー/キャンセル制御

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript
  - **言語選択の理由**: 既存プロジェクトがTypeScriptベースであり、Chrome Extension API の型安全性が重要
  - **テストに適した機能**: 型推論によるテストデータの整合性確保、モック作成の簡易化
- **テストフレームワーク**: Vitest
  - **フレームワーク選択の理由**: 既存プロジェクトで採用済み、Chrome API モックとの相性が良い
  - **テスト実行環境**: Node.js 環境でのChrome Extension API モック使用
- 🟢 信頼性レベル: 既存のpackage.jsonとテストファイル構成に基づく

## 1. 正常系テストケース（基本的な動作）

### TC-001: 単枚生成ジョブの正常実行
- **テスト名**: 単枚生成（imageCount=1）で正常にジョブが完了する
  - **何をテストするか**: 最もシンプルなケースでのジョブライフサイクル管理
  - **期待される動作**: pending → running → completed の状態遷移が正しく実行される
- **入力値**: `GenerationJob { imageCount: 1, status: 'pending' }`
  - **入力データの意味**: 最小限の生成タスクを表現、基本動作の確認に適切
- **期待される結果**: ジョブステータスが'completed'、進捗が{current: 1, total: 1}
  - **期待結果の理由**: 単枚生成は最も基本的な成功パターンのため
- **テストの目的**: ジョブ管理の基本機能動作確認
  - **確認ポイント**: 状態遷移の正確性、進捗計算の正しさ
- 🟢 信頼性レベル: REQ-103の基本要件に基づく

### TC-002: 複数枚生成ジョブの順次実行
- **テスト名**: 複数枚生成（imageCount=3）で順次実行される
  - **何をテストするか**: 指定枚数分のループ制御と進捗管理機能
  - **期待される動作**: 3回の生成サイクルが順次実行され、各回で進捗が更新される
- **入力値**: `GenerationJob { imageCount: 3, status: 'pending' }`
  - **入力データの意味**: 複数枚生成の代表的なケース、実用的な使用パターン
- **期待される結果**: 進捗が{current: 0→1→2→3, total: 3}で更新、最終的に'completed'
  - **期待結果の理由**: REQ-103の複数枚繰り返し要件を満たすため
- **テストの目的**: ループ制御と進捗管理の確認
  - **確認ポイント**: 各回の Content Script 呼び出し、進捗の連続性
- 🟢 信頼性レベル: REQ-103の複数枚生成要件に基づく

### TC-003: 進捗更新メッセージの正常な処理
- **テスト名**: Content Scriptからの進捗更新が正しくUIに反映される
  - **何をテストするか**: ProgressUpdateMessage の受信と転送機能
  - **期待される動作**: 受信した進捗がそのままPopup等に転送される
- **入力値**: `ProgressUpdateMessage { current: 2, total: 5, status: 'generating' }`
  - **入力データの意味**: 実行中ジョブの中間進捗を表現
- **期待される結果**: runtime.sendMessage で同じ内容が転送される
  - **期待結果の理由**: UI反映のための橋渡し機能のため
- **テストの目的**: 進捗ブロードキャスト機能の確認
  - **確認ポイント**: メッセージの改変なし転送、受信者エラーの無視
- 🟢 信頼性レベル: 既存messagingRouter.tsの実装パターンに基づく

## 2. 異常系テストケース（エラーハンドリング）

### TC-004: 実行中ジョブのキャンセル処理
- **テスト名**: 実行中のジョブをキャンセルして即座に停止する
  - **エラーケースの概要**: ユーザーが生成途中でキャンセルを要求する状況
  - **エラー処理の重要性**: NFR-202（キャンセル即時性）の実現に不可欠
- **入力値**: `CancelJobMessage { jobId: 'active-job-id' }`、実行中ジョブ状態
  - **不正な理由**: 正常な処理の中断を意図的に要求するため
  - **実際の発生シナリオ**: ユーザーが長時間の複数枚生成を途中で停止したい場合
- **期待される結果**: ジョブステータスが'cancelled'、残り処理のスキップ
  - **エラーメッセージの内容**: キャンセル完了通知がUIに送信される
  - **システムの安全性**: 中断時にリソースが適切に解放される
- **テストの目的**: キャンセル機能の即時性確認
  - **品質保証の観点**: ユーザビリティとリソース管理の両立
- 🟢 信頼性レベル: NFR-202要件と既存CANCEL_JOB実装に基づく

### TC-005: 不正なジョブIDでのキャンセル要求
- **テスト名**: 存在しないジョブIDに対するキャンセル要求の拒否
  - **エラーケースの概要**: 無効なIDや既に完了したジョブのキャンセル要求
  - **エラー処理の重要性**: システムの整合性とエラー報告の明確化
- **入力値**: `CancelJobMessage { jobId: 'nonexistent-id' }`
  - **不正な理由**: 実際に実行中でないジョブへの操作のため
  - **実際の発生シナリオ**: UI側の状態不整合や重複操作
- **期待される結果**: ERROR メッセージでINVALID_PAYLOADまたは専用エラーコード
  - **エラーメッセージの内容**: 「指定されたジョブが見つかりません」等
  - **システムの安全性**: 不正操作による予期しない副作用を防止
- **テストの目的**: 入力検証とエラーハンドリングの確認
  - **品質保証の観点**: 堅牢性と適切なエラー報告の実現
- 🟡 信頼性レベル: 既存エラー処理パターンからの妥当な推測

### TC-006: 生成エラー時のリトライ制御
- **テスト名**: Content Scriptからの生成エラーでリトライ処理が作動する
  - **エラーケースの概要**: NovelAI側の生成失敗やネットワークエラー
  - **エラー処理の重要性**: TASK-032のリトライエンジンとの連携確認
- **入力値**: `GenerationErrorMessage { error: 'generation_failed' }`
  - **不正な理由**: 外部要因（サーバー側）による予期しない失敗
  - **実際の発生シナリオ**: NovelAIのレート制限、ネットワーク断、サーバーエラー
- **期待される結果**: 指数バックオフでのリトライ実行、上限回数後は'error'状態
  - **エラーメッセージの内容**: リトライ回数と最終的な失敗理由
  - **システムの安全性**: 無限ループ防止と適切な諦め処理
- **テストの目的**: リトライエンジンとの連携確認
  - **品質保証の観点**: 外部依存への耐性とユーザー体験の向上
- 🟡 信頼性レベル: TASK-032のリトライエンジン設計からの推測

## 3. 境界値テストケース（最小値、最大値、null等）

### TC-007: 最小枚数（imageCount=1）の処理
- **テスト名**: 最小枚数1枚での正常動作確認
  - **境界値の意味**: ループ処理の最小単位、特殊ケース扱いの可能性
  - **境界値での動作保証**: 単枚でも複数枚でも同じロジックで処理できることを確認
- **入力値**: `GenerationJob { imageCount: 1 }`
  - **境界値選択の根拠**: 生成枚数の論理的最小値
  - **実際の使用場面**: 単発生成やテスト実行時
- **期待される結果**: ループなしの直接処理、進捗{current: 0→1, total: 1}
  - **境界での正確性**: 1回のみの実行で正しく完了状態になる
  - **一貫した動作**: 複数枚生成と同じインターフェースで処理される
- **テストの目的**: 最小境界での安定動作確認
  - **堅牢性の確認**: エッジケースでの予期しない動作防止
- 🟢 信頼性レベル: REQ-103の枚数指定要件に基づく

### TC-008: 大きな枚数（imageCount=100）の処理
- **テスト名**: 大量枚数指定時のメモリ効率と中断可能性
  - **境界値の意味**: システムリソースの限界に近い使用ケース
  - **境界値での動作保証**: 大量処理でもメモリリークや応答性低下が発生しない
- **入力値**: `GenerationJob { imageCount: 100 }`
  - **境界値選択の根拠**: 実用的な大量生成の上限想定値
  - **実際の使用場面**: バッチ生成やデータセット作成
- **期待される結果**: 順次実行でメモリ使用量が一定、途中キャンセル可能
  - **境界での正確性**: 100回の処理すべてで正確な進捗管理
  - **一貫した動作**: 途中でのキャンセルが即座に反映される
- **テストの目的**: スケーラビリティとリソース管理の確認
  - **堅牢性の確認**: 大量処理でもシステムが安定動作すること
- 🟡 信頼性レベル: Chrome Extension のメモリ制限を考慮した推測

### TC-009: ゼロ枚数（imageCount=0）の異常処理
- **テスト名**: 不正な枚数0での適切なエラー処理
  - **境界値の意味**: 論理的に意味をなさない入力値
  - **境界値での動作保証**: 不正入力の適切な検出と拒否
- **入力値**: `GenerationJob { imageCount: 0 }`
  - **境界値選択の根拠**: 枚数指定の論理的下限を下回る値
  - **実際の使用場面**: UI入力ミスや設定ファイル破損
- **期待される結果**: 即座にERRORステータス、INVALID_PAYLOAD エラー
  - **境界での正確性**: 処理開始前の事前検証でエラー検出
  - **一貫した動作**: 他の不正入力と同様のエラー処理
- **テストの目的**: 入力検証の境界確認
  - **堅牢性の確認**: 不正データでのシステム破綻防止
- 🟡 信頼性レベル: 一般的な入力検証パターンからの推測

### TC-010: 同時キャンセル競合の排他制御
- **テスト名**: 同じジョブに対する複数のキャンセル要求の処理
  - **境界値の意味**: 競合状態（race condition）での動作境界
  - **境界値での動作保証**: 複数キャンセルでも一意な最終状態に収束
- **入力値**: 同じjobIdに対する複数の`CancelJobMessage`
  - **境界値選択の根拠**: 並行処理での競合発生の典型例
  - **実際の使用場面**: ユーザーの連続クリックやネットワーク遅延での重複送信
- **期待される結果**: 最初のキャンセルのみ有効、後続は無視または既にキャンセル済み通知
  - **境界での正確性**: 状態の一意性が保たれる
  - **一貫した動作**: どのタイミングでも最終的に'cancelled'状態
- **テストの目的**: 並行処理での状態一貫性確認
  - **堅牢性の確認**: race conditionでもデータ整合性が保たれる
- 🟡 信頼性レベル: 並行処理の一般的な考慮事項からの推測

## テストケース実装時の日本語コメント指針

### テストケース開始時のコメント
```javascript
// 【テスト目的】: [このテストで何を確認するかを日本語で明記]
// 【テスト内容】: [具体的にどのような処理をテストするかを説明]
// 【期待される動作】: [正常に動作した場合の結果を説明]
// 🟢🟡🔴 この内容の信頼性レベルを記載
```

### Given（準備フェーズ）のコメント
```javascript
// 【テストデータ準備】: [なぜこのデータを用意するかの理由]
// 【初期条件設定】: [テスト実行前の状態を説明]
// 【前提条件確認】: [テスト実行に必要な前提条件を明記]
```

### When（実行フェーズ）のコメント
```javascript
// 【実際の処理実行】: [どの機能/メソッドを呼び出すかを説明]
// 【処理内容】: [実行される処理の内容を日本語で説明]
// 【実行タイミング】: [なぜこのタイミングで実行するかを説明]
```

### Then（検証フェーズ）のコメント
```javascript
// 【結果検証】: [何を検証するかを具体的に説明]
// 【期待値確認】: [期待される結果とその理由を説明]
// 【品質保証】: [この検証がシステム品質にどう貢献するかを説明]
```

### 各expectステートメントのコメント
```javascript
// 【検証項目】: [この検証で確認している具体的な項目]
// 🟢🟡🔴 この内容の信頼性レベルを記載
expect(job.status).toBe('completed'); // 【確認内容】: ジョブが正常完了状態になることを確認
expect(progress.current).toBe(progress.total); // 【確認内容】: 進捗が最終状態で一致することを確認
```

## 品質判定

✅ **高品質**:
- テストケース分類: 正常系・異常系・境界値が網羅されている（10ケース）
- 期待値定義: 各テストケースの期待値が明確（状態遷移、進捗管理、エラー処理）
- 技術選択: TypeScript + Vitest（既存プロジェクトと整合）
- 実装可能性: Chrome Extension API モックによる実現可能

## 次のステップ

次のお勧めステップ: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。