# TDDテストケース洗い出し（messaging-router）

本ドキュメントは、messaging-router（Service Worker内メッセージルータ）のテストケース一覧です。直近の要件定義、既存テスト（src/messaging-router.test.ts）、型定義、設計概要に基づきます。

---

## 1. 正常系テストケース（基本的な動作）

- テスト名: START_GENERATION を CS へ橋渡し（APPLY_AND_GENERATE 送出）
  - 何をテストするか: START_GENERATION を受理し、NovelAIタブを特定して CS へ APPLY_AND_GENERATE を送る
  - 期待される動作: `chrome.tabs.query` で対象タブ取得 → `chrome.tabs.sendMessage(tabId, { type: 'APPLY_AND_GENERATE', payload:{job}})` を1回送る
- 入力値: `{ type:'START_GENERATION', payload:{ job:{ id:'uuid-1', prompt:'p', params:{ steps:28 }}}}`
  - 入力データの意味: 最小限の正当なジョブ
- 期待される結果: `tabs.sendMessage` が期待payloadで1回呼ばれる
  - 期待結果の理由: 起動トリガーの橋渡しが最初の責務
- テストの目的: 基本ルーティングの成立確認
  - 確認ポイント: 送信先タブID・メッセージshape・呼び出し回数
- 信頼性: 🟢（既存テスト/要件に一致）

- テスト名: PROGRESS_UPDATE を Popup へ即時ブロードキャスト
  - 何をテストするか: 受理した進捗をそのまま runtime で転送
  - 期待される動作: `chrome.runtime.sendMessage({ type:'PROGRESS_UPDATE', payload })` が1回呼ばれる（タイマー未使用）
- 入力値: `{ type:'PROGRESS_UPDATE', payload:{ jobId:'j1', status:'running', progress:{ current:1, total:3, etaSeconds:20 }}}`
  - 入力データの意味: 一般的な進捗イベント
- 期待される結果: runtime.sendMessage が同一payloadで1回
  - 期待結果の理由: 進捗表示の即時性を確保
- テストの目的: 低レイテンシ経路の検証
  - 確認ポイント: 呼び出し回数、payload透過、タイマー未使用
- 信頼性: 🟢

- テスト名: IMAGE_READY で DOWNLOAD_IMAGE を即時指示
  - 何をテストするか: 画像URLとファイル名を受理しDLを指示
  - 期待される動作: `chrome.runtime.sendMessage({ type:'DOWNLOAD_IMAGE', payload:{ url, fileName }})` が即時呼ばれる
- 入力値: `{ type:'IMAGE_READY', payload:{ jobId:'j1', url:'https://ex.com/a.png', index:0, fileName:'a.png' }}`
  - 入力データの意味: 正常な画像DL要求
- 期待される結果: DOWNLOAD_IMAGE 送出1回、タイマー未使用
  - 期待結果の理由: 完了検知後に速やかにDLを開始
- テストの目的: 生成完了→保存の経路成立
  - 確認ポイント: URL/ファイル名の透過性・即時性
- 信頼性: 🟢

- テスト名: OPEN_OR_FOCUS_TAB（既存タブがあればフォーカス）
  - 何をテストするか: 既存NovelAIタブがある場合、createせずupdate(active:true)
  - 期待される動作: `tabs.update(id,{active:true})` が1回、`tabs.create` は呼ばれない
- 入力値: `{ type:'OPEN_OR_FOCUS_TAB' }`、`tabs.query` が `[ { id:77, url:'https://novelai.net/generate' } ]` を返す
  - 入力データの意味: 既存タブ有りの代表
- 期待される結果: update呼び出し1回、create未呼び出し
  - 期待結果の理由: UX/リソース効率
- テストの目的: タブ制御要件の準拠
  - 確認ポイント: query結果に応じた分岐
- 信頼性: 🟡（要件/設計からの妥当推測）

- テスト名: OPEN_OR_FOCUS_TAB（タブが無ければ新規作成）
  - 何をテストするか: 既存タブが無い場合、`tabs.create` で新規作成
  - 期待される動作: `tabs.create({ url:'https://novelai.net/', active:true })` が1回
- 入力値: `{ type:'OPEN_OR_FOCUS_TAB' }`、`tabs.query` が `[]` を返す
  - 入力データの意味: 不在ケース
- 期待される結果: create呼び出し1回
  - 期待結果の理由: 初回起動の一般動作
- テストの目的: 分岐網羅
  - 確認ポイント: URL/activeの指定
- 信頼性: 🟡

- テスト名: 非常に長い prompt でも橋渡しが行われる
  - 何をテストするか: 大きなpayloadでも START_GENERATION→APPLY_AND_GENERATE が成立
  - 期待される動作: `tabs.sendMessage` が1回、長文が破損せず透過
- 入力値: prompt 長さ 10,000 の文字列
  - 入力データの意味: 実運用での大きなプロンプト
- 期待される結果: 呼び出し成立、長さ保持
  - 期待結果の理由: 実運用境界の確認
- テストの目的: 大payload耐性
  - 確認ポイント: 送信呼び出しの成立とpayload長
- 信頼性: 🟢（既存テストあり）

---

## 2. 異常系テストケース（エラーハンドリング）

- テスト名: 未知メッセージは UNKNOWN_MESSAGE エラー
  - エラーケースの概要: 未定義 `type` を受理
  - エラー処理の重要性: 不正操作経路の遮断
- 入力値: `{ type:'UNKNOWN', payload:{} }`
  - 不正な理由: 仕様外のメッセージ
  - 実際の発生シナリオ: バージョン齟齬/外部拡張の干渉
- 期待される結果: `runtime.sendMessage({ type:'ERROR', payload:{ error:{ code:'UNKNOWN_MESSAGE' }}})`
  - エラーメッセージの内容: 理由をコードで明示
  - システムの安全性: 以降の副作用なし
- テストの目的: 仕様外排除
  - 品質保証の観点: 安全性・健全性の担保
- 信頼性: 🟢（既存テストあり）

- テスト名: START_GENERATION の必須 payload 欠落は INVALID_PAYLOAD
  - エラーケースの概要: `job` 欠落
  - エラー処理の重要性: 不完全命令の拒否
- 入力値: `{ type:'START_GENERATION', payload:{} }`
  - 不正な理由: 必須項目不足
  - 実際の発生シナリオ: バグ/互換性崩れ
- 期待される結果: `ERROR(INVALID_PAYLOAD)` を送出
  - エラーメッセージの内容: 欠落フィールドを示唆
  - システムの安全性: 橋渡し未実行
- テストの目的: 入力検証
  - 品質保証の観点: 入力品質の担保
- 信頼性: 🟢（既存テストあり）

- テスト名: PROGRESS_UPDATE の必須項目欠落は INVALID_PAYLOAD
  - エラーケースの概要: `jobId` 欠落
  - エラー処理の重要性: 識別不能イベントの拒否
- 入力値: `{ type:'PROGRESS_UPDATE', payload:{ status:'running', progress:{ current:1, total:3 } }}`
  - 不正な理由: 識別子なし
  - 実際の発生シナリオ: バグ/古いCS
- 期待される結果: `ERROR(INVALID_PAYLOAD)` を送出
  - エラーメッセージの内容: 欠落項目の指摘
  - システムの安全性: ブロードキャスト無効化
- テストの目的: 進捗検証の堅牢化
  - 品質保証の観点: 整合性維持
- 信頼性: 🟢（既存テストあり）

- テスト名: IMAGE_READY の必須項目欠落は INVALID_PAYLOAD（url/filename）
  - エラーケースの概要: ダウンロードに必要な情報不足
  - エラー処理の重要性: 不正DL防止
- 入力値: `{ type:'IMAGE_READY', payload:{ jobId:'j1', index:0, fileName:'x.png' }}`
  - 不正な理由: url不足
  - 実際の発生シナリオ: CS 実装不備
- 期待される結果: `ERROR(INVALID_PAYLOAD)`、DOWNLOAD_IMAGE は送らない
  - エラーメッセージの内容: 必須項目不足
  - システムの安全性: 不正操作中止
- テストの目的: DL指示の防御
  - 品質保証の観点: セーフティ
- 信頼性: 🟢（既存テストあり）

- テスト名: IMAGE_READY の不正URLは INVALID_URL
  - エラーケースの概要: `javascript:` 等の不正スキーム
  - エラー処理の重要性: セキュリティ
- 入力値: `{ type:'IMAGE_READY', payload:{ jobId:'j1', url:'javascript:alert(1)', index:0, fileName:'x.png' }}`
  - 不正な理由: 危険なスキーム
  - 実際の発生シナリオ: XSS誘発URL
- 期待される結果: `ERROR(INVALID_URL)`、DOWNLOAD_IMAGE は送らない
  - エラーメッセージの内容: URL危険性のコード化
  - システムの安全性: DL抑止
- テストの目的: URLサニタイズ
  - 品質保証の観点: 安全性担保
- 信頼性: 🟢（既存テストあり）

- テスト名: DOWNLOAD_FAILED を受理したら指数バックオフで再試行をスケジュール
  - エラーケースの概要: ダウンロード失敗に対し即時再送しない
  - エラー処理の重要性: 混雑・失敗時の安定性
- 入力値: `{ type:'ERROR', payload:{ error:{ code:'DOWNLOAD_FAILED' }, context:{ url, fileName } }}`
  - 不正な理由: 直近DL失敗状態
  - 実際の発生シナリオ: ネットワーク断/一時障害
- 期待される結果: 500ms 後に `DOWNLOAD_IMAGE` を送出（即時ではない）
  - エラーメッセージの内容: なし（内部挙動）
  - システムの安全性: スパム送信防止
- テストの目的: リトライポリシの検証
  - 品質保証の観点: 回復性
- 信頼性: 🟡（要件/テストコメントの妥当推測）

- テスト名: 再試行上限到達で打ち切り、ERROR 通知
  - エラーケースの概要: 500/1000/2000msで3回再試行後は打切り
  - エラー処理の重要性: 無限再試行防止
- 入力値: 同上イベントを4回連続投入、フェイクタイマーで進める
  - 不正な理由: 上限超過
  - 実際の発生シナリオ: 長時間障害
- 期待される結果: 4回目で追加再送なし、`ERROR(DOWNLOAD_FAILED)` を通知
  - エラーメッセージの内容: 上限到達
  - システムの安全性: 資源浪費防止
- テストの目的: 上限制御
  - 品質保証の観点: 安定性
- 信頼性: 🟡（要件/テストコメントの妥当推測）

---

## 3. 境界値テストケース（最小値、最大値、null等）

- テスト名: ファイル名サニタイズ（禁止文字除去・128文字制限・拡張子保持）
  - 境界値の意味: OS制約/安全性
  - 境界値での動作保証: 長大/不正文字混入でも安全名へ変換
- 入力値: `fileName = 'a'.repeat(300) + ':/\\*?"<>|' + '.png'`
  - 境界値選択の根拠: 長さ超過+禁止文字の複合
  - 実際の使用場面: 長いプロンプト由来の名前
- 期待される結果: 128文字以下、禁止文字除去、`.png` 維持
  - 境界での正確性: 条件満たす文字列
  - 一貫した動作: 常に同規則
- テストの目的: サニタイズ品質
  - 堅牢性の確認: OS/FS互換維持
- 信頼性: 🟡（要件の妥当推測 + 既存テスト）

- テスト名: 非常に長い prompt（10,000文字）
  - 境界値の意味: メッセージサイズ境界
  - 境界値での動作保証: 透過維持
- 入力値: `'p'.repeat(10_000)`
  - 境界値選択の根拠: 既存テスト準拠
  - 実際の使用場面: 辞書/テンプレ展開
- 期待される結果: tabs.sendMessage 呼び出し1回、長さ保持
  - 境界での正確性: 切り捨て・破損なし
  - 一貫した動作: 通常と同じ
- テストの目的: サイズ耐性
  - 堅牢性の確認: 上限近傍でも安定
- 信頼性: 🟢（既存テストあり）

- テスト名: 再試行スケジュールの遅延境界（500/1000/2000ms）
  - 境界値の意味: バックオフ時定数
  - 境界値での動作保証: 期待どおりの遅延
- 入力値: フェイクタイマーで 499/500/999/1000/1999/2000ms を進める
  - 境界値選択の根拠: しきい値直前直後
  - 実際の使用場面: 実運用での遅延確認
- 期待される結果: しきい値を跨いだ時点でのみ DL 再送
  - 境界での正確性: タイミング厳密
  - 一貫した動作: 各段階で同規則
- テストの目的: タイミング正確性
  - 堅牢性の確認: 時間管理の正確性
- 信頼性: 🟡（要件の妥当推測 + 既存テスト）

- テスト名: NovelAIタブ存在有無の切替
  - 境界値の意味: query結果の分岐
  - 境界値での動作保証: 分岐に応じた create/update の正確性
- 入力値: `tabs.query` が `[]` と `[ { id } ]` の両方
  - 境界値選択の根拠: 分岐網羅
  - 実際の使用場面: 初回/再訪
- 期待される結果: 期待どおりの API 呼び分け
  - 境界での正確性: 誤呼び出しなし
  - 一貫した動作: 常に同規則
- テストの目的: 分岐網羅
  - 堅牢性の確認: 例外の少なさ
- 信頼性: 🟡

---

## 開発言語・フレームワーク

- プログラミング言語: TypeScript
  - 言語選択の理由: 既存コード/型定義（src/types.ts）とテストがTSで統一、型安全で回帰防止に有利
  - テストに適した機能: 型補完・リテラル型・型ガードでメッセージshapeを検証しやすい
- テストフレームワーク: Vitest
  - フレームワーク選択の理由: 既存セットアップ（vitest.config.ts, test/setup.ts）と互換、Jest互換APIで学習コスト低
  - テスト実行環境: Node + jsdom（Chrome APIはモック）
- 信頼性: 🟢（現行リポジトリ構成に一致）

---

## テストケース実装時の日本語コメント指針

各テストで以下のコメントを記述すること。

```javascript
// 【テスト目的】: [このテストで何を確認するかを日本語で明記]
// 【テスト内容】: [具体的にどのような処理をテストするかを説明]
// 【期待される動作】: [正常に動作した場合の結果を説明]
// 🟢🟡🔴 この内容の信頼性レベルを記載
```

```javascript
// 【テストデータ準備】: [なぜこのデータを用意するかの理由]
// 【初期条件設定】: [テスト実行前の状態を説明]
// 【前提条件確認】: [テスト実行に必要な前提条件を明記]
```

```javascript
// 【実際の処理実行】: [どの機能/メソッドを呼び出すかを説明]
// 【処理内容】: [実行される処理の内容を日本語で説明]
// 【実行タイミング】: [なぜこのタイミングで実行するかを説明]
```

```javascript
// 【結果検証】: [何を検証するかを具体的に説明]
// 【期待値確認】: [期待される結果とその理由を説明]
// 【品質保証】: [この検証がシステム品質にどう貢献するかを説明]
```

```javascript
// 【検証項目】: [この検証で確認している具体的な項目]
// 🟢🟡🔴 この内容の信頼性レベルを記載
```

```javascript
beforeEach(() => {
  // 【テスト前準備】: [各テスト実行前に行う準備作業の説明]
  // 【環境初期化】: [テスト環境をクリーンな状態にする理由と方法]
});

afterEach(() => {
  // 【テスト後処理】: [各テスト実行後に行うクリーンアップ作業の説明]
  // 【状態復元】: [次のテストに影響しないよう状態を復元する理由]
});
```

---

## 品質判定（テストケース）

✅ 高品質

- テスト分類: 正常系・異常系・境界値を網羅
- 期待値定義: 各ケースに期待動作・検証点を明記
- 技術選択: TypeScript + Vitest で確定
- 実装可能性: 既存のモック/設定で実行可能

---

## 次のステップ

次のお勧めステップ: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。
