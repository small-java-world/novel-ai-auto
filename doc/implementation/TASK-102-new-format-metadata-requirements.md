# TDD要件定義・機能仕様の整理

**【機能名】**: TASK-102 新フォーマット対応・メタデータ管理

## 事前準備

開発コンテキストの準備を行います：

**Taskツール実行**: `/tdd-load-context` でTDD関連ファイルの読み込みとコンテキスト準備を実行 ✅ 完了

読み込み完了後、準備されたコンテキスト情報を基にTDD要件定義の作業を開始します。

## TDD用要件整理フォーマット

**【信頼性レベル指示】**:
各項目について、元の資料（EARS要件定義書・設計文書含む）との照合状況を以下の信号でコメントしてください：

- 🟢 **青信号**: EARS要件定義書・設計文書を参考にしてほぼ推測していない場合
- 🟡 **黄信号**: EARS要件定義書・設計文書から妥当な推測の場合
- 🔴 **赤信号**: EARS要件定義書・設計文書にない推測の場合

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

- 🟢 **何をする機能か**: プロンプトファイルの新フォーマット（v1.0）読み込み、メタデータ表示・管理、タグベースフィルタリング機能
- 🟢 **どのような問題を解決するか**: 既存のJSON形式では表現できないメタデータ（作成者、説明、タグ等）の管理とファイル間の互換性確保
- 🟢 **想定されるユーザー**: NovelAI自動生成を使用する創作者で、プロンプトコレクションを整理・管理したいユーザー
- 🟢 **システム内での位置づけ**: プロンプト管理機能拡張フェーズの最終段階、TASK-100（ファイル選択）・TASK-101（プロンプト合成）の上位機能
- **参照したEARS要件**: REQ-102-001〜005（機能要件）、REQ-102-101〜104（条件要件）、REQ-102-401〜403（制約要件）
- **参照した設計文書**: architecture.md のプロンプト管理コンポーネント、prompt-file-format.md v1.0仕様

## 2. 入力・出力の仕様（EARS機能要件・TypeScript型定義ベース）

### 入力パラメータ

- 🟢 **新フォーマットファイル**: `.naiprompts` または `.json` ファイル（PromptFileV1インターフェース準拠）
  ```typescript
  interface PromptFileV1 {
    version: '1.0';
    metadata: MetadataV1;
    commonPrompts?: CommonPromptsV1;
    presets: PresetV1[];
  }
  ```
- 🟢 **メタデータ構造**:
  ```typescript
  interface MetadataV1 {
    name: string; // 1-100文字
    description?: string; // 0-500文字
    author?: string; // 0-50文字
    created?: string; // ISO 8601形式
    modified?: string; // ISO 8601形式
    tags?: string[]; // 0-20タグ
    license?: string;
    source?: string;
  }
  ```
- 🟢 **タグフィルタリング入力**: 文字列配列（選択されたタグリスト）、検索クエリ文字列
- 🟢 **レガシー形式**: 既存のJSON形式プロンプトファイル（LegacyPromptFile型）

### 出力値

- 🟢 **メタデータ表示**: HTML要素として整形されたメタデータ情報
  ```typescript
  interface MetadataDisplayResult {
    name: string;
    description: string;
    author: string;
    dateCreated: string;
    dateModified: string;
    tags: string[];
    license?: string;
    source?: string;
  }
  ```
- 🟢 **フィルタリング結果**: タグ条件に基づく絞り込み済みプリセット配列
  ```typescript
  interface FilterResult {
    filteredPresets: PresetV1[];
    matchCount: number;
    appliedTags: string[];
  }
  ```
- 🟢 **変換結果**: 旧形式からの自動変換時の新フォーマットデータ
  ```typescript
  interface ConversionResult {
    success: boolean;
    convertedData?: PromptFileV1;
    warnings: string[];
    errors: string[];
  }
  ```

### 入出力の関係性

- 🟢 **ファイル読み込み**: 入力ファイル → フォーマット検証 → メタデータ抽出 → 表示用データ生成
- 🟢 **フィルタリング**: タグ選択 → プリセットマッチング → 絞り込み結果表示
- 🟢 **フォーマット変換**: レガシー入力 → 新フォーマット変換 → 互換性確保

### データフロー

- 🟢 **基本フロー**: ファイル選択 → フォーマット判定 → メタデータ解析 → UI表示 → タグフィルタリング
- **参照したEARS要件**: REQ-102-001（新フォーマット読み込み）、REQ-102-002（メタデータ表示）、REQ-102-005（タグフィルタ）
- **参照した設計文書**: metadata.ts の型定義、popup UI仕様、dataflow.md のファイル処理フロー

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

### パフォーマンス要件

- 🟢 **メタデータ読み込み**: ≤200ms（NFR-102-001）
- 🟢 **タグフィルタリング**: ≤100ms（NFR-102-002）
- 🟢 **フォーマット変換**: ≤500ms（NFR-102-003）
- 🟢 **メモリ使用量**: 最大50MB（大量プリセット処理時）

### セキュリティ要件

- 🟢 **ファイルサイズ制限**: 最大10MB（既存制約踏襲）
- 🟢 **Unicode正規化**: NFC形式（REQ-102-402）
- 🟢 **入力検証**: JSON Schema v7準拠（REQ-102-401）
- 🟢 **XSS防止**: メタデータ表示時のHTMLエスケープ処理

### 互換性要件

- 🟢 **既存形式対応**: 旧JSON形式との完全な下位互換性（REQ-102-003）
- 🟢 **バージョン管理**: 異なるバージョン間の適切な変換処理（REQ-102-103）
- 🟢 **Chrome拡張対応**: Manifest V3環境でのStorage API利用

### アーキテクチャ制約

- 🟢 **Chrome Storage**: メタデータは `chrome.storage.local` に永続化
- 🟢 **UI統合**: 既存popup.htmlへの非破壊的な機能追加
- 🟢 **モジュール分離**: MetadataManager, FormatConverter, TagFilterの責任分離
- 🟢 **依存関係**: TASK-100（LocalFileSelector）、TASK-101（PromptSynthesizer）との統合

### データベース制約

- 🟢 **ストレージサイズ**: Chrome Storage制限内（通常5MB-10MB）
- 🟢 **キー命名**: 名前空間 `metadata_`, `tags_`, `formats_` での管理

### API制約

- 🟢 **Chrome API**: chrome.storage.local, File API使用
- 🟢 **TypeScript**: strict modeでの型安全性確保
- **参照したEARS要件**: NFR-102-001〜003（パフォーマンス）、REQ-102-401〜403（制約）
- **参照した設計文書**: architecture.md のストレージ設計、manifest.json権限設定

## 4. 想定される使用例（EARSEdgeケース・データフローベース）

### 基本的な使用パターン

- 🟢 **新フォーマット読み込み**: ユーザーが`.naiprompts`ファイル選択→メタデータ表示→プリセット利用可能
  - データフロー: File Selection → Format Validation → Metadata Extraction → UI Display
- 🟢 **タグフィルタリング**: タグ選択→該当プリセットのみ表示→絞り込み検索
  - データフロー: Tag Selection → Preset Matching → Filtered Results → UI Update
- 🟢 **旧形式変換**: 旧JSON選択→自動変換→新フォーマットとして利用継続
  - データフロー: Legacy File → Format Detection → Auto Conversion → New Format Usage

### エッジケース

- 🟢 **不完全メタデータ**: 必須フィールド不足時→デフォルト値設定（REQ-102-101）
  - 例: `name`フィールドなし → ファイル名から生成
- 🟢 **バージョン不一致**: 未知バージョン→最新対応バージョンへの変換試行（REQ-102-103）
  - 例: version "2.0" → "1.0"形式への下位変換
- 🟡 **重複タグ処理**: 同一タグ複数存在→自動重複除去（REQ-102-104）
- 🟡 **大量タグ処理**: 20個超過タグ→上限切り詰めと警告表示
- 🟡 **特殊文字タグ**: Unicode特殊文字→正規化とサニタイズ

### エラーケース

- 🟢 **JSON構文エラー**: 不正なJSON→詳細エラーメッセージと修正案表示
- 🟢 **文字数超過**: メタデータフィールド上限超過→警告表示と切り詰め処理
- 🟡 **循環参照**: メタデータ内の循環参照→検出時にエラー報告
- 🟡 **ファイル破損**: 部分的な読み込み失敗→復旧可能部分のみ処理
- 🟡 **メモリ不足**: 大容量ファイル処理時→チャンク分割処理

### 境界値テスト

- 🟢 **メタデータサイズ**: 各フィールドの文字数上下限値
- 🟢 **タグ数**: 0個、1個、19個、20個、21個（上限超過）
- 🟢 **ファイルサイズ**: 0B、1B、10MB-1B、10MB、10MB+1B
- **参照したEARS要件**: REQ-102-101〜104（エラー処理）、EDGE-101〜104（境界値）
- **参照した設計文書**: error-handling.md の例外処理パターン、boundary-test-integration.md

## 5. EARS要件・設計文書との対応関係

既存のEARS要件定義書・設計文書を参照した場合、以下の対応関係を明記してください：

### 参照したユーザストーリー

- **メタデータ管理ストーリー**: プロンプトファイルの作成者・説明・タグ情報を表示・管理したい
- **フィルタリングストーリー**: タグでプリセットを絞り込んで効率的に選択したい
- **互換性ストーリー**: 既存のプロンプトファイルを新機能でも利用継続したい

### 参照した機能要件

- **REQ-102-001**: 新フォーマット（v1.0）プロンプトファイルの読み込み
- **REQ-102-002**: メタデータの表示・管理機能
- **REQ-102-003**: 既存JSON形式との互換性維持
- **REQ-102-004**: バージョン管理機能
- **REQ-102-005**: タグベースフィルタリング機能

### 参照した非機能要件

- **NFR-102-001**: メタデータ読み込み性能（≤200ms）
- **NFR-102-002**: タグフィルタリング性能（≤100ms）
- **NFR-102-003**: フォーマット変換性能（≤500ms）
- **NFR-102-101**: メタデータ検証成功率（≥99%）
- **NFR-102-102**: フォーマット変換成功率（≥95%）

### 参照したEdgeケース

- **REQ-102-101**: 不完全メタデータのデフォルト値設定
- **REQ-102-102**: 旧形式の自動変換
- **REQ-102-103**: バージョン差異の適切な処理
- **REQ-102-104**: 重複タグの除去

### 参照した受け入れ基準

- メタデータ表示の正確性確認
- タグフィルタリング動作の検証
- フォーマット変換の完全性確認
- 既存機能との非干渉性確認

### 参照した設計文書

- **アーキテクチャ**: architecture.md のプロンプト管理コンポーネント設計
- **データフロー**: dataflow.md のファイル読み込み→検証→表示フロー
- **型定義**: metadata.ts の PromptFileV1, MetadataV1 インターフェース
- **データベース**: storage-schema.sql のメタデータテーブル設計（Chrome Storage JSON形式）
- **API仕様**: popup UI設計のメタデータパネルAPI仕様

## 品質判定

### ✅ 高品質達成

- **要件の曖昧さ**: なし - EARS要件とコンテキストから明確に定義
- **入出力定義**: 完全 - TypeScript型定義による厳密な仕様
- **制約条件**: 明確 - パフォーマンス・セキュリティ・互換性要件を具体的数値で規定
- **実装可能性**: 確実 - TASK-100/101の完成済み基盤上での拡張

### 品質確認項目

- [x] EARS要件REQ-102-xxxシリーズとの完全対応
- [x] 既存アーキテクチャとの整合性確保
- [x] TASK-100/101の依存関係と統合ポイント明確化
- [x] TypeScript型システムによる実装指針提示
- [x] 非機能要件の具体的数値指標設定

## TODO更新

- [x] TDD要件定義フェーズ完了
- [x] EARS要件REQ-102-001〜403との対応関係確立
- [x] 既存実装（TASK-100/101）との統合方針確定
- [x] パフォーマンス・セキュリティ・互換性制約の明確化
- [x] エッジケースとエラーハンドリングの網羅的整理

## 次のステップ

**次のお勧めステップ**: `/tdd-testcases TASK-102` でテストケースの洗い出しを行います。

特に以下の観点での包括的テストケース設計を推奨：

1. **新フォーマット読み込み**: v1.0仕様準拠の各種ケース
2. **メタデータ管理**: 表示・編集・検証の全パターン
3. **タグフィルタリング**: 単一・複数・部分一致・特殊文字の組み合わせ
4. **互換性**: レガシー形式からの変換パターン網羅
5. **エラーハンドリング**: 境界値・異常値・破損データの処理
