# TDD要件定義 - TASK-070: ログイン要求の検出と再開

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

🟢 **信頼性レベル**: EARS要件定義書・設計文書を参考にして構成

### 何をする機能か（ユーザストーリーから抽出）
- NovelAI Web UI上でログイン要求が発生した際に、これを自動検出してユーザーに通知し、ログイン完了後に前回の生成ジョブを再開可能にする機能

### どのような問題を解決するか（As a / So that から抽出）
- **問題**: ログイン セッション期限切れやブラウザ再起動により、長時間の画像生成処理が中断される
- **解決**: ログイン状態の変化を監視し、ログイン要求時にジョブ状態を保持し、復帰後に自動再開を提供

### 想定されるユーザー（As a から抽出）
- 作業効率を重視するNovelAIユーザー（生成時間が長く、途中でログアウトが発生する可能性がある）

### システム内での位置づけ（アーキテクチャ設計から抽出）
- **コンポーネント**: Content Script（DOM監視）+ Service Worker（状態管理・ジョブ制御）
- **通信**: Message Passing でログイン状態変化を Service Worker に通知
- **データフロー**: DOM監視 → ログイン検出 → ジョブ一時停止 → 状態保存 → ユーザー通知 → 復帰待機 → 自動再開

**参照したEARS要件**: REQ-102, EDGE-004
**参照した設計文書**: architecture.md（アーキテクチャパターン：MV3 Event-driven Extension + Message Passing）

## 2. 入力・出力の仕様（EARS機能要件・TypeScript型定義ベース）

🟢 **信頼性レベル**: types.tsの既存インターフェース（PageState）に基づく

### 入力パラメータ
- **DOM監視対象**: NovelAI ログインページの要素（ログインフォーム、認証エラーメッセージ等）
- **現在のジョブ状態**: `GenerationJob.status = 'running'` 状態のジョブ
- **ページURL**: `PageState.currentUrl` でNovelAIドメイン内の変化を監視

### 出力値
- **ログイン検出メッセージ**:
  ```typescript
  interface LoginRequiredMessage extends Message {
    type: 'LOGIN_REQUIRED';
    currentJobId?: string;
    detectedAt: number;
    redirectUrl: string;
  }
  ```
- **ジョブ再開メッセージ**:
  ```typescript
  interface JobResumeMessage extends Message {
    type: 'RESUME_JOB';
    jobId: string;
    resumePoint: 'prompt_application' | 'generation_start' | 'download_start';
  }
  ```

### 入出力の関係性
- ログイン要求検出 → ジョブ一時停止 → 状態保存 → ユーザー通知
- ログイン完了検出 → 保存状態復元 → ジョブ再開

**参照したEARS要件**: REQ-102（ログイン要求時の一時停止処理）
**参照した設計文書**: types.ts（PageState、GenerationJob、Message interfaces）

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

🟡 **信頼性レベル**: アーキテクチャ設計から妥当な推測

### パフォーマンス要件
- **監視周期**: DOM監視は既存の進捗監視（500ms周期）に統合し、追加オーバーヘッドを最小化
- **検出速度**: ログイン要求検出から通知まで1秒以内

### セキュリティ要件
- **権限制限**: 既存権限（`activeTab`, `scripting`）内で実装、追加権限不要
- **データ保護**: ログイン情報（パスワード等）は一切取得・保存しない
- **URL検証**: NovelAIドメイン内のURLのみを監視対象とする

### 互換性要件
- **Chrome API**: Manifest V3制約下での`chrome.storage`を使用した状態永続化
- **DOM依存**: NovelAI UI変更に対するセレクタフォールバック機能を継承

### アーキテクチャ制約
- **既存コンポーネント活用**: TASK-020のDOM selector strategy、TASK-030のtab managerを基盤とする
- **メッセージング**: 既存のメッセージルーティング（TASK-031）を拡張

**参照したEARS要件**: NFR-101（権限最小化）、NFR-102（データ保護）
**参照した設計文書**: architecture.md（権限制約、メッセージ駆動アーキテクチャ）

## 4. 想定される使用例（EARSEdgeケース・データフローベース）

🟢 **信頼性レベル**: EDGE-004から具体的な要件を抽出

### 基本的な使用パターン
1. **セッション期限切れ**: 長時間生成中にセッション期限が切れ、ログインページにリダイレクト
2. **ブラウザ再起動**: ユーザーがブラウザを再起動し、NovelAIタブでログイン要求が表示
3. **手動ログアウト**: ユーザーが意図的にログアウトした後の再ログイン

### エッジケース
1. **誤検出防止**:
   - ログインページの一時的な表示（API遅延等）を真のログイン要求と誤判定しない
   - 最低500ms継続してログイン要求状態が続く場合のみ検出
2. **無限ループ防止**:
   - 連続したログイン失敗でログイン要求検出が無限に発生することを防ぐ
   - 10分間で5回以上のログイン要求検出は異常とみなし、自動再開を無効化
3. **競合状態対応**:
   - ログイン完了と新しいジョブ開始が同時に発生する場合の優先度制御

### エラーケース
1. **DOM要素未検出**: ログイン判定用のDOM要素が見つからない場合は既定値（ログイン済み）とみなす
2. **ストレージ障害**: ジョブ状態保存に失敗した場合はメモリ内状態でフォールバック
3. **タブ制御失敗**: NovelAIタブのアクティブ化に失敗した場合はユーザーに手動操作を促す

**参照したEARS要件**: EDGE-004（ログイン切れ時の前回ジョブ再開可能性）
**参照した設計文書**: dom-selector-strategy.ts（セレクタフォールバック機能）

## 5. EARS要件・設計文書との対応関係

### 参照したユーザストーリー
- ストーリー3: 進捗と異常時の再試行（ログイン切れを異常事態として扱い、再開機能で対応）

### 参照した機能要件
- **REQ-102**: ログインが必要な場合、システムはユーザーにログイン完了後に処理を一時停止しなければならない

### 参照した非機能要件
- **NFR-101**: 外部通信は行わず、ローカルストレージに保存する
- **NFR-102**: 取得するデータは最小化し、権限の最低限で実現する

### 参照したEdgeケース
- **EDGE-004**: ログイン切れ時のログイン完了後に直前のジョブを再開可能にする

### 参照した受け入れ基準
- ログイン後に前回ジョブを再開可能
- 検出誤判定/無限誘導ループを避けるセーフガード

### 参照した設計文書
- **アーキテクチャ**: architecture.md（MV3 Event-driven Extension パターン）
- **型定義**: types.ts（PageState.isLoggedIn、GenerationJob、Message interfaces）
- **依存コンポーネント**: dom-selector-strategy.ts（セレクタ探索）、tabManager.ts（タブ制御）

## 品質判定

✅ **高品質**:
- 要件の曖昧さ: なし（EARS要件REQ-102、EDGE-004から明確に定義）
- 入出力定義: 完全（既存TypeScript型定義に基づく新しいMessage型定義）
- 制約条件: 明確（既存アーキテクチャ制約内での実装方針）
- 実装可能性: 確実（既存のTASK-020、TASK-030の成果物を基盤として活用）

次のお勧めステップ: `/tdd-testcases` でテストケースの洗い出しを行います。