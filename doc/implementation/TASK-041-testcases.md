# TDD テストケース洗い出し - TASK-041

## 機能概要
TASK-041: プロンプトプリセット読み込み/選択UI

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript
  - **言語選択の理由**: 既存コードベースがTypeScriptで統一されており、型安全性によるバグ防止効果
  - **テストに適した機能**: 型安全なモック作成、インターフェース駆動開発によるテスト容易性
- **テストフレームワーク**: Vitest
  - **フレームワーク選択の理由**: 既存プロジェクトでVitest採用済み、高速実行とTypeScript統合
  - **テスト実行環境**: Node.js環境、Chrome APIモック、DOM要素モック
- 🟢 **信頼性レベル**: package.jsonとsrc/config/presets.test.tsで確認済み

## 1. 正常系テストケース（基本的な動作）

### TC-001: プリセットデータの正常読み込み

- **テスト名**: config/prompts.jsonからプリセット一覧を正常読み込み
  - **何をテストするか**: プリセットファイルの読み込みと型検証が正常に動作すること
  - **期待される動作**: loadPresetsFromFile関数で有効なプリセット配列を取得し、UI選択肢に反映

- **入力値**: 既存のconfig/prompts.jsonファイル
  - **入力データの意味**: 実際のプロダクション環境で使用されるプリセットデータ

- **期待される結果**: Preset[]型の配列（5個以上のプリセット）
  - **期待結果の理由**: REQ-001要件でプリセット選択機能の提供が必要

- **テストの目的**: プリセット管理機能の正常動作確認
  - **確認ポイント**: 型安全性、データ整合性、パフォーマンス（<200ms）

- 🟢 **信頼性レベル**: src/config/presets.tsの既存実装とREQ-001要件に基づく

### TC-002: プリセット選択UI表示

- **テスト名**: HTMLSelectElementへのプリセット選択肢表示
  - **何をテストするか**: 読み込んだプリセットがselect要素のoptionとして正しく表示されること
  - **期待される動作**: プリセット名がoption要素のtextContentに設定され、valueにプリセットIDが設定

- **入力値**: モックプリセット配列 `[{name: "テストプリセット", prompt: "test prompt", ...}]`
  - **入力データの意味**: 最小限の有効なプリセットデータ

- **期待される結果**: option要素の生成、textContent="テストプリセット"
  - **期待結果の理由**: ユーザーがプリセット名で選択できる必要がある

- **テストの目的**: UI描画機能の正常動作確認
  - **確認ポイント**: DOM操作の正確性、文字エスケープ処理、アクセシビリティ

- 🟢 **信頼性レベル**: popup.html既存構造とui-state-manager.tsの実装パターンに基づく

### TC-003: プリセット選択とメッセージ送信

- **テスト名**: プリセット選択後のSTART_GENERATIONメッセージ送信
  - **何をテストするか**: ユーザーがプリセットを選択して生成ボタン押下時の正常フロー
  - **期待される動作**: 選択プリセットの内容でSTART_GENERATIONメッセージを構築・送信

- **入力値**:
  - 選択プリセット: `{name: "美しい風景", prompt: "beautiful landscape", parameters: {steps: 28}}`
  - 設定値: `{imageCount: 1, seed: -1, filenameTemplate: "{date}_{prompt}_{idx}"}`
  - **入力データの意味**: 実際のユーザー操作シナリオを模擬

- **期待される結果**: chrome.runtime.sendMessage呼び出し、正しいpayload構造
  ```typescript
  {
    type: 'START_GENERATION',
    prompt: 'beautiful landscape',
    parameters: { steps: 28, seed: -1, count: 1 },
    settings: { imageCount: 1, seed: -1, filenameTemplate: "{date}_{prompt}_{idx}" }
  }
  ```
  - **期待結果の理由**: REQ-006メッセージ通信要件とService Worker連携要件

- **テストの目的**: エンドツーエンドフロー検証
  - **確認ポイント**: メッセージ形状、データ変換正確性、chrome API呼び出し

- 🟢 **信頼性レベル**: popup.jsの既存START_GENERATIONロジックとmessagingRouterの実装に基づく

### TC-004: プリセット検索・フィルタ機能

- **テスト名**: プリセット名による検索・絞り込み表示
  - **何をテストするか**: 検索入力による動的フィルタリング機能
  - **期待される動作**: 検索文字列に部分一致するプリセットのみを選択肢に表示

- **入力値**:
  - プリセット: `[{name: "美しい風景"}, {name: "アニメキャラ"}, {name: "風景画"}]`
  - 検索文字: "風景"
  - **入力データの意味**: 多数のプリセットから目的のものを素早く見つける用途

- **期待される結果**: "美しい風景"と"風景画"のみがoption要素として表示
  - **期待結果の理由**: ユーザビリティ向上、大量プリセットでの操作性確保

- **テストの目的**: 検索UX機能の正常動作確認
  - **確認ポイント**: 文字列マッチング精度、リアルタイム更新、パフォーマンス

- 🟡 **信頼性レベル**: 要件定義書の検索機能記述から妥当推測（オプション機能として明記）

## 2. 異常系テストケース（エラーハンドリング）

### TC-005: プリセットファイル読み込み失敗

- **テスト名**: config/prompts.json不正・存在しない場合のエラーハンドリング
  - **エラーケースの概要**: ファイル欠損、JSON構文エラー、権限不足での読み込み失敗
  - **エラー処理の重要性**: アプリケーション起動を阻害せず、代替手段を提供

- **入力値**:
  - 存在しないファイルパス: `config/nonexistent.json`
  - 不正JSON: `{invalid json syntax`
  - **不正な理由**: ファイルシステムエラー、手動編集ミス、デプロイ不備
  - **実際の発生シナリオ**: 拡張機能更新時のファイル欠損、ユーザーによる設定ファイル改変

- **期待される結果**:
  - エラーログ出力: "プリセットファイルの読み込みに失敗しました"
  - 代替表示: デフォルトプリセットまたは案内メッセージ
  - アプリ継続: 他機能には影響しない
  - **エラーメッセージの内容**: ユーザーにとって理解しやすく、対処方法を示唆
  - **システムの安全性**: エラー時でも拡張機能全体がクラッシュしない

- **テストの目的**: 堅牢性の確保とユーザー体験の保護
  - **品質保証の観点**: エラー発生時でもシステム継続動作を保証

- 🟢 **信頼性レベル**: presets.tsのloadPresetsFromFile関数エラーハンドリング実装に基づく

### TC-006: 空プリセットリストの処理

- **テスト名**: 有効なプリセットが0個の場合の案内表示
  - **エラーケースの概要**: プリセット検証で全て無効、空配列の状態
  - **エラー処理の重要性**: ユーザーに適切な状況説明と次の行動を提示

- **入力値**: 空配列 `[]` または全て無効なプリセット配列
  - **不正な理由**: 設定ファイル内容の不備、検証基準の変更
  - **実際の発生シナリオ**: アップデート時のプリセット互換性問題、設定ファイル破損

- **期待される結果**:
  - UI表示: "プリセットが見つかりません。設定を確認してください"
  - 生成ボタン無効化: START_GENERATIONメッセージ送信を阻止
  - 代替操作の提示: 手動プロンプト入力の案内
  - **エラーメッセージの内容**: 状況説明と対処手順を明記
  - **システムの安全性**: 無効状態での処理実行を防止

- **テストの目的**: Edge case対応とユーザー体験の保護
  - **品質保証の観点**: 想定外状況でも適切な案内を提供

- 🟡 **信頼性レベル**: EDGE-001要件とvalidatePresets関数の動作から妥当推測

### TC-007: メッセージ送信失敗時の処理

- **テスト名**: chrome.runtime.sendMessage失敗時のエラーハンドリング
  - **エラーケースの概要**: Service Worker停止、権限不足、通信エラー
  - **エラー処理の重要性**: ユーザーに失敗を明確に通知し、再試行の機会を提供

- **入力値**: chrome.runtime.sendMessage()のPromise reject
  - **不正な理由**: Service Worker の突然停止、Chrome拡張権限の問題
  - **実際の発生シナリオ**: Chrome ブラウザ更新、拡張機能再読み込み、システム負荷

- **期待される結果**:
  - エラー表示: "通信エラーが発生しました。しばらく待ってから再試行してください"
  - UI状態復元: 生成中表示を解除、操作可能状態に戻す
  - ログ記録: デバッグ用の詳細エラー情報を記録
  - **エラーメッセージの内容**: 一時的な問題である可能性を示唆
  - **システムの安全性**: エラー後の操作継続を保証

- **テストの目的**: 通信エラー時の適切な回復処理
  - **品質保証の観点**: Chrome拡張特有のエラー状況への対応

- 🟢 **信頼性レベル**: ui-state-manager.tsのstartGeneration関数エラーハンドリングに基づく

## 3. 境界値テストケース（最小値、最大値、null等）

### TC-008: プリセット数の境界値テスト

- **テスト名**: 最小・最大プリセット数での動作確認
  - **境界値の意味**: システム性能とUX品質を保証する上限・下限値
  - **境界値での動作保証**: 極端な条件下でも安定した動作を確保

- **入力値**:
  - 最小: プリセット1個
  - 最大: プリセット50個（性能要件の上限）
  - **境界値選択の根拠**: 要件定義書の性能制約（50個程度）とUX考慮
  - **実際の使用場面**: 最小構成での運用、大規模プリセット集での運用

- **期待される結果**:
  - 最小: 正常な選択・送信動作、UI表示の適切性
  - 最大: 200ms以内のレスポンス、UI表示崩れなし、メモリ効率性
  - **境界での正確性**: 全プリセットが正しく選択可能
  - **一貫した動作**: プリセット数に関わらず同一の動作フロー

- **テストの目的**: 性能要件の境界での動作保証
  - **堅牢性の確認**: 極端な条件下でのシステム安定性

- 🟢 **信頼性レベル**: 要件定義書の性能要件（50個程度、<200ms）に基づく

### TC-009: プリセット文字数の境界値テスト

- **テスト名**: プロンプト・ネガティブプロンプトの文字数境界での処理
  - **境界値の意味**: TypeScript型定義とvalidatePresets関数の制約値
  - **境界値での動作保証**: 極端な文字数でも正常な処理とメッセージ送信

- **入力値**:
  - プロンプト最小: 5文字（"hello"）
  - プロンプト最大: 2000文字
  - ネガティブ最小: 0文字（空文字）
  - ネガティブ最大: 2000文字
  - **境界値選択の根拠**: presets.tsのvalidatePresets関数制約に準拠
  - **実際の使用場面**: 簡潔なプロンプト、詳細な指示プロンプト

- **期待される結果**:
  - 正常な検証通過、START_GENERATIONメッセージの正確な構築
  - UI表示での文字切り詰めやレイアウト崩れなし
  - **境界での正確性**: 文字数制限内で完全なデータ送信
  - **一貫した動作**: 文字数に関わらず同一の処理フロー

- **テストの目的**: データ整合性とUI表示の境界値保証
  - **堅牢性の確認**: 極端なデータサイズでの処理安定性

- 🟢 **信頼性レベル**: validatePresets関数の境界値制約実装に基づく

### TC-010: null・undefined入力の処理

- **テスト名**: null・undefined・空文字列入力での安全な処理
  - **境界値の意味**: JavaScript/TypeScript環境での典型的な異常値
  - **境界値での動作保証**: 型安全性とランタイムエラー防止

- **入力値**:
  - プリセット選択値: null, undefined, ""
  - 設定値の各項目: null, undefined
  - **境界値選択の根拠**: JavaScript の falsy 値とTypeScript strict null checks
  - **実際の使用場面**: 初期化前の状態、DOM操作失敗、ユーザー操作ミス

- **期待される結果**:
  - 型ガード処理でランタイムエラー回避
  - デフォルト値での代替処理またはバリデーションエラー
  - 明確なエラーメッセージでユーザー案内
  - **境界での正確性**: null safe な処理で例外発生を防止
  - **一貫した動作**: すべての null/undefined パターンで安全な処理

- **テストの目的**: 型安全性とランタイム安定性の保証
  - **堅牢性の確認**: 不正データでのアプリケーション継続動作

- 🟡 **信頼性レベル**: TypeScript strict設定とui-state-manager.tsの実装パターンから妥当推測

## 品質判定

✅ **高品質**:
- **テストケース分類**: 正常系・異常系・境界値が網羅されている（10テストケース）
- **期待値定義**: 各テストケースの期待値が明確（メッセージ形状、UI状態、エラー処理）
- **技術選択**: TypeScript + Vitest で確定（既存環境と整合）
- **実装可能性**: 既存テストパターンと技術スタックで確実に実現可能

## TODO更新

- 現在のTODO「テストケース洗い出し」を「completed」にマーク
- テストケース定義フェーズの完了をTODO内容に反映
- 品質判定結果「高品質」をTODO内容に記録
- 次のフェーズ「Redフェーズ（失敗テスト作成）」をTODOに追加

## 次のお勧めステップ

**次のお勧めステップ**: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。