# TASK-100 ローカルファイル選択機能 - TDD要件定義書

## 機能概要

**【機能名】**: TASK-100 ローカルファイル選択機能

ユーザーがローカルファイルシステムからプロンプトファイル（.naiprompts または .json）を選択・読み込み、既存のconfig/prompts.jsonと同様にプリセットとして使用できる機能を実装する。

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

- 🟡 **黄信号**: EARS要件定義書・設計文書から妥当な推測
- **何をする機能か**: ユーザーがローカルファイルシステムからプロンプトファイル（.naiprompts または .json）を選択・読み込み、既存のconfig/prompts.jsonと同様にプリセットとして使用できる機能
- **どのような問題を解決するか**: ユーザーが独自のプロンプトコレクションを使用したい場合に、現在は手動でconfig/prompts.jsonを編集する必要があるが、この機能により直感的なファイル選択で外部プロンプトファイルを利用可能にする
- **想定されるユーザー**: NovelAI利用者で、自作または他者作成のプロンプトコレクションを持つユーザー、プロンプト共有コミュニティ参加者
- **システム内での位置づけ**: Popup UIのプリセット選択機能を拡張し、既存のconfig/prompts.json読み込み機能と並行してローカルファイル読み込み機能を提供
- **参照したEARS要件**: [REQ-100-001〜REQ-100-005, REQ-100-101〜REQ-100-104, REQ-100-401〜REQ-100-403]
- **参照した設計文書**: [docs/tasks/novelai-auto-generator-tasks.md の TASK-100 セクション]

## 2. 入力・出力の仕様（EARS機能要件・TypeScript型定義ベース）

- 🟡 **黄信号**: EARS要件定義書・設計文書から妥当な推測
- **入力パラメータ**:
  - ファイル選択: HTMLInputElement[type="file"] (.naiprompts, .json拡張子)
  - ファイルサイズ制限: 10MB以下
  - ファイル形式: 既存PromptPreset[]形式またはnew format v1.0互換
- **出力値**:
  - 成功時: PromptPreset[]配列（既存形式と同じ型）
  - エラー時: ErrorInfo（ファイル読み込み失敗、形式不正、サイズ超過等）
- **入出力の関係性**: ローカルファイル → FileReader API → JSON.parse → PromptPreset[]検証 → UI反映
- **データフロー**: File Input → File Validation → Content Reading → Format Validation → Preset Integration
- **参照したEARS要件**: [REQ-100-002（ファイル形式検証）, REQ-100-003（サイズ制限）]
- **参照した設計文書**: [src/types.ts の PromptPreset インターフェース]

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

- 🟡 **黄信号**: EARS要件定義書・設計文書から妥当な推測
- **パフォーマンス要件**: ファイル読み込みは2秒以内、UI応答性確保（NFR-001準拠）
- **セキュリティ要件**: ファイル内容のXSS/インジェクション防止、JSONパース時の例外処理（NFR-102準拠）
- **互換性要件**: 既存config/prompts.json形式との完全互換性確保（REQ-100-005）
- **アーキテクチャ制約**: Chrome Extension MV3制約下でのFile API使用、Content Security Policy準拠
- **ファイルシステム制約**: ブラウザサンドボックス内でのローカルファイルアクセス制限
- **メモリ制約**: 10MBファイルの安全な読み込み、メモリリーク防止
- **参照したEARS要件**: [REQ-100-401（Chrome Extension制約）, REQ-100-403（互換性要件）]
- **参照した設計文書**: [docs/design/novelai-auto-generator/architecture.md の Chrome Extension制約セクション]

## 4. 想定される使用例（EARSEdgeケース・データフローベース）

- 🟡 **黄信号**: EARS要件定義書・設計文書から妥当な推測
- **基本的な使用パターン**:
  - 正常ケース: ファイル選択 → 読み込み成功 → プリセット一覧に追加表示
  - カスタムプロンプトファイル読み込み: ユーザー作成の.naiprompts選択 → 検証 → 統合
- **データフロー**: User File Selection → File Reader → JSON Validation → Preset Merge → UI Update
- **エッジケース**:
  - 空ファイル選択: ファイル未選択時の適切なエラーメッセージ
  - サイズ超過: 10MB超過ファイルの検出と警告
  - 形式不正: 不正JSONまたは必須フィールド欠如の処理
  - 重複ID: 既存プリセットIDとの衝突回避
- **エラーケース**:
  - ファイル読み込み失敗: FileReader APIエラー時の詳細メッセージ
  - パース失敗: JSON.parse例外の適切な処理
  - 検証失敗: PromptPreset形式不適合時の指摘
- **参照したEARS要件**: [REQ-100-101（エラーハンドリング）, REQ-100-102（検証処理）]
- **参照した設計文書**: [docs/design/novelai-auto-generator/dataflow.md の プリセット読み込みフロー]

## 5. EARS要件・設計文書との対応関係

- **参照したユーザストーリー**: [ローカルプロンプトファイル利用ストーリー]
- **参照した機能要件**: [REQ-100-001（ファイル選択UI）, REQ-100-002（読み込み機能）, REQ-100-003（形式検証）, REQ-100-004（エラーハンドリング）, REQ-100-005（互換性確保）]
- **参照した非機能要件**: [REQ-100-101（パフォーマンス）, REQ-100-102（セキュリティ）, REQ-100-103（ユーザビリティ）, REQ-100-104（信頼性）]
- **参照したEdgeケース**: [REQ-100-401（Chrome Extension制約）, REQ-100-402（ファイルサイズ制限）, REQ-100-403（互換性要件）]
- **参照した受け入れ基準**: [ローカルプロンプトファイルの正常選択・読み込み、既存形式との互換性確認]
- **参照した設計文書**:
  - **アーキテクチャ**: [docs/design/novelai-auto-generator/architecture.md の Popup UI設計]
  - **データフロー**: [docs/design/novelai-auto-generator/dataflow.md の プリセット管理フロー]
  - **型定義**: [src/types.ts の PromptPreset インターフェース]
  - **API仕様**: [既存プリセット読み込み機能（TASK-041）の実装パターン]

## 品質判定

✅ **高品質**:
- 要件の曖昧さ: 最小限（黄信号レベルの推測のみ）
- 入出力定義: 完全（既存型定義との整合性確保）
- 制約条件: 明確（Chrome Extension制約、セキュリティ、パフォーマンス）
- 実装可能性: 確実（既存TASK-041パターンの拡張）

## 完了時刻

2025-09-20 TDD要件定義フェーズ完了

---

**次のお勧めステップ**: `/tdd-testcases` でテストケースの洗い出しを行います。