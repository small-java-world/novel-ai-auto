# TDD要件定義 - TASK-040: UI スケルトン/状態管理

**【機能名】**: Popup UI スケルトン/状態管理

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

- 🟢 **何をする機能か**: NovelAI Auto Generatorの拡張機能Popupにおいて、ユーザーインターフェースの基本構造と状態管理機能を提供する
- 🟢 **どのような問題を解決するか**: ユーザーが設定を保存・復元し、リアルタイムで進捗状況を確認でき、拡張機能の全体状態を一元管理できるようにする
- 🟢 **想定されるユーザー**: NovelAI Web UIで画像生成を行う全てのユーザー（ストーリー1の"NovelAI ユーザ"に対応）
- 🟢 **システム内での位置づけ**: Chrome Extension MV3アーキテクチャにおけるPopup UIコンポーネント。Service Worker（背景処理）とContent Script（DOM操作）の間でユーザーインターフェースとして機能

**参照したEARS要件**:
- REQ-005 (設定の保存・復元)
- NFR-201 (進捗・残枚数・推定残り時間・直近のエラーを明確に表示)
- NFR-202 (生成処理をユーザがいつでもキャンセルできる)
- NFR-203 (主要UIはキーボード操作に対応し、視認性の高いコントラストで提供)

**参照した設計文書**: architecture.md のフロントエンド（拡張内）および状態管理セクション

## 2. 入力・出力の仕様（EARS機能要件・TypeScript型定義ベース）

### 入力パラメータ
- 🟢 **ユーザー設定入力**:
  - `imageCount: number` (1-10の範囲、デフォルト:1)
  - `seed: number` (任意の数値、-1でランダム)
  - `filenameTemplate: string` (テンプレート文字列、デフォルト:"{date}_{prompt}_{seed}_{idx}")
- 🟢 **メッセージ入力**:
  - `GENERATION_PROGRESS`: 進捗更新メッセージ
  - `GENERATION_COMPLETE`: 生成完了メッセージ
  - `GENERATION_ERROR`: エラーメッセージ

### 出力値
- 🟢 **Chrome Storage出力**:
  - `settings` 名前空間への設定データ保存（GenerationSettings型）
- 🟢 **Runtime Message出力**:
  - `START_GENERATION` メッセージ（Service Workerへ）
  - `CANCEL_JOB` メッセージ（ジョブキャンセル時）
- 🟢 **UI状態出力**:
  - 進捗表示（プログレスバー、残枚数、ETA）
  - ステータス表示（待機中/生成中/エラー）
  - ログ表示（最大50エントリ）

**参照したEARS要件**: REQ-005, REQ-006
**参照した設計文書**: interfaces.ts の GenerationSettings, ProgressInfo インターフェース

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

### パフォーマンス要件
- 🟢 **NFR-002**: 進捗表示・ログ更新は500ms以内の周期でユーザに反映する
- 🟢 **NFR-003**: バックグラウンドのメッセージ往復は200ms以内のレイテンシを目標とする

### セキュリティ要件
- 🟢 **NFR-101**: 外部通信は行わず、プロンプト・設定をローカルストレージ（chrome.storage）に保存する
- 🟢 **NFR-102**: 取得するデータは最小化し、権限の原則最小で運用する
- 🟢 **NFR-103**: ユーザ入力（ファイル名テンプレート等）をサニタイズして不正文字や パスインジェクションを防御する

### 互換性要件
- 🟢 **REQ-401**: Chrome Manifest V3 を使用する（MUST）
- 🟢 **REQ-403**: 最小権限（activeTab, scripting, downloads, storage, tabs）で動作する（MUST）

### アーキテクチャ制約
- 🟢 **軽量化**: 純粋なHTML/CSS/TypeScript（フレームワーク不使用）
- 🟢 **状態同期**: Popup内はローカルステート + chrome.storage同期、バックグラウンドとメッセージで整合

**参照したEARS要件**: NFR-001, NFR-002, NFR-003, NFR-101, NFR-102, NFR-103, REQ-401, REQ-403
**参照した設計文書**: architecture.md の主要設計決定およびシステム境界セクション

## 4. 想定される使用例（EARSEdgeケース・データフローベース）

### 基本的な使用パターン
- 🟢 **設定変更フロー**: ユーザーが設定値を変更 → 即座にchrome.storageに保存 → ログに保存完了を表示
- 🟢 **生成開始フロー**: プロンプト選択 → 生成開始ボタン押下 → START_GENERATIONメッセージ送信 → UI状態を「生成中」に変更
- 🟢 **進捗監視フロー**: GENERATION_PROGRESSメッセージ受信 → プログレスバー更新 → 残枚数・ETA表示更新

### エッジケース
- 🟡 **EDGE-101対応**: プロンプト文字数が上限超過の場合でも安全に適用し、超過分は警告する
- 🟡 **EDGE-102対応**: 生成枚数が0/1/最大値（設定上限）でも正しく動作する
- 🟡 **ストレージ障害**: chrome.storage読み書き失敗時にデフォルト値でレンダリングし通知
- 🟡 **メッセージ不達**: 進捗ストリーム中断時の再接続/通知処理

### エラーケース
- 🟢 **設定ロード失敗**: デフォルト値（imageCount:1, seed:-1, filenameTemplate:標準テンプレート）でUI初期化
- 🟢 **生成エラー**: GENERATION_ERRORメッセージ受信時にエラー状態表示とログ記録
- 🟢 **権限不足**: chrome.storage未許可時の適切なエラー表示

**参照したEARS要件**: EDGE-101, EDGE-102, REQ-005エラーハンドリング
**参照した設計文書**: messaging-router.ts のエラーハンドリングパターン

## 5. EARS要件・設計文書との対応関係

### 参照したユーザストーリー
- **ストーリー1**: プロンプトからワンクリック生成
- **ストーリー2**: 自動ダウンロードと命名

### 参照した機能要件
- **REQ-005**: システムは設定（例: 画像枚数・シード・ファイル名テンプレート等）を保存・復元しなければならない
- **REQ-006**: システムはコンテンツスクリプト、ポップアップ、Service Worker間でメッセージを安全通信しなければならない

### 参照した非機能要件
- **NFR-001**: 単枚完了（DOM確認後）から指定枚数生成・ダウンロード完了まで30秒以内（標準想定）とする
- **NFR-002**: 進捗表示・ログ更新は500ms以内の周期でユーザに反映する
- **NFR-003**: バックグラウンドのメッセージ往復は200ms以内のレイテンシを目標とする
- **NFR-101**: 外部通信は行わず、プロンプト・設定をローカルストレージ（chrome.storage）に保存する
- **NFR-201**: 進捗・残枚数・推定残り時間・直近のエラーを明確に表示する
- **NFR-202**: 生成処理をユーザがいつでもキャンセルできる
- **NFR-203**: 主要UIはキーボード操作に対応し、視認性の高いコントラストで提供する

### 参照したEdgeケース
- **EDGE-101**: プロンプト文字数が上限超過の場合でも安全に適用し、超過分は警告する
- **EDGE-102**: 生成枚数が0/1/最大値（設定上限）でも正しく動作する

### 参照した設計文書
- **アーキテクチャ**: architecture.md のコンポーネント構成（フロントエンド）、主要設計決定（メッセージ駆動、アクセシビリティ）
- **型定義**: interfaces.ts の GenerationSettings, ProgressInfo, Settings インターフェース、types.ts の GenerationSettings, MessageResponse
- **メッセージ仕様**: messaging-router.ts の START_GENERATION, GENERATION_PROGRESS, GENERATION_COMPLETE, GENERATION_ERROR, CANCEL_JOB メッセージタイプ

## 品質判定

✅ **高品質**:
- **要件の曖昧さ**: なし - EARS要件とアーキテクチャ設計から明確に定義
- **入出力定義**: 完全 - TypeScript型定義により厳密に仕様化
- **制約条件**: 明確 - 非機能要件とManifest V3制約を具体的に記載
- **実装可能性**: 確実 - 既存のストレージAPIとメッセージングシステムが利用可能

## 次のステップ

次のお勧めステップ: `/tdd-testcases` でテストケースの洗い出しを行います。