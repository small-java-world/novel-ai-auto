# TDDテストケース洗い出し - TASK-043

## 機能概要
TASK-043: 進捗/残枚数/ETA/ログ表示 + キャンセル

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript
  - **言語選択の理由**: 既存コードベースがTypeScriptで統一されており、メッセージ通信の型安全性が確保できる
  - **テストに適した機能**: Chrome Extension APIのモック作成、メッセージパッシングの型チェック、DOM操作の型安全性
- **テストフレームワーク**: Vitest + Happy-DOM
  - **フレームワーク選択の理由**: 既存プロジェクトでVitest採用済み、リアルタイム更新とメッセージハンドリングのテストに適している
  - **テスト実行環境**: Chrome Extension環境モック、DOM操作モック、timer/intervalモック環境
- 🟢 **信頼性レベル**: 既存のpackage.jsonとvitest.config.tsで確認済み

## 1. 正常系テストケース（基本的な動作）

### TC-043-001: 基本的な進捗表示の更新

- **テスト名**: PROGRESS_UPDATEメッセージ受信時の進捗表示更新
  - **何をテストするか**: Service WorkerからのPROGRESS_UPDATEメッセージを受信した際のUI更新処理
  - **期待される動作**: 進捗バー、残枚数、ETA、状態表示が正確に更新される

- **入力値**:
  ```typescript
  {
    type: 'PROGRESS_UPDATE',
    currentIndex: 2,
    totalCount: 5,
    status: 'generating',
    eta: 45,
    timestamp: Date.now()
  }
  ```
  - **入力データの意味**: 5枚中3枚目を処理中、残り45秒の典型的な進捗状況

- **期待される結果**:
  - 進捗バー: 40%（2/5）表示
  - 残枚数: "残り3枚"表示
  - ETA: "約45秒"表示
  - 状態: "生成中"表示
  - **期待結果の理由**: NFR-201要件で進捗・残枚数・ETAの明確な表示が必要

- **テストの目的**: リアルタイム進捗表示の正確性確認
  - **確認ポイント**: 計算精度、UI描画のタイミング、メッセージ処理の遅延（<100ms）

- 🟢 **信頼性レベル**: 要件定義書のメッセージ仕様とNFR-002（500ms周期）に基づく

### TC-043-002: キャンセルボタンによる処理停止

- **テスト名**: ユーザーキャンセル操作とCANCEL_JOBメッセージ送信
  - **何をテストするか**: キャンセルボタン押下時のCANCEL_JOBメッセージ送信とUI状態変更
  - **期待される動作**: CANCEL_JOBメッセージが送信され、UI状態が「キャンセル中」に変更される

- **入力値**: キャンセルボタンのclickイベント（生成中状態で実行）
  - **入力データの意味**: ユーザーが進行中の処理を停止したい状況

- **期待される結果**:
  ```typescript
  chrome.runtime.sendMessage({
    type: 'CANCEL_JOB',
    jobId: 'current_job_id',
    reason: 'user_requested'
  })
  ```
  - UI状態: "キャンセル中..."表示
  - キャンセルボタン無効化
  - **期待結果の理由**: NFR-202要件でユーザーがいつでもキャンセルできる必要がある

- **テストの目的**: キャンセル機能の完全性確認
  - **確認ポイント**: メッセージ送信の正確性、UI状態の一貫性、応答性（1秒以内）

- 🟢 **信頼性レベル**: 要件定義書のCANCEL_JOBメッセージ仕様とNFR-202要件に基づく

### TC-043-003: 完了状態の表示

- **テスト名**: 全画像生成完了時の最終状態表示
  - **何をテストするか**: 最後の画像生成完了時のcompletedステータス表示
  - **期待される動作**: 進捗100%、完了メッセージ、処理時間表示

- **入力値**:
  ```typescript
  {
    type: 'PROGRESS_UPDATE',
    currentIndex: 4,
    totalCount: 5,
    status: 'completed',
    eta: 0,
    timestamp: Date.now()
  }
  ```
  - **入力データの意味**: 5枚の生成が全て完了した最終状態

- **期待される結果**:
  - 進捗バー: 100%表示
  - 状態: "完了しました"表示
  - 処理時間: "総処理時間: XX分XX秒"表示
  - キャンセルボタン非表示
  - **期待結果の理由**: ユーザーに明確な完了通知を提供する必要がある

- **テストの目的**: 完了状態の正確な表示確認
  - **確認ポイント**: 最終状態の表示内容、UI要素の適切な無効化

- 🟢 **信頼性レベル**: 要件定義書の正常フローとNFR-201明確表示要件に基づく

### TC-043-004: ログエントリの表示更新

- **テスト名**: 処理ログの動的表示とスクロール管理
  - **何をテストするか**: 成功・失敗・警告ログの表示と最大5件の管理
  - **期待される動作**: 新しいログが上部に追加され、古いログが自動的に削除される

- **入力値**:
  ```typescript
  [
    { type: 'success', message: '画像1をダウンロードしました', timestamp: Date.now() },
    { type: 'warning', message: 'リトライが発生しました', timestamp: Date.now() - 1000 },
    { type: 'error', message: 'ダウンロードに失敗しました', timestamp: Date.now() - 2000 }
  ]
  ```
  - **入力データの意味**: 実際の処理中に発生する典型的なログエントリ

- **期待される結果**:
  - 最新5件のログがリスト表示
  - ログレベル別の色分け表示
  - タイムスタンプの適切なフォーマット
  - **期待結果の理由**: ユーザーが処理状況を詳細に把握できる必要がある

- **テストの目的**: ログ管理機能の正確性確認
  - **確認ポイント**: ログ件数制限、表示順序、視覚的識別性

- 🟡 **信頼性レベル**: 要件定義書のログ表示（最大5件）から妥当推測

## 2. 異常系テストケース（エラーハンドリング）

### TC-043-005: メッセージ通信断絶の検出

- **テスト名**: PROGRESS_UPDATEメッセージが長期間来ない場合の処理
  - **エラーケースの概要**: 5秒以上メッセージが受信されない場合の通信断絶検出
  - **エラー処理の重要性**: ユーザーに状況を明示し、適切な対処法を提示する

- **入力値**: 最後のPROGRESS_UPDATEから5000ms経過（メッセージなし）
  - **不正な理由**: Service Worker停止、メッセージルーティング障害、システム負荷
  - **実際の発生シナリオ**: Chrome拡張の再読み込み、システム負荷による処理停滞

- **期待される結果**:
  - エラー表示: "通信が中断されました。拡張機能を再読み込みしてください"
  - 状態表示: "通信中断"
  - 再接続ボタンの表示
  - **エラーメッセージの内容**: 具体的な対処法を含む分かりやすい説明
  - **システムの安全性**: 中断状態でも他の機能は継続利用可能

- **テストの目的**: 通信断絶時の適切な検出と回復処理
  - **品質保証の観点**: Chrome拡張特有の通信問題に対する堅牢性

- 🟡 **信頼性レベル**: 要件定義書のエッジケース「メッセージ断絶」から妥当推測

### TC-043-006: 不正なPROGRESS_UPDATEメッセージの処理

- **テスト名**: 形式不正・データ不整合メッセージのエラーハンドリング
  - **エラーケースの概要**: 必須フィールド欠損、型不正、論理的不整合の検出
  - **エラー処理の重要性**: 不正データによるUI破綻とアプリケーションクラッシュを防止

- **入力値**:
  ```typescript
  // 型不正
  { type: 'PROGRESS_UPDATE', currentIndex: "invalid", totalCount: 5 }
  // 論理的不整合
  { type: 'PROGRESS_UPDATE', currentIndex: 10, totalCount: 5 }
  // 必須フィールド欠損
  { type: 'PROGRESS_UPDATE', currentIndex: 2 } // totalCount missing
  ```
  - **不正な理由**: バグ、メッセージ変換エラー、バージョン不整合
  - **実際の発生シナリオ**: 開発中のデバッグ、拡張機能の部分更新

- **期待される結果**:
  - バリデーションエラーログ: "不正な進捗データを受信しました"
  - 前回の有効な状態を保持
  - デフォルト表示へのフォールバック
  - **エラーメッセージの内容**: 技術的詳細を含むデバッグ情報
  - **システムの安全性**: 不正データでUI表示が破綻しない

- **テストの目的**: メッセージバリデーションとフォールバック処理
  - **品質保証の観点**: 外部データに対する防御的プログラミング

- 🟡 **信頼性レベル**: 要件定義書のメッセージ検証要件から妥当推測

### TC-043-007: Service Worker停止時の状態検出

- **テスト名**: バックグラウンド処理停止時の検出とエラー表示
  - **エラーケースの概要**: chrome.runtime.sendMessage失敗によるService Worker停止検出
  - **エラー処理の重要性**: ユーザーに明確な状況説明と回復手順を提示

- **入力値**: chrome.runtime.sendMessage() のPromise reject
  - **不正な理由**: Service Worker lifecycle終了、拡張機能の更新
  - **実際の発生シナリオ**: 拡張機能の自動更新、Chromeブラウザの再起動

- **期待される結果**:
  - エラー表示: "バックグラウンド処理が停止しています。拡張機能を再読み込みしてください"
  - 状態表示: "停止中"
  - 再読み込みボタンの表示
  - **エラーメッセージの内容**: 技術的な問題と具体的な解決手順
  - **システムの安全性**: 停止状態での不正操作を防止

- **テストの目的**: Service Worker依存の適切な処理
  - **品質保証の観点**: Chrome拡張のライフサイクル問題に対する対応

- 🟡 **信頼性レベル**: 要件定義書のService Worker停止エラーケースから妥当推測

### TC-043-008: キャンセル処理の競合状態

- **テスト名**: キャンセル処理中の完了通知受信時の状態整合
  - **エラーケースの概要**: CANCEL_JOB送信とPROGRESS_UPDATE(completed)の競合
  - **エラー処理の重要性**: 状態の不整合によるUI表示混乱を防止

- **入力値**:
  1. キャンセルボタン押下（CANCEL_JOB送信）
  2. 直後にPROGRESS_UPDATE(status: 'completed')受信
  - **不正な理由**: 非同期処理のタイミング競合、ネットワーク遅延
  - **実際の発生シナリオ**: 最後の画像生成がほぼ完了時のキャンセル操作

- **期待される結果**:
  - 最終状態: "キャンセル済み"（完了ではない）
  - 処理中断の明示
  - 実際の処理状況に応じた部分結果の表示
  - **エラーメッセージの内容**: キャンセル成功と部分完了の説明
  - **システムの安全性**: 状態の論理的一貫性を保持

- **テストの目的**: 競合状態での状態管理の正確性
  - **品質保証の観点**: 非同期処理の競合に対する堅牢性

- 🟢 **信頼性レベル**: 要件定義書のキャンセル競合エッジケースに基づく

## 3. 境界値テストケース（最小値、最大値、null等）

### TC-043-009: 進捗値の境界値テスト

- **テスト名**: currentIndex・totalCountの境界値での表示確認
  - **境界値の意味**: 進捗計算の数学的な境界条件での正確性確認
  - **境界値での動作保証**: 0%、100%、および異常値での安全な処理

- **入力値**:
  ```typescript
  // 開始直後（0%）
  { currentIndex: 0, totalCount: 5 }
  // 完了（100%）
  { currentIndex: 4, totalCount: 5 }
  // 単一画像（100%）
  { currentIndex: 0, totalCount: 1 }
  ```
  - **境界値選択の根拠**: 進捗計算の数学的境界値と実際の使用パターン
  - **実際の使用場面**: 処理開始直後、完了直前、単一画像生成時

- **期待される結果**:
  - 0%: "開始準備中"表示、進捗バー0%
  - 100%: "完了"表示、進捗バー100%
  - 単一画像: 適切な0→100%の遷移
  - **境界での正確性**: 除算エラーや負値表示の回避
  - **一貫した動作**: 全境界値で同一のUI表示ロジック

- **テストの目的**: 進捗計算の数学的正確性確認
  - **堅牢性の確認**: 極端な値での計算エラー防止

- 🟢 **信頼性レベル**: 数学的計算の境界値として確定

### TC-043-010: ETA値の境界値テスト

- **テスト名**: 推定残り時間の極値での表示確認
  - **境界値の意味**: 時間表示フォーマットの境界条件での適切性
  - **境界値での動作保証**: 短時間・長時間での読みやすい表示

- **入力値**:
  ```typescript
  eta: 0,      // 完了直前
  eta: 1,      // 1秒
  eta: 59,     // 59秒
  eta: 60,     // 1分
  eta: 3600,   // 1時間
  eta: 86400   // 24時間
  ```
  - **境界値選択の根拠**: 時間単位の変換境界と実用的な生成時間範囲
  - **実際の使用場面**: 高速完了、通常処理、大量生成時

- **期待される結果**:
  - 0秒: "まもなく完了"
  - 1秒: "約1秒"
  - 59秒: "約59秒"
  - 60秒: "約1分"
  - 3600秒: "約1時間"
  - 86400秒: "約24時間"
  - **境界での正確性**: 単位変換の正確性と表示の一貫性
  - **一貫した動作**: 全時間範囲で読みやすい表示

- **テストの目的**: 時間表示フォーマットの境界条件確認
  - **堅牢性の確認**: 極端な時間値での表示品質保証

- 🟡 **信頼性レベル**: 一般的な時間表示パターンから妥当推測

### TC-043-011: メッセージ受信間隔の境界値

- **テスト名**: 500ms周期からの逸脱時の動作確認
  - **境界値の意味**: NFR-002の500ms要件に対する許容範囲の確認
  - **境界値での動作保証**: 高頻度・低頻度メッセージでのパフォーマンス

- **入力値**:
  ```typescript
  // 高頻度（100ms間隔）
  messageInterval: 100
  // 標準（500ms間隔）
  messageInterval: 500
  // 低頻度（2000ms間隔）
  messageInterval: 2000
  ```
  - **境界値選択の根拠**: NFR-002要件の500msと実際のネットワーク変動
  - **実際の使用場面**: 高負荷時の遅延、軽負荷時の高頻度更新

- **期待される結果**:
  - 100ms: UI更新の適切な間引き、パフォーマンス維持
  - 500ms: 標準動作の確認
  - 2000ms: 通信遅延の検出、警告表示
  - **境界での正確性**: 全周期でのUI応答性維持
  - **一貫した動作**: 周期変動に対する適応的な処理

- **テストの目的**: メッセージ受信周期の許容範囲確認
  - **堅牢性の確認**: ネットワーク変動に対する適応性

- 🟢 **信頼性レベル**: NFR-002要件（500ms周期）とパフォーマンス要件に基づく

### TC-043-012: null・undefined値の堅牢性テスト

- **テスト名**: PROGRESS_UPDATEメッセージの部分null値処理
  - **境界値の意味**: JavaScript環境での予期しない値に対する防御
  - **境界値での動作保証**: 部分的null値でもUI表示が破綻しない

- **入力値**:
  ```typescript
  {
    type: 'PROGRESS_UPDATE',
    currentIndex: null,
    totalCount: 5,
    status: 'generating',
    eta: undefined,
    error: null,
    timestamp: null
  }
  ```
  - **境界値選択の根拠**: JavaScriptの典型的なnull/undefined値
  - **実際の使用場面**: メッセージ変換エラー、部分的データ欠損

- **期待される結果**:
  - デフォルト値での安全なフォールバック
  - 部分的な情報でも最低限の表示を維持
  - エラーログの適切な記録
  - **境界での正確性**: null値でもアプリケーションが継続動作
  - **一貫した動作**: 全null値パターンで予測可能な挙動

- **テストの目的**: null値に対する防御的プログラミング確認
  - **堅牢性の確認**: JavaScript特有の問題に対する完全な防御

- 🟢 **信頼性レベル**: JavaScript/TypeScriptの標準的な防御パターンに基づく

## テストケース実装時の日本語コメント指針

### テストケース開始時のコメント

```typescript
// 【テスト目的】: [このテストで何を確認するかを日本語で明記]
// 【テスト内容】: [具体的にどのような処理をテストするかを説明]
// 【期待される動作】: [正常に動作した場合の結果を説明]
// 🟢🟡🔴 この内容の信頼性レベルを記載
```

### Given（準備フェーズ）のコメント

```typescript
// 【テストデータ準備】: [なぜこのデータを用意するかの理由]
// 【初期条件設定】: [テスト実行前の状態を説明]
// 【前提条件確認】: [テスト実行に必要な前提条件を明記]
```

### When（実行フェーズ）のコメント

```typescript
// 【実際の処理実行】: [どの機能/メソッドを呼び出すかを説明]
// 【処理内容】: [実行される処理の内容を日本語で説明]
// 【実行タイミング】: [なぜこのタイミングで実行するかを説明]
```

### Then（検証フェーズ）のコメント

```typescript
// 【結果検証】: [何を検証するかを具体的に説明]
// 【期待値確認】: [期待される結果とその理由を説明]
// 【品質保証】: [この検証がシステム品質にどう貢献するかを説明]
```

### 各expectステートメントのコメント

```typescript
// 【検証項目】: [この検証で確認している具体的な項目]
// 🟢🟡🔴 この内容の信頼性レベルを記載
expect(progressBar.style.width).toBe('40%'); // 【確認内容】: 進捗バーが正確に40%表示されることを確認
expect(mockSendMessage).toHaveBeenCalledWith(expectedCancelMessage); // 【確認内容】: 適切なCANCEL_JOBメッセージが送信されることを確認
```

### セットアップ・クリーンアップのコメント

```typescript
beforeEach(() => {
  // 【テスト前準備】: [各テスト実行前に行う準備作業の説明]
  // 【環境初期化】: [テスト環境をクリーンな状態にする理由と方法]
});

afterEach(() => {
  // 【テスト後処理】: [各テスト実行後に行うクリーンアップ作業の説明]
  // 【状態復元】: [次のテストに影響しないよう状態を復元する理由]
});
```

## 品質判定

✅ **高品質**:
- **テストケース分類**: 正常系・異常系・境界値が網羅されている（12テストケース）
- **期待値定義**: 各テストケースの期待値が明確（メッセージ形状、UI状態、タイミング制約）
- **技術選択**: プログラミング言語・テストフレームワークが確定（TypeScript + Vitest + Happy-DOM）
- **実装可能性**: 現在の技術スタックで実現可能（Chrome Extension環境での非同期処理テスト対応）

## TODO更新

- 現在のTODO「テストケース洗い出し」を「completed」にマーク
- テストケース定義フェーズの完了をTODO内容に反映
- 品質判定結果「高品質」をTODO内容に記録
- 次のフェーズ「Redフェーズ（失敗テスト作成）」をTODOに追加

## 次のお勧めステップ

**次のお勧めステップ**: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。