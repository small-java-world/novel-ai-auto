NovelAIè‡ªå‹•ç”»åƒç”ŸæˆChromeæ‹¡å¼µæ©Ÿèƒ½ã®è¨­è¨ˆã¨ã‚¿ã‚¹ã‚¯åˆ†è§£ã‚’è¡Œã„ã¾ã™ã€‚

## ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

NovelAIã®Web UIã‚’è‡ªå‹•åŒ–ã—ã€äº‹å‰å®šç¾©ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§è¤‡æ•°ã®ç”»åƒã‚’ç”Ÿæˆãƒ»ä¿å­˜ã™ã‚‹ç§ç”¨Chromeæ‹¡å¼µæ©Ÿèƒ½

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Chrome Extension                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Popup UI   â”‚  â”‚ Background/SW   â”‚ â”‚
â”‚  â”‚              â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ - è¨­å®šç”»é¢   â”‚  â”‚ - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸­ç¶™ â”‚ â”‚
â”‚  â”‚ - å®Ÿè¡Œãƒœã‚¿ãƒ³ â”‚  â”‚ - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰   â”‚ â”‚
â”‚  â”‚ - é€²æ—è¡¨ç¤º   â”‚  â”‚ - è¨­å®šç®¡ç†      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â†“                â†“            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      Content Script              â”‚   â”‚
â”‚  â”‚                                   â”‚   â”‚
â”‚  â”‚  - DOMæ“ä½œï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ï¼‰      â”‚   â”‚
â”‚  â”‚  - ç”Ÿæˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯             â”‚   â”‚
â”‚  â”‚  - ç”»åƒæ¤œå‡º                      â”‚   â”‚
â”‚  â”‚  - ãƒ«ãƒ¼ãƒ—åˆ¶å¾¡                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
         [NovelAI Web Interface]
```

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
novelai-auto-generator/
â”œâ”€â”€ manifest.json          # æ‹¡å¼µæ©Ÿèƒ½ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ
â”œâ”€â”€ background.js          # Service Worker
â”œâ”€â”€ content.js            # Content Script
â”œâ”€â”€ popup/
â”‚   â”œâ”€â”€ popup.html        # ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—UI
â”‚   â”œâ”€â”€ popup.js          # ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â””â”€â”€ popup.css         # ã‚¹ã‚¿ã‚¤ãƒ«
â”œâ”€â”€ config/
â”‚   â””â”€â”€ prompts.json      # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š
â””â”€â”€ utils/
    â”œâ”€â”€ dom-helper.js     # DOMæ“ä½œãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    â””â”€â”€ storage.js        # ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†
```

## ğŸ“ ã‚¿ã‚¹ã‚¯åˆ†è§£

### Phase 1: åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆåŸºç›¤æ§‹ç¯‰ï¼‰

#### Task 1.1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
```javascript
// manifest.json ã®ä½œæˆ
{
  "manifest_version": 3,
  "name": "NovelAI Auto Generator",
  "version": "1.0.0",
  "permissions": ["storage", "downloads", "tabs"],
  "host_permissions": ["https://novelai.net/*"],
  "background": {
    "service_worker": "background.js"
  },
  "content_scripts": [{
    "matches": ["https://novelai.net/*"],
    "js": ["content.js"]
  }],
  "action": {
    "default_popup": "popup/popup.html"
  }
}
```

#### Task 1.2: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
```javascript
// config/prompts.json
[
  {
    "id": "fantasy_knight",
    "name": "ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼é¨å£«",
    "positive": "{best quality}, {{masterpiece}}, {highres}, 1girl, solo, full body, princess knight costume, medieval armor, flowing cape, castle courtyard",
    "negative": "lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, cropped, worst quality, low quality",
    "settings": {
      "steps": 28,
      "scale": 5,
      "sampler": "k_euler",
      "resolution": "512x768"
    }
  }
]
```

### Phase 2: DOMæ“ä½œæ©Ÿèƒ½ï¼ˆContent Scriptï¼‰

#### Task 2.1: DOMè¦ç´ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼å®šç¾©
```javascript
// utils/dom-helper.js
const SELECTORS = {
  positivePrompt: 'textarea[placeholder*="prompt"]',
  negativePrompt: 'textarea[placeholder*="negative"]',
  generateButton: 'button:has-text("Generate")',
  generatedImage: '.generated-image-container img',
  stepsSlider: 'input[type="range"][aria-label*="steps"]',
  scaleSlider: 'input[type="range"][aria-label*="scale"]'
};

class DOMHelper {
  static async waitForElement(selector, timeout = 10000) {
    // è¦ç´ ãŒç¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
  }
  
  static setInputValue(element, value) {
    // React/Vueã‚¤ãƒ™ãƒ³ãƒˆã‚’å«ã‚€å€¤è¨­å®š
  }
}
```

#### Task 2.2: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›è‡ªå‹•åŒ–
```javascript
// content.js - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›æ©Ÿèƒ½
async function setPrompts(positive, negative) {
  const posInput = await DOMHelper.waitForElement(SELECTORS.positivePrompt);
  const negInput = await DOMHelper.waitForElement(SELECTORS.negativePrompt);
  
  DOMHelper.setInputValue(posInput, positive);
  DOMHelper.setInputValue(negInput, negative);
}
```

#### Task 2.3: è¨­å®šå€¤ã®è‡ªå‹•èª¿æ•´
```javascript
// content.js - è¨­å®šå€¤èª¿æ•´æ©Ÿèƒ½
async function applySettings(settings) {
  // Stepsè¨­å®š
  const stepsSlider = await DOMHelper.waitForElement(SELECTORS.stepsSlider);
  DOMHelper.setInputValue(stepsSlider, settings.steps);
  
  // Scaleè¨­å®š
  const scaleSlider = await DOMHelper.waitForElement(SELECTORS.scaleSlider);
  DOMHelper.setInputValue(scaleSlider, settings.scale);
  
  // è§£åƒåº¦è¨­å®šï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã¾ãŸã¯å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
  // Samplerè¨­å®š
}
```

### Phase 3: ç”Ÿæˆãƒ«ãƒ¼ãƒ—æ©Ÿèƒ½

#### Task 3.1: ç”ŸæˆçŠ¶æ…‹ç›£è¦–
```javascript
// content.js - ç”ŸæˆçŠ¶æ…‹ç›£è¦–
class GenerationMonitor {
  constructor() {
    this.isGenerating = false;
    this.observer = null;
  }
  
  async waitForCompletion() {
    return new Promise((resolve) => {
      this.observer = new MutationObserver((mutations) => {
        // æ–°ã—ã„ç”»åƒè¦ç´ ã®æ¤œå‡º
        // ã¾ãŸã¯ç”Ÿæˆãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–ã‚’æ¤œå‡º
      });
      
      this.observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true
      });
    });
  }
}
```

#### Task 3.2: è¤‡æ•°ç”»åƒç”Ÿæˆãƒ«ãƒ¼ãƒ—
```javascript
// content.js - ç”Ÿæˆãƒ«ãƒ¼ãƒ—
async function generateMultipleImages(count) {
  const monitor = new GenerationMonitor();
  
  for (let i = 0; i < count; i++) {
    console.log(`Generating image ${i + 1}/${count}`);
    
    // ç”Ÿæˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    const genButton = await DOMHelper.waitForElement(SELECTORS.generateButton);
    genButton.click();
    
    // å®Œäº†å¾…æ©Ÿ
    await monitor.waitForCompletion();
    
    // ç”»åƒä¿å­˜å‡¦ç†
    await saveGeneratedImage(i);
    
    // é€²æ—ã‚’èƒŒæ™¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«é€ä¿¡
    chrome.runtime.sendMessage({
      type: 'GENERATION_PROGRESS',
      current: i + 1,
      total: count
    });
  }
}
```

### Phase 4: ç”»åƒä¿å­˜æ©Ÿèƒ½

#### Task 4.1: ç”»åƒãƒ‡ãƒ¼ã‚¿å–å¾—
```javascript
// content.js - ç”»åƒå–å¾—
async function getLatestImage() {
  const imgElement = await DOMHelper.waitForElement(SELECTORS.generatedImage);
  
  // Data URLã¾ãŸã¯Blob URLã®å–å¾—
  if (imgElement.src.startsWith('data:')) {
    return imgElement.src;
  } else if (imgElement.src.startsWith('blob:')) {
    // Blob URLã‚’Data URLã«å¤‰æ›
    const response = await fetch(imgElement.src);
    const blob = await response.blob();
    return await blobToDataURL(blob);
  }
}
```

#### Task 4.2: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
```javascript
// background.js - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç®¡ç†
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.type === 'DOWNLOAD_IMAGE') {
    const { imageUrl, characterName, index } = request;
    
    const filename = `NovelAI/${characterName}/image_${Date.now()}_${index}.png`;
    
    chrome.downloads.download({
      url: imageUrl,
      filename: filename,
      saveAs: false
    }, (downloadId) => {
      console.log(`Downloaded: ${filename}`);
      sendResponse({ success: true, downloadId });
    });
    
    return true; // éåŒæœŸå¿œç­”ã®ãŸã‚
  }
});
```

### Phase 5: UIå®Ÿè£…ï¼ˆPopupï¼‰

#### Task 5.1: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—HTMLä½œæˆ
```html
<!-- popup/popup.html -->
<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="popup.css">
</head>
<body>
  <div class="container">
    <h2>NovelAI Auto Generator</h2>
    
    <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé¸æŠ -->
    <div class="form-group">
      <label>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚»ãƒƒãƒˆ:</label>
      <select id="promptSelect"></select>
    </div>
    
    <!-- ç”Ÿæˆæšæ•° -->
    <div class="form-group">
      <label>ç”Ÿæˆæšæ•°:</label>
      <input type="number" id="imageCount" min="1" max="100" value="10">
    </div>
    
    <!-- å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
    <button id="startBtn">ç”Ÿæˆé–‹å§‹</button>
    
    <!-- é€²æ—è¡¨ç¤º -->
    <div id="progress" class="hidden">
      <div class="progress-bar">
        <div id="progressFill"></div>
      </div>
      <span id="progressText">0/0</span>
    </div>
  </div>
  
  <script src="popup.js"></script>
</body>
</html>
```

#### Task 5.2: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯
```javascript
// popup/popup.js
class PopupController {
  constructor() {
    this.loadPrompts();
    this.bindEvents();
  }
  
  async loadPrompts() {
    const response = await fetch('../config/prompts.json');
    const prompts = await response.json();
    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ 
  }
  
  bindEvents() {
    document.getElementById('startBtn').addEventListener('click', () => {
      this.startGeneration();
    });
  }
  
  async startGeneration() {
    const selectedPrompt = this.getSelectedPrompt();
    const imageCount = document.getElementById('imageCount').value;
    
    // Content Scriptã«é€ä¿¡
    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
    chrome.tabs.sendMessage(tab.id, {
      type: 'START_GENERATION',
      prompt: selectedPrompt,
      count: imageCount
    });
  }
}
```

### Phase 6: çµ±åˆã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### Task 6.1: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°çµ±åˆ
```javascript
// content.js - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  switch(request.type) {
    case 'START_GENERATION':
      handleGenerationStart(request);
      break;
    case 'STOP_GENERATION':
      handleGenerationStop();
      break;
  }
});

async function handleGenerationStart({ prompt, count }) {
  try {
    await setPrompts(prompt.positive, prompt.negative);
    await applySettings(prompt.settings);
    await generateMultipleImages(count);
    
    chrome.runtime.sendMessage({ type: 'GENERATION_COMPLETE' });
  } catch (error) {
    chrome.runtime.sendMessage({ 
      type: 'GENERATION_ERROR',
      error: error.message 
    });
  }
}
```

#### Task 6.2: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªãƒˆãƒ©ã‚¤
```javascript
// utils/retry-helper.js
async function retryWithBackoff(fn, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
    }
  }
}
```

## ğŸ”„ å®Ÿè£…å„ªå…ˆé †ä½

1. **æœ€å„ªå…ˆï¼ˆMVPï¼‰**
   - Task 1.1, 1.2: åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
   - Task 2.1, 2.2: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›è‡ªå‹•åŒ–
   - Task 3.2: å˜ç´”ãªç”Ÿæˆãƒ«ãƒ¼ãƒ—

2. **é«˜å„ªå…ˆåº¦**
   - Task 4.1, 4.2: ç”»åƒä¿å­˜æ©Ÿèƒ½
   - Task 5.1, 5.2: åŸºæœ¬çš„ãªUI

3. **ä¸­å„ªå…ˆåº¦**
   - Task 2.3: è©³ç´°è¨­å®šã®è‡ªå‹•èª¿æ•´
   - Task 3.1: é«˜åº¦ãªç”ŸæˆçŠ¶æ…‹ç›£è¦–
   - Task 6.1: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°çµ±åˆ

4. **ä½å„ªå…ˆåº¦**
   - Task 6.2: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
   - è¿½åŠ æ©Ÿèƒ½ï¼ˆãƒãƒƒãƒå‡¦ç†ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ç­‰ï¼‰

ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€æ®µéšçš„ã«æ©Ÿèƒ½ã‚’å®Ÿè£…ã§ãã€å„ãƒ•ã‚§ãƒ¼ã‚ºã§å‹•ä½œç¢ºèªã—ãªãŒã‚‰é–‹ç™ºã‚’é€²ã‚ã‚‰ã‚Œã¾ã™ã€‚