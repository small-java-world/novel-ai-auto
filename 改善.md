# æ”¹å–„è¨ˆç”»æ›¸ - NovelAI Auto Generator

## æ¦‚è¦

TASK-000å®Œäº†å¾Œã®æ”¹å–„ç‚¹ã¨Next Stepsã‚’æ•´ç†ã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚TypeScript + Vitestç’°å¢ƒã§ã®å®Ÿè£…å“è³ªå‘ä¸Šã‚’ç›®æŒ‡ã™ã€‚

## å®Œäº†æ¸ˆã¿é …ç›® âœ…

### TASK-000: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã¨åŸºæœ¬ãƒ„ãƒ¼ãƒ«è¨­å®š

- [x] Manifest V3å¯¾å¿œã®Chromeæ‹¡å¼µæ©Ÿèƒ½åŸºç›¤æ§‹ç¯‰
- [x] TypeScript + Vitestã«ã‚ˆã‚‹é–‹ç™ºç’°å¢ƒæ§‹ç¯‰
- [x] ESLint + Prettierã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰å“è³ªç®¡ç†
- [x] åŸºæœ¬çš„ãªService Workerã€Content Scriptã€Popup UIå®Ÿè£…
- [x] Chrome API ãƒ¢ãƒƒã‚¯ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆåŸºç›¤æ§‹ç¯‰
- [x] å‹å®‰å…¨æ€§ã‚’é‡è¦–ã—ãŸTypeScriptè¨­å®š

## ç·Šæ€¥æ”¹å–„é …ç›® ğŸ”´

### 1. å‹å®‰å…¨æ€§ã®å¤§å¹…å‘ä¸Š

ç¾åœ¨ã®`any`å‹å¤šç”¨ã‚’å³å¯†ãªå‹å®šç¾©ã«ç½®ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

#### ä¿®æ­£ã™ã¹ãå•é¡Œç‚¹:

```typescript
// ç¾åœ¨: anyå‹ã®å¤šç”¨ - å±é™º
function handleMessage(message: any, sender: any, sendResponse: any)
chrome.tabs.sendMessage(tabId, message: any)

// æ”¹å–„å¾Œ: å³å¯†ãªå‹å®šç¾©
interface ChromeMessage {
  type: MessageType;
  payload: MessagePayload;
  correlationId: string;
}

function handleMessage(
  message: ChromeMessage,
  sender: chrome.runtime.MessageSender,
  sendResponse: (response: MessageResponse) => void
)
```

### 2. DOMæ“ä½œã®å …ç‰¢æ€§

ç¾åœ¨ã®ã‚»ãƒ¬ã‚¯ã‚¿æˆ¦ç•¥ã¯å˜ç´”ã™ãã¦NovelAI UIã®å¤‰æ›´ã«è„†å¼±ã€‚

#### ç¾åœ¨ã®å•é¡Œ:

```typescript
// é™çš„ãªã‚»ãƒ¬ã‚¯ã‚¿é…åˆ— - è„†å¼±
const generateSelectors = ['button[type="submit"]', 'button[data-testid="generate-button"]'];

// ===== ç”»åƒç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ =====
export type SeedMode = 'fixed' | 'random';
export type Sampler =
  | 'k_euler'
  | 'k_euler_a'
  | 'k_dpmpp_2m'
  | 'k_dpmpp_2s_ancestral'
  | 'k_dpm_2'
  | 'k_lms';

export interface GenerationParams {
  steps: number; // 1..100
  sampler: Sampler;
  cfgScale: number; // 1..30
  width: number; // 64..2048
  height: number; // 64..2048
  seedMode: SeedMode;
  seed?: number; // seedMode=fixed ã®ã¨ãå¿…é ˆ
  count: number; // 1..999 ï¼ˆãƒãƒƒãƒæšæ•°ï¼‰
}

// ===== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ»ãƒ—ãƒªã‚»ãƒƒãƒˆ =====
export interface PromptPreset {
  id: UUID;
  name: string;
  prompt: string;
  negative?: string;
  params?: Partial<GenerationParams>;
}

// ===== è¨­å®š =====
export interface RetryPolicy {
  maxAttempts: number; // ä¾‹: 5
  baseDelayMs: number; // ä¾‹: 500
  factor: number; // ä¾‹: 2.0
  maxDelayMs?: number; // ä¾‹: 30000
}

export interface Accessibility {
  highContrast?: boolean;
  keyboardOnly?: boolean;
}

export interface Settings {
  defaultPresetId?: UUID;
  output: {
    subdir: string; // ä¾‹: "Ardis"
    // å‘½åè¦ç´„: {paramhash} ã‚’å¿…ãšå«ã‚ã‚‹
    filePattern: string; // ä¾‹: "{Character}/{yyyy-MM-dd}/{Character}_{seed|rand}_{###}_{paramhash}.png"
  };
  retry: RetryPolicy;
  accessibility?: Accessibility;
}

// ===== ã‚¸ãƒ§ãƒ– =====
export type JobStatus =
  | 'pending'
  | 'running'
  | 'waiting'
  | 'paused'
  | 'completed'
  | 'error'
  | 'cancelled';

export interface GenerationJob {
  id: UUID;
  presetId: UUID;
  params: GenerationParams;
  status: JobStatus;
  createdAt: Timestamp;
  updatedAt: Timestamp;
  progress?: { done: number; total: number }; // ä¾‹: 3/10
  lastError?: { code: ErrorCode; message: string; details?: unknown };
}

// ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆåˆ¤åˆ¥å¯èƒ½å…±ç”¨ä½“ï¼‰ =====
export type ProtocolVersion = '1.0';

export type ErrorCode =
  | 'DOM_NOT_FOUND'
  | 'TIMEOUT'
  | 'OFFLINE'
  | 'DOWNLOAD_DENIED'
  | 'STORAGE_ERROR'
  | 'VALIDATION_ERROR';

interface BaseMsg<T extends string, P> {
  type: T;
  protocolVersion: ProtocolVersion;
  correlationId: UUID;
  payload: P;
}

// Popup -> SW
export type StartGenerationMsg = BaseMsg<
  'START_GENERATION',
  {
    job: GenerationJob;
  }
>;

// SW -> CS
export type ApplyAndGenerateMsg = BaseMsg<
  'APPLY_AND_GENERATE',
  {
    jobId: UUID;
    params: GenerationParams;
    prompt: string;
    negative?: string;
  }
>;

// CS -> SW
export type ProgressUpdateMsg = BaseMsg<
  'PROGRESS_UPDATE',
  {
    jobId: UUID;
    done: number;
    total: number;
  }
>;

export type ImageReadyMsg = BaseMsg<
  'IMAGE_READY',
  {
    jobId: UUID;
    imageUrl: string;
    index: number;
  }
>;

// SW å†…éƒ¨ â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‘½ä»¤
export type DownloadImageMsg = BaseMsg<
  'DOWNLOAD_IMAGE',
  {
    jobId: UUID;
    imageUrl: string;
    filename: string;
  }
>;

// SW -> Tabs
export type OpenOrFocusTabMsg = BaseMsg<'OPEN_OR_FOCUS_TAB', { url: string }>;

// ä»»æ„ -> SW
export type ErrorMsg = BaseMsg<
  'ERROR',
  {
    jobId?: UUID;
    code: ErrorCode;
    message: string;
    details?: unknown;
  }
>;

export type AnyMsg =
  | StartGenerationMsg
  | ApplyAndGenerateMsg
  | ProgressUpdateMsg
  | ImageReadyMsg
  | DownloadImageMsg
  | OpenOrFocusTabMsg
  | ErrorMsg;

// ===== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è«–ç†ãƒ¢ãƒ‡ãƒ« =====
export interface LogEntry {
  ts: Timestamp;
  level: 'info' | 'warn' | 'error';
  msg: string;
  ctx?: Record<string, unknown>;
}

export interface StorageModel {
  settings: Settings;
  presets: PromptPreset[];
  jobs: Record<UUID, GenerationJob>;
  logs: LogEntry[]; // ãƒªãƒ³ã‚°ãƒãƒƒãƒ•ã‚¡ä¸Šé™ã¯å®Ÿè£…å´ã§åˆ¶å¾¡
}
```

---

# 2) `src/lib/filename.ts`

```ts
// src/lib/filename.ts
export type PatternVars = {
  character: string;
  seed?: number;
  n: number;
  date: Date;
  paramsHash: string; // ã‚½ãƒ¼ãƒˆJSONâ†’SHA1ã®å…ˆé ­4å­—ãªã©ã€ç®—å‡ºã¯åˆ¥é–¢æ•°ã§
};

export function buildFilename(pattern: string, v: PatternVars) {
  const pad3 = (x: number) => String(x).padStart(3, '0');
  const yyyyMMdd = v.date.toISOString().slice(0, 10);
  return pattern
    .replaceAll('{Character}', v.character)
    .replaceAll('{yyyy-MM-dd}', yyyyMMdd)
    .replaceAll('{seed|rand}', v.seed != null ? String(v.seed) : 'rand')
    .replaceAll('{###}', pad3(v.n))
    .replaceAll('{paramhash}', v.paramsHash);
}

// ä»•æ§˜ãƒ†ã‚¹ãƒˆç”¨ã®æ­£è¦è¡¨ç¾ï¼ˆDoneå®šç¾©ã®è‡ªå‹•åˆ¤å®šã«ä½¿ãˆã‚‹ï¼‰
export const FILENAME_REGEX =
  /^(?<char>[^/\\]+)\/\d{4}-\d{2}-\d{2}\/\1_(?:\d+|rand)_\d{3}_[0-9a-f]{4}\.png$/;
```

---

# 3) `src/lib/retry.ts`

```ts
// src/lib/retry.ts
import type { RetryPolicy } from '@/interfaces';

export function* backoff(p: RetryPolicy): Generator<number, void, unknown> {
  const cap = p.maxDelayMs ?? Infinity;
  let delay = p.baseDelayMs;
  for (let i = 0; i < p.maxAttempts; i++) {
    yield Math.min(delay, cap);
    delay = Math.min(delay * p.factor, cap);
  }
}
```

---

# 4) `src/lib/schema.ts`ï¼ˆZod ã§å®Ÿå€¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

```ts
// src/lib/schema.ts
import { z } from 'zod';

export const GenerationParamsZ = z
  .object({
    steps: z.number().int().min(1).max(100),
    sampler: z.string().min(1),
    cfgScale: z.number().min(1).max(30),
    width: z.number().int().min(64).max(2048),
    height: z.number().int().min(64).max(2048),
    seedMode: z.enum(['fixed', 'random']),
    seed: z.number().int().optional(),
    count: z.number().int().min(1).max(999),
  })
  .refine((v) => (v.seedMode === 'fixed' ? v.seed != null : true), {
    message: 'seed required when seedMode=fixed',
  });

export const SettingsZ = z.object({
  defaultPresetId: z.string().optional(),
  output: z.object({
    subdir: z.string().min(1),
    // å‘½åè¦ç´„ã‚’å‹ã§å¼·åˆ¶
    filePattern: z.string().includes('{paramhash}'),
  }),
  retry: z.object({
    maxAttempts: z.number().int().min(1).max(10),
    baseDelayMs: z.number().int().min(0),
    factor: z.number().min(1),
    maxDelayMs: z.number().int().optional(),
  }),
  accessibility: z
    .object({
      highContrast: z.boolean().optional(),
      keyboardOnly: z.boolean().optional(),
    })
    .optional(),
});

export type SettingsInferred = z.infer<typeof SettingsZ>;
```

---

# 5) ãƒ†ã‚¹ãƒˆå‘¨ã‚Šï¼ˆVitestï¼‰

## 5-1) å…±é€šãƒ¢ãƒƒã‚¯ `tests/setup.chrome.ts`

```ts
// tests/setup.chrome.ts
import { vi } from 'vitest';

(globalThis as any).chrome = {
  runtime: {
    sendMessage: vi.fn((_msg: any, cb?: any) => cb && cb({ ok: true })),
    onMessage: { addListener: vi.fn() },
  },
  downloads: {
    download: vi.fn((_opts: any, cb?: any) => cb && cb(42)),
  },
  action: {
    setBadgeText: vi.fn(),
    setBadgeBackgroundColor: vi.fn(),
  },
  storage: {
    local: { get: vi.fn(async () => ({})), set: vi.fn(async () => {}) },
    sync: { get: vi.fn(async () => ({})), set: vi.fn(async () => {}) },
  },
} as unknown as typeof chrome;
```

## 5-2) `tests/filename.test.ts`

```ts
import { describe, it, expect } from 'vitest';
import { buildFilename, FILENAME_REGEX } from '@/lib/filename';

describe('buildFilename', () => {
  it('deterministic and well-formed', () => {
    const name = buildFilename(
      '{Character}/{yyyy-MM-dd}/{Character}_{seed|rand}_{###}_{paramhash}.png',
      {
        character: 'Ardis',
        seed: 123,
        n: 7,
        date: new Date('2025-09-14T00:00:00Z'),
        paramsHash: 'a1b2',
      }
    );
    expect(name).toBe('Ardis/2025-09-14/Ardis_123_007_a1b2.png');
    expect(FILENAME_REGEX.test(name)).toBe(true);
  });

  it('uses rand when seed is absent', () => {
    const name = buildFilename(
      '{Character}/{yyyy-MM-dd}/{Character}_{seed|rand}_{###}_{paramhash}.png',
      { character: 'Ardis', n: 1, date: new Date('2025-09-14T00:00:00Z'), paramsHash: 'dead' }
    );
    expect(name).toBe('Ardis/2025-09-14/Ardis_rand_001_dead.png');
    expect(FILENAME_REGEX.test(name)).toBe(true);
  });
});
```

## 5-3) `tests/retry.test.ts`

```ts
import { describe, it, expect } from 'vitest';
import { backoff } from '@/lib/retry';

describe('backoff', () => {
  it('yields capped exponential delays', () => {
    const delays = Array.from(
      backoff({ maxAttempts: 5, baseDelayMs: 1000, factor: 2, maxDelayMs: 5000 })
    );
    expect(delays).toEqual([1000, 2000, 4000, 5000, 5000]); // cap at 5s
  });
});
```

> â€» E2E ãƒ¢ãƒƒã‚¯ï¼ˆcontentâ†’SWâ†’downloadsï¼‰ã¯ã€å®Ÿè£…ãŒå‡ºæƒã„æ¬¡ç¬¬ã§è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚`chrome.downloads.download` å‘¼ã³å‡ºã—å›æ•°ã¨ `filename` ã®æ­£è¦è¡¨ç¾ä¸€è‡´ã§ **Doneå®šç¾©ã‚’è‡ªå‹•åˆ¤å®š**ã§ãã¾ã™ã€‚

---

# 6) æœ€ä½é™ã®è¨­å®š

## `vitest.config.ts`

```ts
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    environment: 'jsdom',
    setupFiles: ['./tests/setup.chrome.ts'],
    coverage: { reporter: ['text', 'html'], lines: 85, functions: 85, branches: 80 },
    restoreMocks: true,
    clearMocks: true,
    fakeTimers: { toFake: ['setTimeout', 'clearTimeout'] },
  },
  resolve: { alias: { '@': '/src' } },
});
```

## `tsconfig.json`ï¼ˆå·®åˆ†ã®ç›®å®‰ï¼‰

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "strict": true,
    "baseUrl": ".",
    "paths": { "@/*": ["src/*"] },
    "types": ["vitest/globals"]
  },
  "include": ["src", "tests"]
}
```

---

# 7) ä½¿ã„æ–¹ï¼ˆåˆæ„æ¸ˆã¿ä»•æ§˜ã«ãƒ•ã‚£ãƒƒãƒˆï¼‰

- `Settings.output.filePattern` ã®æ—¢å®šå€¤ã‚’
  **`{Character}/{yyyy-MM-dd}/{Character}_{seed|rand}_{###}_{paramhash}.png`** ã«è¨­å®šã€‚
- `paramsHash` ã®ç®—å‡ºã¯ **ã€Œä¸»è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆsteps/sampler/width/height/cfgScale/seedMode/seed\[ä»»æ„]/overridesï¼‰ã€ã®**
  **ã‚½ãƒ¼ãƒˆ JSON â†’ SHA1 â†’ å…ˆé ­4æ–‡å­—**ã‚’æ¨å¥¨ï¼ˆå®Ÿè£…ã¯SWå´ã§OKï¼‰ã€‚
  â€» ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆMV3ï¼‰ã¯ `crypto.subtle.digest`ã€Node/Vitest ã¯ `crypto.createHash('sha1')` ã‚’ä½¿ãˆã°OKã€‚

---

å¿…è¦ãªã‚‰ã€ã“ã®ãƒ‘ãƒƒãƒã«åˆã‚ã›ã¦ \*\*SW/CS å´ã®å‘¼ã³å‡ºã—é››å½¢ï¼ˆ`DOWNLOAD_IMAGE` ã¾ã§ã®å¾€å¾©ï¼‰\*\*ã‚‚ã™ãæ›¸ãè¶³ã—ã¾ã™ã€‚
ã¾ãšã¯ã“ã® 4 ãƒ•ã‚¡ã‚¤ãƒ«ï¼‹ãƒ†ã‚¹ãƒˆã‚’å…¥ã‚Œã¦ã€**å‘½åè¦ç´„ãƒ»ãƒªãƒˆãƒ©ã‚¤ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®åœŸå°**ã‚’å›ºã‚ã‚ˆã†ã€‚
