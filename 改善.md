# 改善計画書 - NovelAI Auto Generator

## 概要

TASK-000完了後の改善点とNext Stepsを整理したドキュメント。TypeScript + Vitest環境での実装品質向上を目指す。

## 完了済み項目 ✅

### TASK-000: プロジェクト構成と基本ツール設定

- [x] Manifest V3対応のChrome拡張機能基盤構築
- [x] TypeScript + Vitestによる開発環境構築
- [x] ESLint + Prettierによるコード品質管理
- [x] 基本的なService Worker、Content Script、Popup UI実装
- [x] Chrome API モック環境でのテスト基盤構築
- [x] 型安全性を重視したTypeScript設定

## 緊急改善項目 🔴

### 1. 型安全性の大幅向上

現在の`any`型多用を厳密な型定義に置き換える必要がある。

#### 修正すべき問題点:

```typescript
// 現在: any型の多用 - 危険
function handleMessage(message: any, sender: any, sendResponse: any)
chrome.tabs.sendMessage(tabId, message: any)

// 改善後: 厳密な型定義
interface ChromeMessage {
  type: MessageType;
  payload: MessagePayload;
  correlationId: string;
}

function handleMessage(
  message: ChromeMessage,
  sender: chrome.runtime.MessageSender,
  sendResponse: (response: MessageResponse) => void
)
```

### 2. DOM操作の堅牢性

現在のセレクタ戦略は単純すぎてNovelAI UIの変更に脆弱。

#### 現在の問題:

```typescript
// 静的なセレクタ配列 - 脆弱
const generateSelectors = ['button[type="submit"]', 'button[data-testid="generate-button"]'];

// ===== 画像生成パラメータ =====
export type SeedMode = 'fixed' | 'random';
export type Sampler =
  | 'k_euler'
  | 'k_euler_a'
  | 'k_dpmpp_2m'
  | 'k_dpmpp_2s_ancestral'
  | 'k_dpm_2'
  | 'k_lms';

export interface GenerationParams {
  steps: number; // 1..100
  sampler: Sampler;
  cfgScale: number; // 1..30
  width: number; // 64..2048
  height: number; // 64..2048
  seedMode: SeedMode;
  seed?: number; // seedMode=fixed のとき必須
  count: number; // 1..999 （バッチ枚数）
}

// ===== プロンプト・プリセット =====
export interface PromptPreset {
  id: UUID;
  name: string;
  prompt: string;
  negative?: string;
  params?: Partial<GenerationParams>;
}

// ===== 設定 =====
export interface RetryPolicy {
  maxAttempts: number; // 例: 5
  baseDelayMs: number; // 例: 500
  factor: number; // 例: 2.0
  maxDelayMs?: number; // 例: 30000
}

export interface Accessibility {
  highContrast?: boolean;
  keyboardOnly?: boolean;
}

export interface Settings {
  defaultPresetId?: UUID;
  output: {
    subdir: string; // 例: "Ardis"
    // 命名規約: {paramhash} を必ず含める
    filePattern: string; // 例: "{Character}/{yyyy-MM-dd}/{Character}_{seed|rand}_{###}_{paramhash}.png"
  };
  retry: RetryPolicy;
  accessibility?: Accessibility;
}

// ===== ジョブ =====
export type JobStatus =
  | 'pending'
  | 'running'
  | 'waiting'
  | 'paused'
  | 'completed'
  | 'error'
  | 'cancelled';

export interface GenerationJob {
  id: UUID;
  presetId: UUID;
  params: GenerationParams;
  status: JobStatus;
  createdAt: Timestamp;
  updatedAt: Timestamp;
  progress?: { done: number; total: number }; // 例: 3/10
  lastError?: { code: ErrorCode; message: string; details?: unknown };
}

// ===== メッセージ（判別可能共用体） =====
export type ProtocolVersion = '1.0';

export type ErrorCode =
  | 'DOM_NOT_FOUND'
  | 'TIMEOUT'
  | 'OFFLINE'
  | 'DOWNLOAD_DENIED'
  | 'STORAGE_ERROR'
  | 'VALIDATION_ERROR';

interface BaseMsg<T extends string, P> {
  type: T;
  protocolVersion: ProtocolVersion;
  correlationId: UUID;
  payload: P;
}

// Popup -> SW
export type StartGenerationMsg = BaseMsg<
  'START_GENERATION',
  {
    job: GenerationJob;
  }
>;

// SW -> CS
export type ApplyAndGenerateMsg = BaseMsg<
  'APPLY_AND_GENERATE',
  {
    jobId: UUID;
    params: GenerationParams;
    prompt: string;
    negative?: string;
  }
>;

// CS -> SW
export type ProgressUpdateMsg = BaseMsg<
  'PROGRESS_UPDATE',
  {
    jobId: UUID;
    done: number;
    total: number;
  }
>;

export type ImageReadyMsg = BaseMsg<
  'IMAGE_READY',
  {
    jobId: UUID;
    imageUrl: string;
    index: number;
  }
>;

// SW 内部 → ダウンロード命令
export type DownloadImageMsg = BaseMsg<
  'DOWNLOAD_IMAGE',
  {
    jobId: UUID;
    imageUrl: string;
    filename: string;
  }
>;

// SW -> Tabs
export type OpenOrFocusTabMsg = BaseMsg<'OPEN_OR_FOCUS_TAB', { url: string }>;

// 任意 -> SW
export type ErrorMsg = BaseMsg<
  'ERROR',
  {
    jobId?: UUID;
    code: ErrorCode;
    message: string;
    details?: unknown;
  }
>;

export type AnyMsg =
  | StartGenerationMsg
  | ApplyAndGenerateMsg
  | ProgressUpdateMsg
  | ImageReadyMsg
  | DownloadImageMsg
  | OpenOrFocusTabMsg
  | ErrorMsg;

// ===== ストレージ論理モデル =====
export interface LogEntry {
  ts: Timestamp;
  level: 'info' | 'warn' | 'error';
  msg: string;
  ctx?: Record<string, unknown>;
}

export interface StorageModel {
  settings: Settings;
  presets: PromptPreset[];
  jobs: Record<UUID, GenerationJob>;
  logs: LogEntry[]; // リングバッファ上限は実装側で制御
}
```

---

# 2) `src/lib/filename.ts`

```ts
// src/lib/filename.ts
export type PatternVars = {
  character: string;
  seed?: number;
  n: number;
  date: Date;
  paramsHash: string; // ソートJSON→SHA1の先頭4字など、算出は別関数で
};

export function buildFilename(pattern: string, v: PatternVars) {
  const pad3 = (x: number) => String(x).padStart(3, '0');
  const yyyyMMdd = v.date.toISOString().slice(0, 10);
  return pattern
    .replaceAll('{Character}', v.character)
    .replaceAll('{yyyy-MM-dd}', yyyyMMdd)
    .replaceAll('{seed|rand}', v.seed != null ? String(v.seed) : 'rand')
    .replaceAll('{###}', pad3(v.n))
    .replaceAll('{paramhash}', v.paramsHash);
}

// 仕様テスト用の正規表現（Done定義の自動判定に使える）
export const FILENAME_REGEX =
  /^(?<char>[^/\\]+)\/\d{4}-\d{2}-\d{2}\/\1_(?:\d+|rand)_\d{3}_[0-9a-f]{4}\.png$/;
```

---

# 3) `src/lib/retry.ts`

```ts
// src/lib/retry.ts
import type { RetryPolicy } from '@/interfaces';

export function* backoff(p: RetryPolicy): Generator<number, void, unknown> {
  const cap = p.maxDelayMs ?? Infinity;
  let delay = p.baseDelayMs;
  for (let i = 0; i < p.maxAttempts; i++) {
    yield Math.min(delay, cap);
    delay = Math.min(delay * p.factor, cap);
  }
}
```

---

# 4) `src/lib/schema.ts`（Zod で実値バリデーション）

```ts
// src/lib/schema.ts
import { z } from 'zod';

export const GenerationParamsZ = z
  .object({
    steps: z.number().int().min(1).max(100),
    sampler: z.string().min(1),
    cfgScale: z.number().min(1).max(30),
    width: z.number().int().min(64).max(2048),
    height: z.number().int().min(64).max(2048),
    seedMode: z.enum(['fixed', 'random']),
    seed: z.number().int().optional(),
    count: z.number().int().min(1).max(999),
  })
  .refine((v) => (v.seedMode === 'fixed' ? v.seed != null : true), {
    message: 'seed required when seedMode=fixed',
  });

export const SettingsZ = z.object({
  defaultPresetId: z.string().optional(),
  output: z.object({
    subdir: z.string().min(1),
    // 命名規約を型で強制
    filePattern: z.string().includes('{paramhash}'),
  }),
  retry: z.object({
    maxAttempts: z.number().int().min(1).max(10),
    baseDelayMs: z.number().int().min(0),
    factor: z.number().min(1),
    maxDelayMs: z.number().int().optional(),
  }),
  accessibility: z
    .object({
      highContrast: z.boolean().optional(),
      keyboardOnly: z.boolean().optional(),
    })
    .optional(),
});

export type SettingsInferred = z.infer<typeof SettingsZ>;
```

---

# 5) テスト周り（Vitest）

## 5-1) 共通モック `tests/setup.chrome.ts`

```ts
// tests/setup.chrome.ts
import { vi } from 'vitest';

(globalThis as any).chrome = {
  runtime: {
    sendMessage: vi.fn((_msg: any, cb?: any) => cb && cb({ ok: true })),
    onMessage: { addListener: vi.fn() },
  },
  downloads: {
    download: vi.fn((_opts: any, cb?: any) => cb && cb(42)),
  },
  action: {
    setBadgeText: vi.fn(),
    setBadgeBackgroundColor: vi.fn(),
  },
  storage: {
    local: { get: vi.fn(async () => ({})), set: vi.fn(async () => {}) },
    sync: { get: vi.fn(async () => ({})), set: vi.fn(async () => {}) },
  },
} as unknown as typeof chrome;
```

## 5-2) `tests/filename.test.ts`

```ts
import { describe, it, expect } from 'vitest';
import { buildFilename, FILENAME_REGEX } from '@/lib/filename';

describe('buildFilename', () => {
  it('deterministic and well-formed', () => {
    const name = buildFilename(
      '{Character}/{yyyy-MM-dd}/{Character}_{seed|rand}_{###}_{paramhash}.png',
      {
        character: 'Ardis',
        seed: 123,
        n: 7,
        date: new Date('2025-09-14T00:00:00Z'),
        paramsHash: 'a1b2',
      }
    );
    expect(name).toBe('Ardis/2025-09-14/Ardis_123_007_a1b2.png');
    expect(FILENAME_REGEX.test(name)).toBe(true);
  });

  it('uses rand when seed is absent', () => {
    const name = buildFilename(
      '{Character}/{yyyy-MM-dd}/{Character}_{seed|rand}_{###}_{paramhash}.png',
      { character: 'Ardis', n: 1, date: new Date('2025-09-14T00:00:00Z'), paramsHash: 'dead' }
    );
    expect(name).toBe('Ardis/2025-09-14/Ardis_rand_001_dead.png');
    expect(FILENAME_REGEX.test(name)).toBe(true);
  });
});
```

## 5-3) `tests/retry.test.ts`

```ts
import { describe, it, expect } from 'vitest';
import { backoff } from '@/lib/retry';

describe('backoff', () => {
  it('yields capped exponential delays', () => {
    const delays = Array.from(
      backoff({ maxAttempts: 5, baseDelayMs: 1000, factor: 2, maxDelayMs: 5000 })
    );
    expect(delays).toEqual([1000, 2000, 4000, 5000, 5000]); // cap at 5s
  });
});
```

> ※ E2E モック（content→SW→downloads）は、実装が出揃い次第で追加しましょう。`chrome.downloads.download` 呼び出し回数と `filename` の正規表現一致で **Done定義を自動判定**できます。

---

# 6) 最低限の設定

## `vitest.config.ts`

```ts
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    environment: 'jsdom',
    setupFiles: ['./tests/setup.chrome.ts'],
    coverage: { reporter: ['text', 'html'], lines: 85, functions: 85, branches: 80 },
    restoreMocks: true,
    clearMocks: true,
    fakeTimers: { toFake: ['setTimeout', 'clearTimeout'] },
  },
  resolve: { alias: { '@': '/src' } },
});
```

## `tsconfig.json`（差分の目安）

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "strict": true,
    "baseUrl": ".",
    "paths": { "@/*": ["src/*"] },
    "types": ["vitest/globals"]
  },
  "include": ["src", "tests"]
}
```

---

# 7) 使い方（合意済み仕様にフィット）

- `Settings.output.filePattern` の既定値を
  **`{Character}/{yyyy-MM-dd}/{Character}_{seed|rand}_{###}_{paramhash}.png`** に設定。
- `paramsHash` の算出は **「主要パラメータ（steps/sampler/width/height/cfgScale/seedMode/seed\[任意]/overrides）」の**
  **ソート JSON → SHA1 → 先頭4文字**を推奨（実装はSW側でOK）。
  ※ ブラウザ（MV3）は `crypto.subtle.digest`、Node/Vitest は `crypto.createHash('sha1')` を使えばOK。

---

必要なら、このパッチに合わせて \*\*SW/CS 側の呼び出し雛形（`DOWNLOAD_IMAGE` までの往復）\*\*もすぐ書き足します。
まずはこの 4 ファイル＋テストを入れて、**命名規約・リトライ・バリデーションの土台**を固めよう。
