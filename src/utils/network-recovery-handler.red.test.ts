// ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: src/utils/network-recovery-handler.red.test.ts
import { describe, test, expect, beforeEach, afterEach, vi } from 'vitest';
import { guardRejection } from '../../test/helpers';

// ã€ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ¦‚è¦ã€‘: TASK-071 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³/å¾©å¸°ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ©Ÿèƒ½ã®å¤±æ•—ãƒ†ã‚¹ãƒˆã‚’ä½œæˆï¼ˆTDD Red ãƒ•ã‚§ãƒ¼ã‚ºï¼‰
// ã€å¯¾è±¡æ©Ÿèƒ½ã€‘: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ç›£è¦–ã€ã‚¸ãƒ§ãƒ–ä¸€æ™‚åœæ­¢ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã®è‡ªå‹•å†é–‹

// Navigator API ã®ãƒ¢ãƒƒã‚¯è¨­å®š
const mockNavigator = {
  onLine: true,
};

// Chrome API ã®ãƒ¢ãƒƒã‚¯è¨­å®š
const mockChrome = {
  runtime: {
    sendMessage: vi.fn(),
  },
  storage: {
    local: {
      get: vi.fn(),
      set: vi.fn(),
      remove: vi.fn(),
    },
  },
  tabs: {
    query: vi.fn(),
    sendMessage: vi.fn(),
  },
};

// ã‚°ãƒ­ãƒ¼ãƒãƒ« navigator ã¨ chrome ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ¢ãƒƒã‚¯
(globalThis as any).navigator = mockNavigator;
(globalThis as any).chrome = mockChrome;

// ã€æœªå®Ÿè£…ã€‘: TDD Red ãƒ•ã‚§ãƒ¼ã‚ºã®ãŸã‚ã€ä»¥ä¸‹ã®é–¢æ•°ã¯æœªå®Ÿè£…ï¼ˆæ„å›³çš„ã«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ï¼‰
import {
  NetworkRecoveryHandler,
  detectNetworkStateChange,
  pauseJobsOnOffline,
  resumeJobsOnOnline,
  handleFlappingPrevention,
  stageResumeMultipleJobs
} from './network-recovery-handler';

describe('NetworkRecoveryHandler - TASK-071 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³/å¾©å¸°ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°', () => {
  beforeEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ã‚¯ãƒªãƒ¼ãƒ³ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã—ã€ä¸€è²«ã—ãŸãƒ†ã‚¹ãƒˆæ¡ä»¶ã‚’ä¿è¨¼
    // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: å‰ã®ãƒ†ã‚¹ãƒˆã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã¨ãƒ¢ãƒƒã‚¯å‘¼ã³å‡ºã—å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
    mockNavigator.onLine = true;
    vi.clearAllMocks();
    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹å¤‰åŒ–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
    global.dispatchEvent = vi.fn();
  });

  afterEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†ã€‘: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    // ã€çŠ¶æ…‹å¾©å…ƒã€‘: æ¬¡ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã®çŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
    mockNavigator.onLine = true;
    vi.clearAllMocks();
  });

  describe('æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆåŸºæœ¬çš„ãªå‹•ä½œï¼‰', () => {
    test('TC-071-001: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹å¤‰åŒ–ã‚’æ­£ã—ãæ¤œå‡ºã—ã€é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: navigator.onLineã®å¤‰åŒ–ç›£è¦–ã¨offlineã‚¤ãƒ™ãƒ³ãƒˆã®æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹å¤‰åŒ–ã®æ¤œå‡ºã¨NETWORK_STATE_CHANGEDãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡å‡¦ç†
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: çŠ¶æ…‹å¤‰åŒ–ã‚’æ­£ç¢ºã«æ¤œå‡ºã—ã€å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚¸ãƒ§ãƒ–ã‚’ç‰¹å®šã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡ã•ã‚Œã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: è¦ä»¶å®šç¾©ã®NetworkStateMessageå‹å®šç¾©ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: WiFiåˆ‡æ–­ãªã©å…¸å‹çš„ãªã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã¸ã®é·ç§»ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‹ã‚‰é–‹å§‹ã—ã€å®Ÿè¡Œä¸­ã‚¸ãƒ§ãƒ–ãŒå­˜åœ¨ã™ã‚‹çŠ¶æ³ã‚’è¨­å®š
      const initialState = {
        isOnline: true,
        currentJobs: ['job-1', 'job-2']
      };
      const networkEvent = new Event('offline');
      const currentTime = 1699000000000;

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹å¤‰åŒ–æ¤œå‡ºæ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹å¤‰åŒ–ã‚’å‡¦ç†
      // ã€å‡¦ç†å†…å®¹ã€‘: navigator.onLineã®ç›£è¦–ã¨offlineã‚¤ãƒ™ãƒ³ãƒˆã®æ¤œå‡ºã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆãƒ»é€ä¿¡å‡¦ç†
      const result = detectNetworkStateChange(networkEvent, currentTime);

      // ã€çµæœæ¤œè¨¼ã€‘: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹å¤‰åŒ–æ¤œå‡ºçµæœã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼ã®æ­£ç¢ºæ€§ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: æ¤œå‡ºæˆåŠŸã€æ­£ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‹ã€å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ã‚’æ¤œè¨¼
      expect(result.detected).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹å¤‰åŒ–ãŒæ­£ã—ãæ¤œå‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.message.type).toBe('NETWORK_STATE_CHANGED'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ãŒä»•æ§˜é€šã‚Šã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.message.isOnline).toBe(false); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.message.timestamp).toBe(currentTime); // ã€ç¢ºèªå†…å®¹ã€‘: æ¤œå‡ºæ™‚åˆ»ãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.message.affectedJobs).toEqual(['job-1', 'job-2']); // ã€ç¢ºèªå†…å®¹ã€‘: å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚¸ãƒ§ãƒ–ãŒæ­£ç¢ºã«ç‰¹å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('TC-071-002: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œå‡ºæ™‚ã«å®Ÿè¡Œä¸­ã‚¸ãƒ§ãƒ–ã‚’æ­£ã—ãä¸€æ™‚åœæ­¢ã™ã‚‹', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚¸ãƒ§ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®'running'ã‹ã‚‰'paused'ã¸ã®çŠ¶æ…‹å¤‰æ›´ã¨ä¸€æ™‚åœæ­¢å‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: å®Ÿè¡Œä¸­ã®ã‚¸ãƒ§ãƒ–ã‚’æ¤œå‡ºã—ã€é©åˆ‡ãªä¸€æ™‚åœæ­¢å‡¦ç†ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—è¨˜éŒ²ã‚’è¡Œã†
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¸ãƒ§ãƒ–ã®é€²è¡ŒãŒåœæ­¢ã—ã€ä¸€æ™‚åœæ­¢æ™‚åˆ»ã¨ç†ç”±ãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: è¦ä»¶å®šç¾©ã®JobPausedMessageå‹å®šç¾©ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç”»åƒç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ã®é€”ä¸­ï¼ˆ2/5æšå®Œäº†ï¼‰ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ–­ç·šãŒç™ºç”Ÿã—ãŸçŠ¶æ³ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: å®Ÿè¡Œä¸­ã®ã‚¸ãƒ§ãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨é€²æ—æƒ…å ±ã‚’æº–å‚™
      const runningJob = {
        id: 'job-456',
        status: 'running' as const,
        progress: { current: 2, total: 5 },
        startedAt: 1699000000000
      };
      const networkState = { isOnline: false };
      const pauseTime = 1699000000000;

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¸ãƒ§ãƒ–ä¸€æ™‚åœæ­¢æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®ã‚¸ãƒ§ãƒ–åˆ¶å¾¡ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: ã‚¸ãƒ§ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¤‰æ›´ã€é€²æ—æƒ…å ±ã®ä¿æŒã€ä¸€æ™‚åœæ­¢ç†ç”±ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®è¨˜éŒ²
      const result = pauseJobsOnOffline([runningJob], networkState, pauseTime);

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚¸ãƒ§ãƒ–ä¸€æ™‚åœæ­¢å‡¦ç†çµæœã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼ã®æ­£ç¢ºæ€§ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ä¸€æ™‚åœæ­¢æˆåŠŸã€æ­£ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‹ã€å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ã‚’æ¤œè¨¼
      expect(result.success).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¸ãƒ§ãƒ–ä¸€æ™‚åœæ­¢å‡¦ç†ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.pausedJobs).toHaveLength(1); // ã€ç¢ºèªå†…å®¹ã€‘: æŒ‡å®šã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ãŒä¸€æ™‚åœæ­¢ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.messages[0].type).toBe('JOB_PAUSED'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ãŒä»•æ§˜é€šã‚Šã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.messages[0].jobId).toBe('job-456'); // ã€ç¢ºèªå†…å®¹ã€‘: ä¸€æ™‚åœæ­¢ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–IDãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.messages[0].reason).toBe('network_offline'); // ã€ç¢ºèªå†…å®¹ã€‘: ä¸€æ™‚åœæ­¢ç†ç”±ãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.messages[0].pausedAt).toBe(pauseTime); // ã€ç¢ºèªå†…å®¹ã€‘: ä¸€æ™‚åœæ­¢æ™‚åˆ»ãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('TC-071-003: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾©æ—§å¾Œã«ä¸€æ™‚åœæ­¢ã—ãŸã‚¸ãƒ§ãƒ–ã‚’æ­£ã—ãå†é–‹ã™ã‚‹', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹å¤‰åŒ–ã®æ¤œå‡ºã¨ã‚¸ãƒ§ãƒ–å†é–‹å‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾©æ—§ã«ã‚ˆã‚Šã€ä¸€æ™‚åœæ­¢ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ã®å†é–‹å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: JOB_RESUMEDãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œã€ã‚¸ãƒ§ãƒ–ãŒé©åˆ‡ãªåœ°ç‚¹ã‹ã‚‰å†é–‹ã•ã‚Œã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: è¦ä»¶å®šç¾©ã®JobResumedMessageå‹å®šç¾©ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾©æ—§ã«ã‚ˆã‚Šã€ä¸€æ™‚åœæ­¢ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ã®å†é–‹å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ä¸€æ™‚åœæ­¢ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ã¨å¾©æ—§ã—ãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã‚’æº–å‚™
      const pausedJob = {
        id: 'job-restore-001',
        status: 'paused' as const,
        reason: 'network_offline',
        pausedAt: 1699000000000,
        progress: { current: 2, total: 5 }
      };
      const networkState = { isOnline: true };
      const resumeTime = 1699000005000;

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¸ãƒ§ãƒ–å†é–‹æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã®ã‚¸ãƒ§ãƒ–å¾©å…ƒå‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: ä¸€æ™‚åœæ­¢ã‚¸ãƒ§ãƒ–ã®æ¤œå‡ºã€å†é–‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆã€é©åˆ‡ãªåœ°ç‚¹ã‹ã‚‰ã®å‡¦ç†ç¶™ç¶š
      const result = resumeJobsOnOnline([pausedJob], networkState, resumeTime);

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚¸ãƒ§ãƒ–å†é–‹å‡¦ç†çµæœã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼ã®æ­£ç¢ºæ€§ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: å†é–‹æˆåŠŸã€æ­£ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‹ã€å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ã‚’æ¤œè¨¼
      expect(result.success).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¸ãƒ§ãƒ–å†é–‹å‡¦ç†ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.resumedJobs).toHaveLength(1); // ã€ç¢ºèªå†…å®¹ã€‘: æŒ‡å®šã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ãŒå†é–‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.messages[0].type).toBe('JOB_RESUMED'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ãŒä»•æ§˜é€šã‚Šã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.messages[0].jobId).toBe('job-restore-001'); // ã€ç¢ºèªå†…å®¹ã€‘: å†é–‹ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–IDãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.messages[0].reason).toBe('network_restored'); // ã€ç¢ºèªå†…å®¹ã€‘: å†é–‹ç†ç”±ãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.messages[0].resumedAt).toBe(resumeTime); // ã€ç¢ºèªå†…å®¹ã€‘: å†é–‹æ™‚åˆ»ãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('TC-071-004: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹å¤‰åŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ«ãƒ¼ã‚¿çµŒç”±ã§æ­£ã—ãé…ä¿¡ã•ã‚Œã‚‹', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: æ—¢å­˜ã®TASK-031ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ«ãƒ¼ã‚¿ã¨ã®çµ±åˆå‹•ä½œã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹å¤‰åŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é©åˆ‡ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸ã®é…ä¿¡
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé©åˆ‡ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«é…ä¿¡ã•ã‚Œã‚‹
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜messagingRouterå®Ÿè£…ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹å¤‰åŒ–ã‚’è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«é€šçŸ¥ã™ã‚‹å¿…è¦ãŒã‚ã‚‹çŠ¶æ³ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ«ãƒ¼ã‚¿ã¨é…ä¿¡å¯¾è±¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æº–å‚™
      const message = {
        type: 'NETWORK_STATE_CHANGED',
        isOnline: false,
        timestamp: 1699000000000
      };
      const targetComponents = ['popup', 'content-script'];

      // Chrome runtime.sendMessage ã®ãƒ¢ãƒƒã‚¯è¨­å®š
      mockChrome.runtime.sendMessage.mockResolvedValue({ success: true });

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: NetworkRecoveryHandlerã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—
      // ã€å‡¦ç†å†…å®¹ã€‘: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ«ãƒ¼ã‚¿çµŒç”±ã§ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹å¤‰åŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é…ä¿¡å‡¦ç†
      const handler = new NetworkRecoveryHandler();
      const result = handler.broadcastNetworkStateChange(message, targetComponents);

      // ã€çµæœæ¤œè¨¼ã€‘: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡çµæœã¨çµ±åˆæ€§ã®ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: é…ä¿¡æˆåŠŸã€å¯¾è±¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸ã®æ­£ç¢ºãªé…ä¿¡ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®é©åˆ‡æ€§ã‚’æ¤œè¨¼
      expect(result.success).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.deliveryResults).toHaveLength(2); // ã€ç¢ºèªå†…å®¹ã€‘: æŒ‡å®šã•ã‚ŒãŸå…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«é…ä¿¡ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.deliveryResults[0].target).toBe('popup'); // ã€ç¢ºèªå†…å®¹ã€‘: popupã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ­£ç¢ºã«é…ä¿¡å¯¾è±¡ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.deliveryResults[1].target).toBe('content-script'); // ã€ç¢ºèªå†…å®¹ã€‘: content-scriptã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ­£ç¢ºã«é…ä¿¡å¯¾è±¡ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.totalDelivered).toBe(2); // ã€ç¢ºèªå†…å®¹ã€‘: é…ä¿¡å®Œäº†æ•°ãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
    });

    test('TC-071-005: è¤‡æ•°ã®ã‚¸ãƒ§ãƒ–ãŒä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã«æ®µéšçš„ã«å†é–‹ã™ã‚‹', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: RetryEngineã¨ã®çµ±åˆã«ã‚ˆã‚‹è² è·åˆ†æ•£å†é–‹æ©Ÿèƒ½ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: è¤‡æ•°ã‚¸ãƒ§ãƒ–ã®æ®µéšçš„å†é–‹å‡¦ç†ã¨RetryEngineã®é…å»¶æ©Ÿèƒ½çµ±åˆ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: è¤‡æ•°ã‚¸ãƒ§ãƒ–ãŒä¸€åº¦ã«å†é–‹ã•ã‚Œãšã€é©åˆ‡ãªé–“éš”ã§æ®µéšçš„ã«å‡¦ç†ã•ã‚Œã‚‹
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: TASK-032ãƒªãƒˆãƒ©ã‚¤ã‚¨ãƒ³ã‚¸ãƒ³ä»•æ§˜ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: è¤‡æ•°ã‚¸ãƒ§ãƒ–ãŒåŒæ™‚æœŸã«ä¸€æ™‚åœæ­¢ã•ã‚Œã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾©æ—§æ™‚ã«å†é–‹ãŒå¿…è¦ãªçŠ¶æ³ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: è¤‡æ•°ã®ä¸€æ™‚åœæ­¢ã‚¸ãƒ§ãƒ–ã¨RetryEngineè¨­å®šã‚’æº–å‚™
      const pausedJobs = [
        { id: 'job-1', pausedAt: 1699000000000 },
        { id: 'job-2', pausedAt: 1699000001000 },
        { id: 'job-3', pausedAt: 1699000002000 }
      ];
      const retrySettings = { baseDelay: 500, factor: 2.0 };

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: æ®µéšçš„ã‚¸ãƒ§ãƒ–å†é–‹æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—ã€è² è·åˆ†æ•£ã•ã‚ŒãŸå†é–‹å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: RetryEngineã®é…å»¶æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ãŸæ®µéšçš„å†é–‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç”Ÿæˆ
      const result = stageResumeMultipleJobs(pausedJobs, retrySettings);

      // ã€çµæœæ¤œè¨¼ã€‘: æ®µéšçš„å†é–‹å‡¦ç†çµæœã¨è² è·åˆ¶å¾¡ã®ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: é©åˆ‡ãªå†é–‹é–“éš”ã€RetryEngineçµ±åˆã€ã‚·ã‚¹ãƒ†ãƒ è² è·åˆ¶å¾¡ã®æ¤œè¨¼
      expect(result.success).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: æ®µéšçš„å†é–‹å‡¦ç†ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.resumeSchedule).toHaveLength(3); // ã€ç¢ºèªå†…å®¹ã€‘: å…¨ã‚¸ãƒ§ãƒ–ãŒå†é–‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.resumeSchedule[0].delayMs).toBe(0); // ã€ç¢ºèªå†…å®¹ã€‘: æœ€åˆã®ã‚¸ãƒ§ãƒ–ãŒå³åº§ã«å†é–‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.resumeSchedule[1].delayMs).toBe(500); // ã€ç¢ºèªå†…å®¹ã€‘: 2ç•ªç›®ã®ã‚¸ãƒ§ãƒ–ãŒé©åˆ‡ãªé…å»¶ã§å†é–‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.resumeSchedule[2].delayMs).toBe(1000); // ã€ç¢ºèªå†…å®¹ã€‘: 3ç•ªç›®ã®ã‚¸ãƒ§ãƒ–ãŒæ®µéšçš„ãªé…å»¶ã§å†é–‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.totalJobs).toBe(3); // ã€ç¢ºèªå†…å®¹ã€‘: å‡¦ç†å¯¾è±¡ã‚¸ãƒ§ãƒ–æ•°ãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
    });
  });

  describe('ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰', () => {
    test('TC-071-101: navigator.onLineãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: navigator.onLineãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒæœªå®šç¾©ã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ã®ç’°å¢ƒã§ã®å®‰å…¨ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ä½œã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: navigator.onLineã®æœªã‚µãƒãƒ¼ãƒˆç’°å¢ƒã§ã®çŠ¶æ…‹æ¤œå‡ºå¤±æ•—æ™‚ã®å‡¦ç†
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚’ä»®å®šã™ã‚‹ã“ã¨ã§ã€æ©Ÿèƒ½ã®ç¶™ç¶šä½¿ç”¨ã‚’å„ªå…ˆ
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§è¦ä»¶ã‹ã‚‰æ¨æ¸¬

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å¤ã„Chromeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚„ä¼æ¥­ãƒ—ãƒ­ã‚­ã‚·ç’°å¢ƒã§ã®åˆ¶é™ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: navigator.onLineãŒæœªå®šç¾©ã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ã®ç’°å¢ƒã‚’è¨­å®š
      const corruptedNavigator = { onLine: undefined };
      const unsupportedWindow = { addEventListener: null };

      // navigator ã‚’ä¸€æ™‚çš„ã«ç ´æçŠ¶æ…‹ã«å¤‰æ›´
      (globalThis as any).navigator = corruptedNavigator;
      (globalThis as any).window = unsupportedWindow;

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹æ¤œå‡ºæ©Ÿèƒ½ã‚’ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ç’°å¢ƒã§å‘¼ã³å‡ºã—
      // ã€å‡¦ç†å†…å®¹ã€‘: APIæœªã‚µãƒãƒ¼ãƒˆç’°å¢ƒã§ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã¨å®‰å…¨ãªæ©Ÿèƒ½ç¶™ç¶š
      const result = detectNetworkStateChange(null, Date.now());

      // ã€çµæœæ¤œè¨¼ã€‘: APIæœªã‚µãƒãƒ¼ãƒˆç’°å¢ƒã§ã®å®‰å…¨ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ä½œã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ä½œã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä»®å®šã€ç›£è¦–æ©Ÿèƒ½ç„¡åŠ¹åŒ–ã®æ¤œè¨¼
      expect(result.fallbackMode).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.assumedState).toBe('online'); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ãŒä»®å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.warning).toContain('Network detection not available'); // ã€ç¢ºèªå†…å®¹ã€‘: é©åˆ‡ãªè­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.monitoringDisabled).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: ç›£è¦–æ©Ÿèƒ½ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
    });

    test('TC-071-102: ã‚¸ãƒ§ãƒ–ä¸€æ™‚åœæ­¢å‡¦ç†ã«å¤±æ•—ã—ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚¸ãƒ§ãƒ–ã®çŠ¶æ…‹å¤‰æ›´ã‚„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ã®å¤±æ•—æ™‚ã®å®‰å…¨ãªã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã‚¸ãƒ§ãƒ–ä¸€æ™‚åœæ­¢å‡¦ç†ã®å¤±æ•—æ™‚ã®å¼·åˆ¶åœæ­¢ã¨ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ²
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: å¼·åˆ¶åœæ­¢ã«ã‚ˆã‚Šã€ä¸æ•´åˆçŠ¶æ…‹ã®ç¶™ç¶šã‚’é˜²æ­¢
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ä¸€èˆ¬çš„ãªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼å‡¦ç†è¦ä»¶ã‹ã‚‰æ¨æ¸¬

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: Chromeæ‹¡å¼µã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆ¶é™åˆ°é”ã‚„åŒæœŸã‚¨ãƒ©ãƒ¼ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ä¸è¶³ã‚„ã‚¸ãƒ§ãƒ–ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®ç•°å¸¸ã‚’è¨­å®š
      const runningJob = { id: 'job-error-001', status: 'running' };
      const storageError = new Error('Storage quota exceeded');

      // Chrome storage API ã®ãƒ¢ãƒƒã‚¯ã‚’å¤±æ•—ã™ã‚‹ã‚ˆã†è¨­å®š
      mockChrome.storage.local.set.mockRejectedValue(storageError);

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¸ãƒ§ãƒ–ä¸€æ™‚åœæ­¢æ©Ÿèƒ½ã‚’ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼ç’°å¢ƒã§å‘¼ã³å‡ºã—
      // ã€å‡¦ç†å†…å®¹ã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨å¼·åˆ¶åœæ­¢å‡¦ç†
      const result = pauseJobsOnOffline([runningJob], { isOnline: false }, Date.now());

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚¸ãƒ§ãƒ–åˆ¶å¾¡å¤±æ•—æ™‚ã®å®‰å…¨ãªã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: å¤±æ•—ã®è¨˜éŒ²ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã€å¼·åˆ¶åœæ­¢ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ã®æ¤œè¨¼
      expect(result.pauseResult).toBe('failed'); // ã€ç¢ºèªå†…å®¹ã€‘: ä¸€æ™‚åœæ­¢å‡¦ç†ã®å¤±æ•—ãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.fallbackAction).toBe('force_stop'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã¨ã—ã¦å¼·åˆ¶åœæ­¢ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.errorLog).toContain('Storage quota exceeded'); // ã€ç¢ºèªå†…å®¹ã€‘: å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ç†ç”±ãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.jobStatus).toBe('error'); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¸ãƒ§ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã«å¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.userNotification).toContain('ã‚¸ãƒ§ãƒ–ã®ä¸€æ™‚åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®åˆ†ã‹ã‚Šã‚„ã™ã„é€šçŸ¥ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
    });

    test('TC-071-103: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾©æ—§å¾Œã®ã‚¸ãƒ§ãƒ–å†é–‹ã«å¤±æ•—ã—ãŸå ´åˆã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹å§”è­²', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: å†é–‹å¯¾è±¡ã‚¸ãƒ§ãƒ–ã®ãƒ‡ãƒ¼ã‚¿ç ´æã‚„å®Ÿè¡Œç’°å¢ƒã®å•é¡Œæ™‚ã®é©åˆ‡ãªã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã‚¸ãƒ§ãƒ–å†é–‹å¤±æ•—æ™‚ã®RetryEngineã¸ã®å§”è­²ã¨è‡ªå‹•å†è©¦è¡Œè¨­å®š
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: æ—¢å­˜ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ã¸ã®å§”è­²ã«ã‚ˆã‚Šã€å›å¾©å¯èƒ½æ€§ã‚’æœ€å¤§åŒ–
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: TASK-032ãƒªãƒˆãƒ©ã‚¤ã‚¨ãƒ³ã‚¸ãƒ³ä»•æ§˜ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã®éƒ¨åˆ†çš„ç ´æã‚„æ‹¡å¼µã®å†èµ·å‹•ã«ã‚ˆã‚‹çŠ¶æ…‹å–ªå¤±ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚¸ãƒ§ãƒ–ãƒ‡ãƒ¼ã‚¿ã®ç ´æã‚„ä¾å­˜ãƒªã‚½ãƒ¼ã‚¹ã®ä¸æ•´åˆã‚’è¨­å®š
      const pausedJob = { id: 'job-resume-error', status: 'paused', data: null };
      const resumeError = new Error('Job data corrupted');
      const retryEngineAvailable = true;

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¸ãƒ§ãƒ–å†é–‹æ©Ÿèƒ½ã‚’ãƒ‡ãƒ¼ã‚¿ç ´æç’°å¢ƒã§å‘¼ã³å‡ºã—
      // ã€å‡¦ç†å†…å®¹ã€‘: å†é–‹å¤±æ•—æ™‚ã®RetryEngineã¸ã®å§”è­²å‡¦ç†
      const result = resumeJobsOnOnline([pausedJob], { isOnline: true }, Date.now());

      // ã€çµæœæ¤œè¨¼ã€‘: å†é–‹å¤±æ•—æ™‚ã®é©åˆ‡ãªã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: å¤±æ•—è¨˜éŒ²ã€RetryEngineå§”è­²ã€å†è©¦è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ã®æ¤œè¨¼
      expect(result.resumeResult).toBe('failed'); // ã€ç¢ºèªå†…å®¹ã€‘: å†é–‹å‡¦ç†ã®å¤±æ•—ãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.delegatedTo).toBe('retry_engine'); // ã€ç¢ºèªå†…å®¹ã€‘: RetryEngineã¸ã®å§”è­²ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.retryScheduled).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: è‡ªå‹•å†è©¦è¡ŒãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.maxRetries).toBe(5); // ã€ç¢ºèªå†…å®¹ã€‘: é©åˆ‡ãªå†è©¦è¡Œå›æ•°ãŒè¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.userMessage).toContain('è‡ªå‹•å†è©¦è¡Œã‚’é–‹å§‹ã—ã¾ã™'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®å¾Œç¶šå‡¦ç†èª¬æ˜ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('TC-071-104: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ«ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ç›´æ¥é€šçŸ¥æ©Ÿèƒ½', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: messagingRouterã®åˆæœŸåŒ–å¤±æ•—ã‚„é€šä¿¡ã‚¨ãƒ©ãƒ¼æ™‚ã®ä»£æ›¿é€šä¿¡æ©Ÿèƒ½ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ«ãƒ¼ã‚¿éšœå®³æ™‚ã®chrome.runtime.sendMessageã«ã‚ˆã‚‹ç›´æ¥é€šçŸ¥
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ä»£æ›¿é€šä¿¡æ‰‹æ®µã«ã‚ˆã‚Šã€é‡è¦ãªæƒ…å ±ã®ä¼é”ã‚’ä¿è¨¼
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ‹¡å¼µã‚·ã‚¹ãƒ†ãƒ ã®éšœå®³å¯¾å¿œè¦ä»¶ã‹ã‚‰æ¨æ¸¬

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æ‹¡å¼µã®éƒ¨åˆ†çš„èª­ã¿è¾¼ã¿å¤±æ•—ã‚„æ¨©é™åˆ¶é™ã«ã‚ˆã‚‹æ©Ÿèƒ½åˆ¶ç´„ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ«ãƒ¼ã‚¿ã®ä¾å­˜ã‚¨ãƒ©ãƒ¼ã‚„åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°å•é¡Œã‚’è¨­å®š
      const networkStateChange = { isOnline: false, timestamp: 1699000000000 };
      const messagingRouterError = new Error('Router initialization failed');
      const directNotificationTargets = ['popup'];

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: NetworkRecoveryHandlerã®ç›´æ¥é€šçŸ¥æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—
      // ã€å‡¦ç†å†…å®¹ã€‘: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ«ãƒ¼ã‚¿éšœå®³æ™‚ã®ä»£æ›¿é€šä¿¡æ‰‹æ®µã«ã‚ˆã‚‹æƒ…å ±ä¼é”
      const handler = new NetworkRecoveryHandler();
      const result = handler.notifyDirectly(networkStateChange, directNotificationTargets, messagingRouterError);

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚¤ãƒ³ãƒ•ãƒ©éšœå®³æ™‚ã®ä»£æ›¿é€šä¿¡æ©Ÿèƒ½ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ãƒ«ãƒ¼ã‚¿æœªä½¿ç”¨ã€ç›´æ¥é€šçŸ¥æˆåŠŸã€ä»£æ›¿æ‰‹æ®µä½¿ç”¨ã€é…ä¿¡ç¢ºèªã®æ¤œè¨¼
      expect(result.routerUsed).toBe(false); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ«ãƒ¼ã‚¿ãŒä½¿ç”¨ã•ã‚Œãªã„ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.directNotificationSent).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: ç›´æ¥é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.notificationTargets).toEqual(['popup']); // ã€ç¢ºèªå†…å®¹ã€‘: æŒ‡å®šã•ã‚ŒãŸå¯¾è±¡ã«é€šçŸ¥ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.fallbackMethod).toBe('chrome.runtime.sendMessage'); // ã€ç¢ºèªå†…å®¹ã€‘: é©åˆ‡ãªä»£æ›¿æ‰‹æ®µãŒä½¿ç”¨ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(result.deliveryConfirmed).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: é…ä¿¡å®Œäº†ãŒç¢ºèªã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
    });
  });

  describe('å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆæœ€å°å€¤ã€æœ€å¤§å€¤ã€nullç­‰ï¼‰', () => {
    test('TC-071-201: 5ç§’ä»¥å†…ã®é€£ç¶šçŠ¶æ…‹å¤‰åŒ–ã‚’ç„¡è¦–ã™ã‚‹ãƒ•ãƒ©ãƒƒãƒ”ãƒ³ã‚°é˜²æ­¢æ©Ÿèƒ½ã®å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: çœŸã®çŠ¶æ…‹å¤‰åŒ–ã¨ä¸€æ™‚çš„ãªæ¥ç¶šä¸å®‰å®šã‚’åŒºåˆ¥ã™ã‚‹æœ€å°é–¾å€¤ã§ã®ãƒ•ãƒ©ãƒƒãƒ”ãƒ³ã‚°é˜²æ­¢æ©Ÿèƒ½ã®ç²¾åº¦ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: 5ç§’é–¾å€¤ã§ã®çŠ¶æ…‹å¤‰åŒ–åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¨èª¤æ¤œå‡ºé˜²æ­¢æ©Ÿèƒ½
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 4.9ç§’ã¯ç„¡è¦–ã€5.0ç§’ä»¥ä¸Šã§æ¤œå‡ºã™ã‚‹ä¸€è²«ã—ãŸå‹•ä½œ
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: è¦ä»¶å®šç¾©ã®ãƒ•ãƒ©ãƒƒãƒ”ãƒ³ã‚°é˜²æ­¢ä»•æ§˜ï¼ˆ5ç§’é–¾å€¤ï¼‰ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: WiFiæ¥ç¶šã®ä¸€æ™‚çš„æ–­ç¶šã‚„ãƒ¢ãƒã‚¤ãƒ«æ¥ç¶šåˆ‡ã‚Šæ›¿ãˆæ™‚ã®çŸ­æ™‚é–“å¤‰å‹•ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: é–¾å€¤å‰å¾Œã§ã®é€£ç¶šçŠ¶æ…‹å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®š
      const testCases = [
        { duration: 4900, shouldIgnore: true },
        { duration: 5000, shouldDetect: true },
        { duration: 5100, shouldDetect: true }
      ];

      testCases.forEach(testCase => {
        // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒ•ãƒ©ãƒƒãƒ”ãƒ³ã‚°é˜²æ­¢æ©Ÿèƒ½ã‚’å„å¢ƒç•Œå€¤ã§å‘¼ã³å‡ºã—
        // ã€å‡¦ç†å†…å®¹ã€‘: çŠ¶æ…‹å¤‰åŒ–ç¶™ç¶šæ™‚é–“ã®ç›£è¦–ã¨é–¾å€¤åˆ¤å®šã«ã‚ˆã‚‹æ¤œå‡ºåˆ¶å¾¡
        const result = handleFlappingPrevention('test-job', testCase.duration);

        // ã€çµæœæ¤œè¨¼ã€‘: ãƒ•ãƒ©ãƒƒãƒ”ãƒ³ã‚°é˜²æ­¢æ©Ÿèƒ½ã®ç²¾åº¦ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: é–¾å€¤å‰å¾Œã§ã®ä¸€è²«ã—ãŸåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¨èª¤æ¤œå‡ºé˜²æ­¢èƒ½åŠ›ã®æ¤œè¨¼
        if (testCase.shouldIgnore) {
          expect(result.detected).toBe(false); // ã€ç¢ºèªå†…å®¹ã€‘: é–¾å€¤æœªæº€ã§ã®çŠ¶æ…‹å¤‰åŒ–ãŒç„¡è¦–ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
          expect(result.reason).toBe('flapping_prevention'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ•ãƒ©ãƒƒãƒ”ãƒ³ã‚°é˜²æ­¢ãŒç†ç”±ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
        } else {
          expect(result.detected).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: é–¾å€¤ä»¥ä¸Šã§ã®çŠ¶æ…‹å¤‰åŒ–ãŒæ¤œå‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
          expect(result.reason).toMatch(/threshold_met|stable_state/); // ã€ç¢ºèªå†…å®¹ã€‘: é©åˆ‡ãªæ¤œå‡ºç†ç”±ãŒè¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
        }
      });
    });

    test('TC-071-202: navigator.onLineãƒãƒ¼ãƒªãƒ³ã‚°ã®æœ€å¤§1ç§’é–“éš”åˆ¶å¾¡ã®å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿ã‚’æŠ‘åˆ¶ã™ã‚‹ç›£è¦–å‘¨æœŸã®ä¸Šé™ã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ¶ç´„ã®éµå®ˆã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ç›£è¦–é–“éš”ã®è¨­å®šã¨ä¸Šé™åˆ¶å¾¡æ©Ÿèƒ½
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 1ç§’ã‚’è¶…ãˆãªã„é–“éš”ã§ç›£è¦–ãŒå®Ÿè¡Œã•ã‚Œã‚‹
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: è¦ä»¶å®šç¾©ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ã‹ã‚‰æ¨æ¸¬

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: é«˜é »åº¦ã§ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ç¢ºèªãŒå¿…è¦ãªä¸å®‰å®šç’°å¢ƒã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ç›£è¦–å‘¨æœŸã®å¢ƒç•Œå€¤ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®š
      const testCases = [
        { interval: 900, expected: 'allowed' },
        { interval: 1000, expected: 'allowed' },
        { interval: 1100, expected: 'capped_to_1000' }
      ];

      testCases.forEach(testCase => {
        // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: NetworkRecoveryHandlerã®ç›£è¦–å‘¨æœŸè¨­å®šæ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—
        // ã€å‡¦ç†å†…å®¹ã€‘: ç›£è¦–é–“éš”ã®è¨­å®šã¨ä¸Šé™åˆ¶å¾¡ã«ã‚ˆã‚‹é©åˆ‡ãªåˆ¶é™
        const handler = new NetworkRecoveryHandler();
        const result = handler.setMonitoringInterval(testCase.interval);

        // ã€çµæœæ¤œè¨¼ã€‘: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ¶ç´„ã®éµå®ˆã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: é–“éš”åˆ¶å¾¡ã®æ­£ç¢ºæ€§ã€ä¸Šé™åˆ¶é™æ©Ÿèƒ½ã€CPUãƒ»ãƒãƒƒãƒ†ãƒªãƒ¼ä½¿ç”¨ç‡ã¸ã®é…æ…®ã®æ¤œè¨¼
        if (testCase.expected === 'allowed') {
          expect(result.applied).toBe(testCase.interval); // ã€ç¢ºèªå†…å®¹ã€‘: è¨±å¯ç¯„å›²å†…ã®é–“éš”ãŒæ­£ç¢ºã«é©ç”¨ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
          expect(result.acceptable).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: è¨±å¯ç¯„å›²å†…ã¨ã—ã¦åˆ¤å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
        } else {
          expect(result.applied).toBe(1000); // ã€ç¢ºèªå†…å®¹ã€‘: ä¸Šé™ã‚’è¶…ãˆã‚‹å ´åˆã«1ç§’ã«åˆ¶é™ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
          expect(result.capped).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: ä¸Šé™åˆ¶é™ãŒé©ç”¨ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
          expect(result.warning).toContain('Interval capped to 1000ms'); // ã€ç¢ºèªå†…å®¹ã€‘: åˆ¶é™å®Ÿè¡Œæ™‚ã«é©åˆ‡ãªè­¦å‘ŠãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
        }
      });
    });

    test('TC-071-203: æœ€å¤§åŒæ™‚å¾©æ—§ã‚¸ãƒ§ãƒ–æ•°åˆ¶å¾¡ã®å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚·ã‚¹ãƒ†ãƒ è² è·ã‚’åˆ¶å¾¡ã™ã‚‹åŒæ™‚å‡¦ç†æ•°ã®é™ç•Œã§ã®è² è·åˆ¶å¾¡æ©Ÿèƒ½ã®å‹•ä½œã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: åŒæ™‚å¾©æ—§ã‚¸ãƒ§ãƒ–æ•°ã®åˆ¶é™ã¨è¶…éæ™‚ã®ãƒãƒƒãƒå‡¦ç†
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: åˆ¶é™æ•°ã‚’è¶…ãˆã‚‹å ´åˆã®é©åˆ‡ãªå¾…æ©Ÿåˆ¶å¾¡
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚·ã‚¹ãƒ†ãƒ è² è·åˆ¶å¾¡ã®ä¸€èˆ¬çš„è¦ä»¶ã‹ã‚‰æ¨æ¸¬

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å¤§é‡ã‚¸ãƒ§ãƒ–å®Ÿè¡Œä¸­ã®é•·æ™‚é–“ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ã‹ã‚‰ã®å¾©æ—§ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: åŒæ™‚å¾©æ—§åˆ¶é™ã®å¢ƒç•Œå€¤ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®š
      const testCases = [
        { jobCount: 3, maxConcurrent: 5, expected: 'all_immediate' },
        { jobCount: 5, maxConcurrent: 5, expected: 'all_immediate' },
        { jobCount: 7, maxConcurrent: 5, expected: 'batched_resume' }
      ];

      testCases.forEach(testCase => {
        // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: åŒæ™‚å¾©æ—§åˆ¶å¾¡æ©Ÿèƒ½ã‚’ã‚¸ãƒ§ãƒ–æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å‘¼ã³å‡ºã—
        // ã€å‡¦ç†å†…å®¹ã€‘: åŒæ™‚å‡¦ç†æ•°åˆ¶é™ã¨è¶…éæ™‚ã®ãƒãƒƒãƒå‡¦ç†åˆ¶å¾¡
        const pausedJobs = Array.from({ length: testCase.jobCount }, (_, i) => ({ id: `job-${i}` }));
        const result = stageResumeMultipleJobs(pausedJobs, { maxConcurrent: testCase.maxConcurrent });

        // ã€çµæœæ¤œè¨¼ã€‘: è² è·åˆ¶å¾¡æ©Ÿèƒ½ã®å‹•ä½œã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: åˆ¶é™æ•°ã§ã®åˆ¶å¾¡ã€è¶…éæ™‚ã®ãƒãƒƒãƒå‡¦ç†ã€ã‚·ã‚¹ãƒ†ãƒ å®‰å®šæ€§ã®æ¤œè¨¼
        if (testCase.expected === 'all_immediate') {
          expect(result.immediate).toBe(testCase.jobCount); // ã€ç¢ºèªå†…å®¹ã€‘: åˆ¶é™å†…ã®ã‚¸ãƒ§ãƒ–ãŒå³åº§ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
          expect(result.queued).toBe(0); // ã€ç¢ºèªå†…å®¹ã€‘: å¾…æ©Ÿã‚¸ãƒ§ãƒ–ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
          expect(result.batchCount).toBe(1); // ã€ç¢ºèªå†…å®¹ã€‘: å˜ä¸€ãƒãƒƒãƒã§å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
        } else {
          expect(result.immediate).toBe(testCase.maxConcurrent); // ã€ç¢ºèªå†…å®¹ã€‘: åˆ¶é™æ•°ã¾ã§å³åº§ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
          expect(result.queued).toBe(testCase.jobCount - testCase.maxConcurrent); // ã€ç¢ºèªå†…å®¹ã€‘: è¶…éåˆ†ãŒé©åˆ‡ã«å¾…æ©Ÿã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
          expect(result.batchCount).toBeGreaterThan(1); // ã€ç¢ºèªå†…å®¹ã€‘: è¤‡æ•°ãƒãƒƒãƒã«åˆ†å‰²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
        }
      });
    });

    test('TC-071-204: äºˆæœŸã—ãªã„null/undefinedå€¤ã«å¯¾ã™ã‚‹å®‰å…¨ãªå‡¦ç†ã®å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®æœ€ã‚‚æ¥µç«¯ãªã‚±ãƒ¼ã‚¹ï¼ˆå€¤ã®ä¸å­˜åœ¨ï¼‰ã§ã®nullå®‰å…¨æ€§ã¨ã‚·ã‚¹ãƒ†ãƒ ã®å …ç‰¢æ€§ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: null/undefinedå…¥åŠ›å€¤ã§ã®å®‰å…¨ãªå‡¦ç†ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: null/undefinedã§ã‚‚ã‚·ã‚¹ãƒ†ãƒ ãŒç•°å¸¸çµ‚äº†ã›ãšã€é©åˆ‡ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã§ç¶™ç¶š
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ä¸€èˆ¬çš„ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‹ã‚‰æ¨æ¸¬

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: APIå¿œç­”ã®é…å»¶ã€ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¨ãƒ©ãƒ¼ã€åˆæœŸåŒ–å‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: null/undefinedã®æ§˜ã€…ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®š
      const testCases = [
        { jobId: null, expectedBehavior: 'skip_processing' },
        { jobId: undefined, expectedBehavior: 'skip_processing' },
        { networkState: null, expectedBehavior: 'assume_online' },
        { timestamp: undefined, expectedBehavior: 'use_current_time' }
      ];

      testCases.forEach(testCase => {
        // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: NetworkRecoveryHandlerã®å„æ©Ÿèƒ½ã‚’null/undefinedå…¥åŠ›ã§å‘¼ã³å‡ºã—
        // ã€å‡¦ç†å†…å®¹ã€‘: nullå®‰å…¨æ€§å‡¦ç†ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«ã‚ˆã‚‹ç¶™ç¶šå‹•ä½œ
        let result;

        if ('jobId' in testCase) {
          result = detectNetworkStateChange(null, Date.now(), testCase.jobId);
        } else if ('networkState' in testCase) {
          result = pauseJobsOnOffline([], testCase.networkState, Date.now());
        } else if ('timestamp' in testCase) {
          result = detectNetworkStateChange(null, testCase.timestamp);
        }

        // ã€çµæœæ¤œè¨¼ã€‘: nullå®‰å…¨æ€§ã¨ã‚·ã‚¹ãƒ†ãƒ ã®å …ç‰¢æ€§ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: null/undefinedå‡¦ç†ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤é©ç”¨ã€ã‚·ã‚¹ãƒ†ãƒ ç¶™ç¶šæ€§ã®æ¤œè¨¼
        expect(result.handled).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: null/undefinedå€¤ãŒå®‰å…¨ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
        expect(result.safe).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚·ã‚¹ãƒ†ãƒ ãŒå®‰å…¨ãªçŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡

        if (testCase.expectedBehavior === 'skip_processing') {
          expect(result.action).toBe('skipped'); // ã€ç¢ºèªå†…å®¹ã€‘: ç„¡åŠ¹ãªå…¥åŠ›ãŒé©åˆ‡ã«ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
        } else if (testCase.expectedBehavior === 'assume_online') {
          expect(result.fallback).toBe('online'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ãŒä»®å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
        } else if (testCase.expectedBehavior === 'use_current_time') {
          expect(result.fallback).toMatch(/Date\.now\(\)/); // ã€ç¢ºèªå†…å®¹ã€‘: ç¾åœ¨æ™‚åˆ»ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
        }
      });
    });
describe('Network Recovery Handler nullå®‰å…¨å‡¦ç† (Red)', () => {
  beforeEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: nullå®‰å…¨ã‚·ãƒŠãƒªã‚ªã‚’å†ç¾ã™ã‚‹ãŸã‚ã«navigatorã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚’èª¿æ•´
    // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: mockNavigatorã®isOnlineã‚’falseã«è¨­å®šã—ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã®å‰æã‚’ç”¨æ„
    (mockNavigator as any).onLine = false;
  });

  afterEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†ã€‘: navigatorã‚¹ã‚¿ãƒ–ã‚’åˆæœŸçŠ¶æ…‹ã¸æˆ»ã—ã€ä»–ãƒ†ã‚¹ãƒˆã¸ã®å‰¯ä½œç”¨ã‚’é˜²æ­¢
    // ã€çŠ¶æ…‹å¾©å…ƒã€‘: isOnlineã‚’trueã«æˆ»ã—ã€ä»–ã‚±ãƒ¼ã‚¹ãŒæ—¢å®šã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§é–‹å§‹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    (mockNavigator as any).onLine = true;
  });

  test('TC-071-204: null/undefinedå…¥åŠ›å€¤ã§ã®å®‰å…¨ãªå‡¦ç†', () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: nullãƒ»undefinedå…¥åŠ›æ™‚ã«å®‰å…¨ã«ã‚¹ã‚­ãƒƒãƒ—å‡¦ç†ã¸åˆ‡ã‚Šæ›¿ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: offlineã‚¤ãƒ™ãƒ³ãƒˆã‹ã¤timestampæœªæŒ‡å®šãƒ»jobId=nullã®å¢ƒç•Œæ¡ä»¶ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: handled=trueã®ã¾ã¾fallbackãŒè¨­å®šã•ã‚Œã€actionã¯skip_processingã¨ã—ã¦è¿”å´ã•ã‚Œã‚‹
    // ğŸŸ¢ğŸŸ¡ğŸ”´ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ğŸŸ¢ doc/implementation/TASK-071-testcases.md (TC-071-204) ã‚’ç›´æ¥å‚ç…§

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ä»•æ§˜ãŒæç¤ºã™ã‚‹jobId=nullã¨timestampæœªæŒ‡å®šã®çµ„ã¿åˆã‚ã›ã‚’ç”¨æ„
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: offlineã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¨¡å€£ã™ã‚‹ãŸã‚type='offline'ã®ãƒ€ãƒŸãƒ¼Eventã‚’ä½¿ç”¨
    const input = {
      event: { type: 'offline' } as Event,
      timestamp: undefined as unknown as number,
      jobId: null as unknown as string | undefined,
    };

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: detectNetworkStateChangeã‚’å‘¼ã³å‡ºã—ã¦nullå®‰å…¨åˆ†å²ã®æŒ™å‹•ã‚’ç¢ºèª
    // ã€å‡¦ç†å†…å®¹ã€‘: Redãƒ•ã‚§ãƒ¼ã‚ºã®ãŸã‚æœªå®Ÿè£…ã‚’å‰æã«ã—ã¤ã¤ã€æœŸå¾…ä»•æ§˜ã¨ã®å·®åˆ†ã‚’æ¸¬å®š
    const result = detectNetworkStateChange(input.event, input.timestamp, input.jobId as string | undefined);

    // ã€çµæœæ¤œè¨¼ã€‘: handledã¨fallback/actionãŒä»•æ§˜é€šã‚Šã‹ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: handled=true, action=skip_processing, fallback=Date.now() ã§è¿”ã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(result.handled).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: Redä»•æ§˜ã§nullå…¥åŠ›æ™‚ã‚‚å®‰å…¨ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ï¼ˆhandled=trueï¼‰ãŒæ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ ğŸŸ¢
    expect(result.action).toBe('skip_processing'); // ã€ç¢ºèªå†…å®¹ã€‘: TC-071-204ã§å®šç¾©ã•ã‚ŒãŸaction=skip_processingã‚’æº€ãŸã™ã‹ç¢ºèª ğŸŸ¢
    expect(result.fallback).toBe('Date.now()'); // ã€ç¢ºèªå†…å®¹ã€‘: timestampæœªæŒ‡å®šæ™‚ã«Date.now()ã‚’fallbackã«è¨­å®šã™ã‚‹ä»•æ§˜é€šã‚Šã‹ç¢ºèª ğŸŸ¢
  });
});
