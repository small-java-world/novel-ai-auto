// ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: new-format-metadata-manager.red.test.ts
// TDD Redãƒ•ã‚§ãƒ¼ã‚º: TASK-102 æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¯¾å¿œãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã®å¤±æ•—ãƒ†ã‚¹ãƒˆ

import { describe, test, expect, beforeEach, afterEach } from 'vitest';

// æœªå®Ÿè£…ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨é–¢æ•°ï¼ˆã“ã‚Œã‚‰ã¯å¤±æ•—ã®åŸå› ã¨ãªã‚‹ï¼‰
interface PromptFileV1 {
  version: '1.0';
  metadata: MetadataV1;
  commonPrompts?: CommonPromptsV1;
  presets: PresetV1[];
}

interface MetadataV1 {
  name: string; // 1-100æ–‡å­—
  description?: string; // 0-500æ–‡å­—
  author?: string; // 0-50æ–‡å­—
  created?: string; // ISO 8601å½¢å¼
  modified?: string; // ISO 8601å½¢å¼
  tags?: string[]; // 0-20ã‚¿ã‚°
  license?: string;
  source?: string;
}

interface CommonPromptsV1 {
  base: string;
  negative: string;
}

interface PresetV1 {
  name: string;
  prompt: string;
  negative?: string;
  parameters?: {
    steps: number;
    cfgScale: number;
    sampler: string;
  };
}

interface MetadataDisplayResult {
  name: string;
  description: string;
  author: string;
  dateCreated: string;
  dateModified: string;
  tags: string[];
  license?: string;
  source?: string;
}

interface FilterResult {
  filteredPresets: PresetV1[];
  matchCount: number;
  appliedTags: string[];
}

interface ConversionResult {
  success: boolean;
  convertedData?: PromptFileV1;
  warnings: string[];
  errors: string[];
}

interface LoadResult {
  success: boolean;
  metadata?: MetadataDisplayResult;
  presets?: PresetV1[];
  errors: string[];
  warnings: string[];
}

// æœªå®Ÿè£…ã‚¯ãƒ©ã‚¹ï¼ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ã¨ãªã‚‹ï¼‰
declare class NewFormatMetadataManager {
  loadPromptFile(data: string): Promise<LoadResult>;
  convertLegacyFormat(legacyData: any): Promise<ConversionResult>;
  formatMetadataForDisplay(metadata: MetadataV1): MetadataDisplayResult;
  filterPresetsByTags(presets: PresetV1[], selectedTags: string[]): FilterResult;
  validateFileSize(data: string): boolean;
  sanitizeMetadata(metadata: MetadataV1): MetadataV1;
}

describe('æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¯¾å¿œãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†', () => {
  let metadataManager: NewFormatMetadataManager;

  beforeEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆæœŸåŒ–
    // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã«ã—ã€ä¸€è²«ã—ãŸãƒ†ã‚¹ãƒˆæ¡ä»¶ã‚’ä¿è¨¼
    metadataManager = new NewFormatMetadataManager();
  });

  afterEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†ã€‘: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œã®ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    // ã€çŠ¶æ…‹å¾©å…ƒã€‘: æ¬¡ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã—ãªã„ã‚ˆã†çŠ¶æ…‹ã‚’å¾©å…ƒ
    metadataManager = null as any;
  });

  describe('æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆèª­ã¿è¾¼ã¿æ©Ÿèƒ½', () => {
    test('TC001: å®Œå…¨ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŒã¤æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆv1.0ï¼‰ãƒ•ã‚¡ã‚¤ãƒ«ã®æ­£å¸¸èª­ã¿è¾¼ã¿', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: PromptFileV1ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«å®Œå…¨æº–æ‹ ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿å‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚€æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®è§£æã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨ãªæŠ½å‡ºã¨å‹å¤‰æ›ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: EARSè¦ä»¶REQ-102-001ã¨å‹å®šç¾©ã«åŸºã¥ãç¢ºå®Ÿãªã‚±ãƒ¼ã‚¹

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚€å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç”¨æ„
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: æœ‰åŠ¹ãªJSONãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ•´å½¢æ¸ˆã¿ã®çŠ¶æ…‹
      const validNewFormatData = JSON.stringify({
        version: '1.0',
        metadata: {
          name: 'ãƒ†ã‚¹ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆé›†',
          description: 'ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³',
          author: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
          created: '2024-01-01T00:00:00Z',
          modified: '2024-01-02T00:00:00Z',
          tags: ['fantasy', 'character', 'landscape'],
          license: 'CC BY 4.0',
          source: 'https://example.com',
        },
        commonPrompts: {
          base: 'high quality, masterpiece',
          negative: 'low quality, blurry',
        },
        presets: [
          {
            name: 'ç¾ã—ã„é¢¨æ™¯',
            prompt: 'beautiful landscape',
            negative: 'ugly',
            parameters: { steps: 28, cfgScale: 7.0, sampler: 'k_euler_ancestral' },
          },
        ],
      });

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: JSONè§£æã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã€å‹å¤‰æ›ã‚’å«ã‚€ä¸€é€£ã®èª­ã¿è¾¼ã¿å‡¦ç†
      const result = await metadataManager.loadPromptFile(validNewFormatData);

      // ã€çµæœæ¤œè¨¼ã€‘: èª­ã¿è¾¼ã¿çµæœãŒæœŸå¾…ã•ã‚Œã‚‹å½¢å¼ã§è¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ã™ã¹ã¦ã®å¿…é ˆãƒ»ä»»æ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒé©åˆ‡ã«è§£æã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
      expect(result.success).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆèª­ã¿è¾¼ã¿ãŒæ­£å¸¸ã«å®Œäº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.metadata).toBeDefined(); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«æŠ½å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.metadata!.name).toBe('ãƒ†ã‚¹ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆé›†'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®nameè¦ç´ ãŒæ­£ç¢ºã«æŠ½å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.metadata!.description).toBe('ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³'); // ã€ç¢ºèªå†…å®¹ã€‘: descriptionè¦ç´ ã®æ­£ç¢ºãªæŠ½å‡ºã‚’ç¢ºèª ğŸŸ¢
      expect(result.metadata!.author).toBe('ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼'); // ã€ç¢ºèªå†…å®¹ã€‘: authorè¦ç´ ã®æ­£ç¢ºãªæŠ½å‡ºã‚’ç¢ºèª ğŸŸ¢
      expect(result.metadata!.tags).toEqual(['fantasy', 'character', 'landscape']); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¿ã‚°é…åˆ—ãŒæ­£ç¢ºã«æŠ½å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.presets).toHaveLength(1); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ—ãƒªã‚»ãƒƒãƒˆé…åˆ—ãŒæ­£ç¢ºã«è§£æã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.errors).toHaveLength(0); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.warnings).toHaveLength(0); // ã€ç¢ºèªå†…å®¹ã€‘: è­¦å‘ŠãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('TC002: commonPromptsãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒçœç•¥ã•ã‚ŒãŸæ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ä»»æ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®çœç•¥ã«å¯¾ã™ã‚‹é©åˆ‡ãªå‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: commonPromptsãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã—ã§ã®æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆèª­ã¿è¾¼ã¿
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: commonPromptsãªã—ã§ã‚‚æ­£å¸¸ã«å‡¦ç†ã•ã‚Œã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: TypeScriptä»•æ§˜ã¨PromptFileV1ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æœ€å°é™ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ã‚’å«ã‚€ã‚±ãƒ¼ã‚¹ã‚’ç”¨æ„
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: commonPromptsãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é™¤å¤–ã—ãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ 
      const minimalNewFormatData = JSON.stringify({
        version: '1.0',
        metadata: {
          name: 'ãƒŸãƒ‹ãƒãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆ',
        },
        presets: [
          {
            name: 'ã‚·ãƒ³ãƒ—ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆ',
            prompt: 'simple prompt',
          },
        ],
      });

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: æœ€å°æ§‹æˆã§ã®æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆèª­ã¿è¾¼ã¿å‡¦ç†
      // ã€å‡¦ç†å†…å®¹ã€‘: ä»»æ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰çœç•¥æ™‚ã®é©åˆ‡ãªå‡¦ç†ç¢ºèª
      const result = await metadataManager.loadPromptFile(minimalNewFormatData);

      // ã€çµæœæ¤œè¨¼ã€‘: ä»»æ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰çœç•¥ã§ã‚‚æ­£å¸¸ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: commonPromptsãŒundefinedã¨ã—ã¦é©åˆ‡ã«æ‰±ã‚ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
      expect(result.success).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: ä»»æ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰çœç•¥ã§ã‚‚èª­ã¿è¾¼ã¿ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.metadata!.name).toBe('ãƒŸãƒ‹ãƒãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆ'); // ã€ç¢ºèªå†…å®¹ã€‘: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰nameè¦ç´ ãŒæ­£ç¢ºã«æŠ½å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.presets).toHaveLength(1); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ—ãƒªã‚»ãƒƒãƒˆé…åˆ—ãŒæ­£ç¢ºã«è§£æã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.errors).toHaveLength(0); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });
  });

  describe('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ»ç®¡ç†æ©Ÿèƒ½', () => {
    test('TC003: èª­ã¿è¾¼ã‚“ã ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ç”»é¢è¡¨ç¤ºæ©Ÿèƒ½', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: MetadataDisplayResultå½¢å¼ã§ã®ç”»é¢è¡¨ç¤ºãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ç”»é¢è¡¨ç¤ºç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›å‡¦ç†
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ¸ˆã¿ã®å®‰å…¨ãªè¡¨ç¤ºãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã¨UIä»•æ§˜ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å«æœ‰ã®ä»£è¡¨çš„ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ISO 8601æ—¥æ™‚ã¨HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ãŒå¿…è¦ãªæ–‡å­—ã‚’å«ã‚€
      const testMetadata: MetadataV1 = {
        name: 'ãƒ†ã‚¹ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆé›†',
        description: 'ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³',
        author: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
        created: '2024-01-01T00:00:00Z',
        modified: '2024-01-02T00:00:00Z',
        tags: ['fantasy', 'character', 'landscape'],
        license: 'CC BY 4.0',
        source: 'https://example.com',
      };

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: ISO 8601ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯èª­å½¢å¼ã¸ã®å¤‰æ›ã¨HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
      const result = metadataManager.formatMetadataForDisplay(testMetadata);

      // ã€çµæœæ¤œè¨¼ã€‘: è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ãŒé©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‡¦ç†ã®æ­£ç¢ºæ€§ã‚’æ¤œè¨¼
      expect(result.name).toBe('ãƒ†ã‚¹ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆé›†'); // ã€ç¢ºèªå†…å®¹ã€‘: nameè¦ç´ ãŒæ­£ç¢ºã«å¤‰æ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.description).toBe('ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³'); // ã€ç¢ºèªå†…å®¹ã€‘: descriptionè¦ç´ ãŒæ­£ç¢ºã«å¤‰æ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.author).toBe('ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼'); // ã€ç¢ºèªå†…å®¹ã€‘: authorè¦ç´ ãŒæ­£ç¢ºã«å¤‰æ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.dateCreated).toBe('2024å¹´1æœˆ1æ—¥'); // ã€ç¢ºèªå†…å®¹ã€‘: ISO 8601ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯èª­å½¢å¼ã¸ã®å¤‰æ›ã‚’ç¢ºèª ğŸŸ¢
      expect(result.dateModified).toBe('2024å¹´1æœˆ2æ—¥'); // ã€ç¢ºèªå†…å®¹ã€‘: æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ä¸€è²«æ€§ã‚’ç¢ºèª ğŸŸ¢
      expect(result.tags).toEqual(['fantasy', 'character', 'landscape']); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¿ã‚°é…åˆ—ãŒæ­£ç¢ºã«å¤‰æ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.license).toBe('CC BY 4.0'); // ã€ç¢ºèªå†…å®¹ã€‘: licenseè¦ç´ ãŒæ­£ç¢ºã«å¤‰æ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.source).toBe('https://example.com'); // ã€ç¢ºèªå†…å®¹ã€‘: sourceè¦ç´ ãŒæ­£ç¢ºã«å¤‰æ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('TC004: ã‚¿ã‚°ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã¨é¸æŠæ©Ÿèƒ½ï¼ˆé‡è¤‡é™¤å»ï¼‰', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚¿ã‚°é…åˆ—ã®è¡¨ç¤ºã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªé¸æŠå‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: é‡è¤‡ã‚¿ã‚°ã®é™¤å»å‡¦ç†ã¨ã‚¿ã‚°ä¸€è¦§è¡¨ç¤ºæ©Ÿèƒ½
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: é‡è¤‡é™¤å»æ¸ˆã¿ã®ã‚¿ã‚°ä¸€è¦§è¡¨ç¤ºã¨é¸æŠçŠ¶æ…‹ç®¡ç†
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: REQ-102-104ã¨ã‚¿ã‚°ç®¡ç†ä»•æ§˜ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã§ç™ºç”Ÿã—ã†ã‚‹é‡è¤‡ã‚¿ã‚°ã‚’å«ã‚€ãƒ‡ãƒ¼ã‚¿
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: æ„å›³çš„ã«é‡è¤‡ã‚’å«ã‚€ã‚¿ã‚°é…åˆ—
      const metadataWithDuplicateTags: MetadataV1 = {
        name: 'ãƒ†ã‚¹ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆ',
        tags: ['fantasy', 'character', 'landscape', 'fantasy', 'character'],
      };

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¿ã‚°ã®é‡è¤‡é™¤å»ã¨ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: é‡è¤‡é™¤å»ã€Unicodeæ­£è¦åŒ–ã€ä¸¦ã³é †æ•´ç†
      const result = metadataManager.sanitizeMetadata(metadataWithDuplicateTags);

      // ã€çµæœæ¤œè¨¼ã€‘: é‡è¤‡ã‚¿ã‚°ãŒé©åˆ‡ã«é™¤å»ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: REQ-102-104ã®é‡è¤‡ã‚¿ã‚°é™¤å»è¦ä»¶ã«æº–æ‹ ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      expect(result.tags).toEqual(['fantasy', 'character', 'landscape']); // ã€ç¢ºèªå†…å®¹ã€‘: é‡è¤‡ã‚¿ã‚°ãŒé™¤å»ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.tags).toHaveLength(3); // ã€ç¢ºèªå†…å®¹ã€‘: é™¤å»å¾Œã®ã‚¿ã‚°æ•°ãŒæ­£ç¢ºã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });
  });

  describe('ã‚¿ã‚°ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½', () => {
    test('TC005: å˜ä¸€ã‚¿ã‚°ã‚’é¸æŠã—ãŸå ´åˆã®ãƒ—ãƒªã‚»ãƒƒãƒˆçµã‚Šè¾¼ã¿', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: æŒ‡å®šã‚¿ã‚°ã‚’å«ã‚€ãƒ—ãƒªã‚»ãƒƒãƒˆã®ã¿ã®æŠ½å‡ºå‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: å˜ä¸€ã‚¿ã‚°ã§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°æ¡ä»¶ã§ã®é«˜é€Ÿãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆâ‰¤100msï¼‰
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: NFR-102-002æ€§èƒ½è¦ä»¶ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»•æ§˜ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å…¸å‹çš„ãªå˜ä¸€ã‚¿ã‚°æ¤œç´¢ã‚·ãƒŠãƒªã‚ªã‚’æƒ³å®šã—ãŸãƒ—ãƒªã‚»ãƒƒãƒˆé…åˆ—
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: 3å€‹ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã®ã†ã¡1å€‹ãŒfantasyã‚¿ã‚°ã‚’å«æœ‰
      const testPresets: PresetV1[] = [
        {
          name: 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼é¢¨æ™¯',
          prompt: 'fantasy landscape',
          tags: ['fantasy', 'landscape'],
        } as any,
        {
          name: 'ãƒªã‚¢ãƒ«äººç‰©',
          prompt: 'realistic person',
          tags: ['realistic', 'character'],
        } as any,
        {
          name: 'æŠ½è±¡ã‚¢ãƒ¼ãƒˆ',
          prompt: 'abstract art',
          tags: ['abstract', 'art'],
        } as any,
      ];
      const selectedTags = ['fantasy'];

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: å˜ä¸€ã‚¿ã‚°ã§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ã€æ€§èƒ½æ¸¬å®šã€çµæœé›†è¨ˆ
      const startTime = performance.now();
      const result = metadataManager.filterPresetsByTags(testPresets, selectedTags);
      const endTime = performance.now();

      // ã€çµæœæ¤œè¨¼ã€‘: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœã¨æ€§èƒ½è¦ä»¶ã®ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ã®ç²¾åº¦ã¨æ€§èƒ½è¦ä»¶ï¼ˆ100msä»¥å†…ï¼‰ã‚’æ¤œè¨¼
      expect(result.filteredPresets).toHaveLength(1); // ã€ç¢ºèªå†…å®¹ã€‘: fantasyã‚¿ã‚°ã‚’å«ã‚€ãƒ—ãƒªã‚»ãƒƒãƒˆãŒ1å€‹æŠ½å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.matchCount).toBe(1); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒãƒƒãƒãƒ³ã‚°æ•°ãŒæ­£ç¢ºã«ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.appliedTags).toEqual(['fantasy']); // ã€ç¢ºèªå†…å®¹ã€‘: é©ç”¨ã•ã‚ŒãŸã‚¿ã‚°ãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.filteredPresets[0].name).toBe('ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼é¢¨æ™¯'); // ã€ç¢ºèªå†…å®¹ã€‘: æ­£ã—ã„ãƒ—ãƒªã‚»ãƒƒãƒˆãŒæŠ½å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(endTime - startTime).toBeLessThan(100); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†ãŒ100msä»¥å†…ã«å®Œäº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('TC006: è¤‡æ•°ã‚¿ã‚°ã‚’é¸æŠã—ãŸå ´åˆã®ANDæ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã™ã¹ã¦ã®æŒ‡å®šã‚¿ã‚°ã‚’å«ã‚€ãƒ—ãƒªã‚»ãƒƒãƒˆã®ã¿ã®æŠ½å‡ºå‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: è¤‡æ•°ã‚¿ã‚°ã§ã®ANDæ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: äº¤é›†åˆæ¡ä»¶ã§ã®å³å¯†ãªãƒãƒƒãƒãƒ³ã‚°
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»•æ§˜ã¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: è©³ç´°ãªçµã‚Šè¾¼ã¿æ¤œç´¢ã‚·ãƒŠãƒªã‚ªã‚’æƒ³å®šã—ãŸãƒ—ãƒªã‚»ãƒƒãƒˆé…åˆ—
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: 5å€‹ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã®ã†ã¡2å€‹ãŒä¸¡æ–¹ã®ã‚¿ã‚°ã‚’å«æœ‰
      const testPresets: PresetV1[] = [
        {
          name: 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼',
          prompt: 'fantasy character',
          tags: ['fantasy', 'character'],
        } as any,
        {
          name: 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼é¢¨æ™¯',
          prompt: 'fantasy landscape',
          tags: ['fantasy', 'landscape'],
        } as any,
        {
          name: 'ãƒªã‚¢ãƒ«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼',
          prompt: 'realistic character',
          tags: ['realistic', 'character'],
        } as any,
        {
          name: 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼2',
          prompt: 'another fantasy character',
          tags: ['fantasy', 'character', 'detailed'],
        } as any,
        {
          name: 'æŠ½è±¡ã‚¢ãƒ¼ãƒˆ',
          prompt: 'abstract art',
          tags: ['abstract', 'art'],
        } as any,
      ];
      const selectedTags = ['fantasy', 'character'];

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: è¤‡æ•°ã‚¿ã‚°ã§ã®ANDæ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: äº¤é›†åˆæ¡ä»¶ã§ã®ã‚¿ã‚°ãƒãƒƒãƒãƒ³ã‚°ã€çµæœé›†è¨ˆ
      const result = metadataManager.filterPresetsByTags(testPresets, selectedTags);

      // ã€çµæœæ¤œè¨¼ã€‘: ANDæ¡ä»¶ã§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç²¾åº¦ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ANDè«–ç†æ¼”ç®—ã®æ­£ç¢ºæ€§ã¨æ€§èƒ½ç¶­æŒã‚’æ¤œè¨¼
      expect(result.filteredPresets).toHaveLength(2); // ã€ç¢ºèªå†…å®¹ã€‘: ä¸¡æ–¹ã®ã‚¿ã‚°ã‚’å«ã‚€ãƒ—ãƒªã‚»ãƒƒãƒˆãŒ2å€‹æŠ½å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.matchCount).toBe(2); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒãƒƒãƒãƒ³ã‚°æ•°ãŒæ­£ç¢ºã«ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.appliedTags).toEqual(['fantasy', 'character']); // ã€ç¢ºèªå†…å®¹ã€‘: é©ç”¨ã•ã‚ŒãŸã‚¿ã‚°ãŒæ­£ç¢ºã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.filteredPresets.map((p) => p.name)).toContain('ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼'); // ã€ç¢ºèªå†…å®¹ã€‘: æœŸå¾…ã•ã‚Œã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.filteredPresets.map((p) => p.name)).toContain('ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼2'); // ã€ç¢ºèªå†…å®¹ã€‘: è¿½åŠ ã‚¿ã‚°ã‚’æŒã¤ãƒ—ãƒªã‚»ãƒƒãƒˆã‚‚å«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });
  });

  describe('æ—¢å­˜å½¢å¼ã¨ã®äº’æ›æ€§æ©Ÿèƒ½', () => {
    test('TC007: ãƒ¬ã‚¬ã‚·ãƒ¼JSONå½¢å¼ã®æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¸ã®è‡ªå‹•å¤‰æ›', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: LegacyPromptFile â†’ PromptFileV1ã®å¤‰æ›å‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: æ—§JSONå½¢å¼ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¸ã®è‡ªå‹•å¤‰æ›ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è£œå®Œ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¸è¶³éƒ¨åˆ†ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è£œå®Œã¨å¤‰æ›ï¼ˆâ‰¤500msï¼‰
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: REQ-102-101/102/103äº’æ›æ€§è¦ä»¶ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æœªå¯¾å¿œã®æ—¢å­˜ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæ¬ å¦‚ã—ãŸæ—§å½¢å¼ãƒ‡ãƒ¼ã‚¿
      const legacyData = {
        presets: [
          {
            name: 'æ—§å½¢å¼ãƒ—ãƒªã‚»ãƒƒãƒˆ',
            prompt: 'old format prompt',
            negative: 'old negative',
            parameters: { steps: 20, cfgScale: 7.0, sampler: 'k_euler' },
          },
        ],
      };

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒ¬ã‚¬ã‚·ãƒ¼å½¢å¼ã‹ã‚‰æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¸ã®å¤‰æ›å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¤œå‡ºã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è£œå®Œã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±è¿½åŠ 
      const startTime = performance.now();
      const result = await metadataManager.convertLegacyFormat(legacyData);
      const endTime = performance.now();

      // ã€çµæœæ¤œè¨¼ã€‘: å¤‰æ›çµæœã®æ­£ç¢ºæ€§ã¨æ€§èƒ½è¦ä»¶ã®ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: REQ-102-101ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®šè¦ä»¶ã¨æ€§èƒ½è¦ä»¶ï¼ˆ500msä»¥å†…ï¼‰ã‚’æ¤œè¨¼
      expect(result.success).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¬ã‚¬ã‚·ãƒ¼å½¢å¼ã®å¤‰æ›ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.convertedData).toBeDefined(); // ã€ç¢ºèªå†…å®¹ã€‘: å¤‰æ›ãƒ‡ãƒ¼ã‚¿ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.convertedData!.version).toBe('1.0'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒæ­£ç¢ºã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.convertedData!.metadata.name).toBe('[ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ç”Ÿæˆ]'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.convertedData!.presets).toHaveLength(1); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ—ãƒªã‚»ãƒƒãƒˆé…åˆ—ãŒæ­£ç¢ºã«å¤‰æ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.warnings).toContain('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¾ã—ãŸ'); // ã€ç¢ºèªå†…å®¹ã€‘: é©åˆ‡ãªè­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.errors).toHaveLength(0); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(endTime - startTime).toBeLessThan(500); // ã€ç¢ºèªå†…å®¹ã€‘: å¤‰æ›å‡¦ç†ãŒ500msä»¥å†…ã«å®Œäº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });
  });

  describe('ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ©Ÿèƒ½', () => {
    test('TC008: JSONæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: JSON.parse()ã§è§£æã§ããªã„ä¸æ­£ãªæ§‹æ–‡ã®é©åˆ‡ãªãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ä¸æ­£ãªJSONæ§‹æ–‡ã«å¯¾ã™ã‚‹ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ•ã‚¡ã‚¤ãƒ«ç ´æã‚„æ‰‹å‹•ç·¨é›†ãƒŸã‚¹ã‹ã‚‰ä¿è­·ã™ã‚‹å®‰å…¨ãªå‡¦ç†
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨JSONæ¨™æº–ä»•æ§˜ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æ‰‹å‹•ç·¨é›†ä¸­ã®ä¿å­˜ãƒŸã‚¹ã‚„ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ä¸­ã®ç ´æã‚’æƒ³å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: é–‰ã˜æ‹¬å¼§ä¸è¶³ã«ã‚ˆã‚‹JSONæ§‹æ–‡é•å
      const invalidJsonData = '{"version": "1.0", "metadata": {';

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ä¸æ­£JSONæ§‹æ–‡ã®èª­ã¿è¾¼ã¿å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: JSONæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã®æ¤œå‡ºã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
      const result = await metadataManager.loadPromptFile(invalidJsonData);

      // ã€çµæœæ¤œè¨¼ã€‘: JSONæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã®é©åˆ‡ãªãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: å…·ä½“çš„ãªæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ä½ç½®ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ä¿®æ­£æ¡ˆã®æç¤º
      expect(result.success).toBe(false); // ã€ç¢ºèªå†…å®¹ã€‘: JSONæ§‹æ–‡ã‚¨ãƒ©ãƒ¼æ™‚ã«å¤±æ•—ã¨ã—ã¦å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.errors).toContain('JSONæ§‹æ–‡ã‚¨ãƒ©ãƒ¼: line 1, unexpected token'); // ã€ç¢ºèªå†…å®¹ã€‘: é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.metadata).toBeUndefined(); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæœªå®šç¾©ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.presets).toBeUndefined(); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒ—ãƒªã‚»ãƒƒãƒˆãŒæœªå®šç¾©ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('TC009: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: version "2.0"ç­‰ã®æœªçŸ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šã®é©åˆ‡ãªå‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: æœªå¯¾å¿œãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ã¨å°†æ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã®äº’æ›æ€§ç¢ºä¿
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: äºˆæœŸã—ãªã„å‹•ä½œã®é˜²æ­¢ã¨æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼é€šçŸ¥
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: REQ-102-103ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†è¦ä»¶ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒ—ãƒªã§ã®ä½¿ç”¨ã‚’æƒ³å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ç¾åœ¨å¯¾å¿œå¯èƒ½ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ "1.0" ä»¥å¤–ã®æŒ‡å®š
      const unsupportedVersionData = JSON.stringify({
        version: '2.0',
        metadata: { name: 'ãƒ†ã‚¹ãƒˆ' },
        presets: [],
      });

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: æœªå¯¾å¿œãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¤œè¨¼ã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
      const result = await metadataManager.loadPromptFile(unsupportedVersionData);

      // ã€çµæœæ¤œè¨¼ã€‘: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†æ©Ÿèƒ½ã®ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ç¾åœ¨å¯¾å¿œãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ˜ç¤ºã¨ä»£æ›¿æ¡ˆæç¤º
      expect(result.success).toBe(false); // ã€ç¢ºèªå†…å®¹ã€‘: æœªå¯¾å¿œãƒãƒ¼ã‚¸ãƒ§ãƒ³æ™‚ã«å¤±æ•—ã¨ã—ã¦å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.warnings).toContain('ãƒãƒ¼ã‚¸ãƒ§ãƒ³2.0ã¯æœªå¯¾å¿œã§ã™'); // ã€ç¢ºèªå†…å®¹ã€‘: é©åˆ‡ãªè­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.errors).toContain('å¯¾å¿œå¯èƒ½ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0'); // ã€ç¢ºèªå†…å®¹ã€‘: å¯¾å¿œå¯èƒ½ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæ˜ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('TC010: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸è¶³ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: MetadataV1.nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æœªå®šç¾©ã®è‡ªå‹•ä¿®å¾©æ©Ÿèƒ½ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸è¶³æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®šã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºä¿ã¨UIè¡¨ç¤ºå•é¡Œã®é˜²æ­¢
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: REQ-102-101ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®šè¦ä»¶ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æ‰‹å‹•ä½œæˆæ™‚ã®è¨˜è¿°æ¼ã‚Œã‚„è‡ªå‹•ç”Ÿæˆæ™‚ã®ãƒã‚°ã‚’æƒ³å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¿…é ˆï¼ˆ1-100æ–‡å­—ï¼‰ã ãŒæœªå®šç¾©
      const missingNameData = JSON.stringify({
        version: '1.0',
        metadata: {
          description: 'åå‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã—',
          author: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
          // name ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³
        },
        presets: [],
      });

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸è¶³æ™‚ã®èª­ã¿è¾¼ã¿å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¤œè¨¼ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®šã€è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
      const result = await metadataManager.loadPromptFile(missingNameData);

      // ã€çµæœæ¤œè¨¼ã€‘: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸è¶³ã®è‡ªå‹•ä¿®å¾©æ©Ÿèƒ½ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: REQ-102-101ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®šã«ã‚ˆã‚‹å®‰å…¨ãªå¾©æ—§
      expect(result.success).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸è¶³ã§ã‚‚ä¿®å¾©ã«ã‚ˆã‚ŠæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.metadata!.name).toBe('[ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ç”Ÿæˆ]'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.warnings).toContain(
        'nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ç”Ÿæˆã—ã¾ã—ãŸ'
      ); // ã€ç¢ºèªå†…å®¹ã€‘: é©åˆ‡ãªè­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.errors).toHaveLength(0); // ã€ç¢ºèªå†…å®¹ã€‘: è‡ªå‹•ä¿®å¾©ã«ã‚ˆã‚Šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('TC012: XSSæ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡ºã¨ç„¡å®³åŒ–', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: HTMLã‚¹ã‚¯ãƒªãƒ—ãƒˆæ³¨å…¥æ”»æ’ƒã®æ¤œå‡ºã¨ç„¡å®³åŒ–å‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¸ã®HTMLã‚¿ã‚°/JavaScriptæ³¨å…¥ã®é˜²æ­¢
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: XSSæ”»æ’ƒé˜²æ­¢ã¨UIè¡¨ç¤ºã®å®‰å…¨æ€§ç¢ºä¿
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶REQ-102-401ã¨XSSé˜²æ­¢ä»•æ§˜ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æ‚ªæ„ã®ã‚ã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®é…å¸ƒã‚„å…±æœ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®æ”¹ã–ã‚“ã‚’æƒ³å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: HTMLã‚¿ã‚°ã¨JavaScriptã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€æ‚ªæ„ã®ã‚ã‚‹å…¥åŠ›
      const maliciousMetadata: MetadataV1 = {
        name: "<script>alert('XSS')</script>æ‚ªæ„ã®ã‚ã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆ",
        description: "<img src=x onerror=alert('XSS')>èª¬æ˜æ–‡",
        author: "<iframe src='javascript:alert(1)'></iframe>",
      };

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã«ã‚ˆã‚‹å®Œå…¨ãªç„¡å®³åŒ–å‡¦ç†
      const result = metadataManager.sanitizeMetadata(maliciousMetadata);

      // ã€çµæœæ¤œè¨¼ã€‘: XSSæ”»æ’ƒé˜²æ­¢æ©Ÿèƒ½ã®ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã«ã‚ˆã‚‹å®Œå…¨ãªç„¡å®³åŒ–ã®å®Ÿç¾
      expect(result.name).toBe("&lt;script&gt;alert('XSS')&lt;/script&gt;æ‚ªæ„ã®ã‚ã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆ"); // ã€ç¢ºèªå†…å®¹ã€‘: HTMLã‚¿ã‚°ãŒé©åˆ‡ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.description).toBe("&lt;img src=x onerror=alert('XSS')&gt;èª¬æ˜æ–‡"); // ã€ç¢ºèªå†…å®¹ã€‘: HTMLå±æ€§ãŒé©åˆ‡ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.author).toBe("&lt;iframe src='javascript:alert(1)'&gt;&lt;/iframe&gt;"); // ã€ç¢ºèªå†…å®¹ã€‘: JavaScriptã‚³ãƒ¼ãƒ‰ãŒé©åˆ‡ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('TC013: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™è¶…éã‚¨ãƒ©ãƒ¼ã®å‡¦ç†', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: 10MBåˆ¶é™ã‚’è¶…éã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®é©åˆ‡ãªå‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™ã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªä¸è¶³é˜²æ­¢ã¨ã‚·ã‚¹ãƒ†ãƒ å®‰å®šæ€§ç¢ºä¿
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡åˆ¶å¾¡ã«ã‚ˆã‚‹å®‰å®šå‹•ä½œã®ç¶­æŒ
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶ç´„ã¨ã‚·ã‚¹ãƒ†ãƒ å®‰å®šæ€§è¦ä»¶ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å¤§é‡ãƒ—ãƒªã‚»ãƒƒãƒˆé›†ç´„ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ç”»åƒåŸ‹ã‚è¾¼ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æƒ³å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: æ—¢å­˜åˆ¶ç´„ã®10MBåˆ¶é™ã‚’è¶…éã™ã‚‹ãƒ‡ãƒ¼ã‚¿
      const oversizedData = 'A'.repeat(10 * 1024 * 1024 + 1); // 10MB + 1ãƒã‚¤ãƒˆ

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºæ¤œè¨¼å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
      const result = metadataManager.validateFileSize(oversizedData);

      // ã€çµæœæ¤œè¨¼ã€‘: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™æ©Ÿèƒ½ã®ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: åˆ¶é™å€¤ã®æ˜ç¤ºã¨åˆ†å‰²ææ¡ˆã«ã‚ˆã‚‹é©åˆ‡ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
      expect(result).toBe(false); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºè¶…éæ™‚ã«falseãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });
  });

  describe('å¢ƒç•Œå€¤å‡¦ç†æ©Ÿèƒ½', () => {
    test('TC015: nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœ€å°å€¤å¢ƒç•Œï¼ˆ1æ–‡å­—ï¼‰ã§ã®å‡¦ç†', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¸‹é™å€¤ï¼ˆ1æ–‡å­—ï¼‰ã§ã®å‹•ä½œä¿è¨¼ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: æœ€å°æ–‡å­—æ•°å¢ƒç•Œã§ã®å®‰å®šå‹•ä½œç¢ºèª
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 1æ–‡å­—ã§ã‚‚é©åˆ‡ã«UIè¡¨ç¤ºã•ã‚Œã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: MetadataV1ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä»•æ§˜ï¼ˆ1-100æ–‡å­—ï¼‰ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç°¡æ½”ãªå‘½åè¦å‰‡ã‚„ç•¥ç§°ä½¿ç”¨æ™‚ã‚’æƒ³å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä»•æ§˜ã€Œ1-100æ–‡å­—ã€ã®ä¸‹é™å€¤
      const minimalData = JSON.stringify({
        version: '1.0',
        metadata: { name: 'A' }, // 1æ–‡å­—ï¼ˆæœ€å°æœ‰åŠ¹å€¤ï¼‰
        presets: [],
      });

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: æœ€å°æ–‡å­—æ•°ã§ã®èª­ã¿è¾¼ã¿å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: æ–‡å­—æ•°æ¤œè¨¼ã¨å¢ƒç•Œå€¤å‡¦ç†
      const result = await metadataManager.loadPromptFile(minimalData);

      // ã€çµæœæ¤œè¨¼ã€‘: æœ€å°æ–‡å­—æ•°å¢ƒç•Œã§ã®å‹•ä½œç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: æ¥µç«¯ã«çŸ­ã„å…¥åŠ›ã§ã‚‚å®‰å®šå‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      expect(result.success).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: 1æ–‡å­—ã®nameè¦ç´ ã§ã‚‚æ­£å¸¸ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.metadata!.name).toBe('A'); // ã€ç¢ºèªå†…å®¹ã€‘: 1æ–‡å­—ã®nameè¦ç´ ãŒæ­£ç¢ºã«ä¿æŒã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('TC016: nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœ€å¤§å€¤å¢ƒç•Œï¼ˆ100æ–‡å­—ï¼‰ã§ã®å‡¦ç†', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¸Šé™å€¤ï¼ˆ100æ–‡å­—ï¼‰ã§ã®å‹•ä½œä¿è¨¼ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: æœ€å¤§æ–‡å­—æ•°å¢ƒç•Œã§ã®å®‰å®šå‹•ä½œç¢ºèª
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 100æ–‡å­—ã§ã‚‚UIè¡¨ç¤ºãŒé©åˆ‡ã«åã¾ã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: MetadataV1ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä»•æ§˜ã¨UIè¨­è¨ˆåˆ¶ç´„ã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: è©³ç´°ãªèª¬æ˜ã‚’å«ã‚€é•·ã„åå‰ã‚’æƒ³å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä»•æ§˜ã€Œ1-100æ–‡å­—ã€ã®ä¸Šé™å€¤
      const maximalData = JSON.stringify({
        version: '1.0',
        metadata: { name: 'A'.repeat(100) }, // 100æ–‡å­—ï¼ˆæœ€å¤§æœ‰åŠ¹å€¤ï¼‰
        presets: [],
      });

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: æœ€å¤§æ–‡å­—æ•°ã§ã®èª­ã¿è¾¼ã¿å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: æ–‡å­—æ•°æ¤œè¨¼ã¨å¢ƒç•Œå€¤å‡¦ç†
      const result = await metadataManager.loadPromptFile(maximalData);

      // ã€çµæœæ¤œè¨¼ã€‘: æœ€å¤§æ–‡å­—æ•°å¢ƒç•Œã§ã®å‹•ä½œç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: UIåˆ¶é™ã‚®ãƒªã‚®ãƒªã§ã‚‚å®‰å®šè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
      expect(result.success).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: 100æ–‡å­—ã®nameè¦ç´ ã§ã‚‚æ­£å¸¸ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.metadata!.name).toBe('A'.repeat(100)); // ã€ç¢ºèªå†…å®¹ã€‘: 100æ–‡å­—ã®nameè¦ç´ ãŒæ­£ç¢ºã«ä¿æŒã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.metadata!.name.length).toBe(100); // ã€ç¢ºèªå†…å®¹ã€‘: æ–‡å­—æ•°ãŒæ­£ç¢ºã«100æ–‡å­—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('TC024: Unicodeç‰¹æ®Šæ–‡å­—ã®å¢ƒç•Œå€¤å‡¦ç†', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: Unicodeæ–‡å­—ã‚»ãƒƒãƒˆã®ç‰¹æ®Šç¯„å›²ã§ã®å‹•ä½œä¿è¨¼ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: Unicodeç‰¹æ®Šæ–‡å­—ï¼ˆçµµæ–‡å­—ã€CJKçµ±åˆæ¼¢å­—ï¼‰ã®å‡¦ç†
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ç‰¹æ®Šæ–‡å­—ã§ã‚‚æ–‡å­—æ•°è¨ˆç®—ã¨è¡¨ç¤ºãŒæ­£ç¢º
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: REQ-102-402ã®Unicodeæ­£è¦åŒ–è¦ä»¶ã¨å›½éš›åŒ–å¯¾å¿œã«åŸºã¥ã

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å›½éš›åŒ–å¯¾å¿œã‚„çµµæ–‡å­—ã‚’ä½¿ã£ãŸè¦–è¦šçš„åˆ†é¡ã‚’æƒ³å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: Unicodeæ­£è¦åŒ–ã¨ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—ã®å‡¦ç†ç¢ºèª
      const unicodeData = JSON.stringify({
        version: '1.0',
        metadata: {
          name: 'ğŸ¨âœ¨é­”æ³•ã®ãƒ—ãƒªã‚»ãƒƒãƒˆé›†ğŸ‘‘', // çµµæ–‡å­—+æ¼¢å­—
          tags: ['ğŸŒ¸æ˜¥', 'ğŸ‚ç§‹', 'â„ï¸å†¬'], // çµµæ–‡å­—ã‚¿ã‚°
        },
        presets: [],
      });

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: Unicodeç‰¹æ®Šæ–‡å­—ã§ã®èª­ã¿è¾¼ã¿å‡¦ç†ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: Unicodeæ­£è¦åŒ–ï¼ˆNFCï¼‰ã¨ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—å‡¦ç†
      const result = await metadataManager.loadPromptFile(unicodeData);

      // ã€çµæœæ¤œè¨¼ã€‘: Unicodeå‡¦ç†ã®å¢ƒç•Œç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ç‰¹æ®Šæ–‡å­—ã§ã‚‚æ–‡å­—åŒ–ã‘ã‚„å‡¦ç†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’æ¤œè¨¼
      expect(result.success).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: Unicodeç‰¹æ®Šæ–‡å­—ã§ã‚‚æ­£å¸¸ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.metadata!.name).toBe('ğŸ¨âœ¨é­”æ³•ã®ãƒ—ãƒªã‚»ãƒƒãƒˆé›†ğŸ‘‘'); // ã€ç¢ºèªå†…å®¹ã€‘: çµµæ–‡å­—+æ¼¢å­—ã®çµ„ã¿åˆã‚ã›ãŒæ­£ç¢ºã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(result.metadata!.tags).toEqual(['ğŸŒ¸æ˜¥', 'ğŸ‚ç§‹', 'â„ï¸å†¬']); // ã€ç¢ºèªå†…å®¹ã€‘: çµµæ–‡å­—ã‚¿ã‚°ãŒæ­£ç¢ºã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });
  });
});
