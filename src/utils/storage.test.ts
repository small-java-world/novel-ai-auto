// ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: src/utils/storage.test.ts
import { describe, test, expect, beforeEach, afterEach, vi } from 'vitest';
import { StorageAPI, createStorage } from './storage';

// Chrome Storage API ãƒ¢ãƒƒã‚¯è¨­å®š
const mockChromeStorage = {
  local: {
    get: vi.fn(),
    set: vi.fn(),
    clear: vi.fn(),
    onChanged: {
      addListener: vi.fn(),
      removeListener: vi.fn(),
    },
  },
};

// ã‚°ãƒ­ãƒ¼ãƒãƒ«chromeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¢ãƒƒã‚¯
(globalThis as any).chrome = {
  storage: mockChromeStorage,
  runtime: {
    lastError: undefined,
  },
};

describe('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼å®Ÿè£…', () => {
  let storage: StorageAPI;

  beforeEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«Chromeã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ãƒ¢ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ä¸€è²«ã—ãŸãƒ†ã‚¹ãƒˆæ¡ä»¶ã‚’ä¿è¨¼
    // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: å‰ã®ãƒ†ã‚¹ãƒˆã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¢ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ãƒªã‚»ãƒƒãƒˆ
    vi.clearAllMocks();
    mockChromeStorage.local.get.mockResolvedValue({});
    mockChromeStorage.local.set.mockResolvedValue(undefined);
    storage = createStorage();
  });

  afterEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†ã€‘: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚„ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    // ã€çŠ¶æ…‹å¾©å…ƒã€‘: æ¬¡ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
    vi.clearAllMocks();
  });

  describe('åŸºæœ¬çš„ãªget/setæ“ä½œ', () => {
    test('settingsåå‰ç©ºé–“ã¸ã®ä¿å­˜ã¨å–å¾—ã®æ•´åˆæ€§', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: settingsåå‰ç©ºé–“ã«ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒæ­£ç¢ºã«å–å¾—ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’setã§ä¿å­˜ã—ã€getã§å–å¾—ã—ã¦åŒã˜å€¤ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ä¿å­˜ã—ãŸè¨­å®šãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«ä¸€è‡´ã—ãŸçŠ¶æ…‹ã§å–å¾—ã§ãã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚¿ã‚¹ã‚¯å®šç¾©ã®å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶ã€Œget/setã®æ•´åˆã€ã«åŸºã¥ãç¢ºå®Ÿãªãƒ†ã‚¹ãƒˆ

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å®Ÿéš›ã®è¨­å®šãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«åŸºã¥ã„ãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: Chromeæ‹¡å¼µæ©Ÿèƒ½ã§ä½¿ç”¨ã•ã‚Œã‚‹å…¸å‹çš„ãªè¨­å®šå€¤ã‚’è¨­å®š
      const testSettings = {
        imageCount: 5,
        seed: 12345,
        filenameTemplate: '{date}_{prompt}_{seed}_{idx}',
        retrySettings: {
          maxAttempts: 3,
          baseDelayMs: 1000,
          factor: 2.0,
        },
      };

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã®setæ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—ã€settingsåå‰ç©ºé–“ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      // ã€å‡¦ç†å†…å®¹ã€‘: chrome.storage.local.setã‚’å†…éƒ¨ã§å‘¼ã³å‡ºã—ã€åå‰ç©ºé–“ä»˜ãã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹å‡¦ç†
      await storage.set('settings', testSettings);

      // Chrome API ãƒ¢ãƒƒã‚¯ã®è¨­å®š: ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒå–å¾—æ™‚ã«è¿”ã•ã‚Œã‚‹ã‚ˆã†è¨­å®š
      mockChromeStorage.local.get.mockResolvedValue({
        namespace_settings: testSettings,
      });

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã®getæ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—ã€settingsåå‰ç©ºé–“ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      // ã€å‡¦ç†å†…å®¹ã€‘: chrome.storage.local.getã‚’å†…éƒ¨ã§å‘¼ã³å‡ºã—ã€åå‰ç©ºé–“ä»˜ãã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å‡¦ç†
      const retrievedSettings = await storage.get('settings');

      // ã€çµæœæ¤œè¨¼ã€‘: ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã¨å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ·±ã„æ¯”è¼ƒã«ã‚ˆã‚Šã€ãƒã‚¹ãƒˆã—ãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¾ã§åŒã˜å€¤ã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      expect(retrievedSettings).toEqual(testSettings); // ã€ç¢ºèªå†…å®¹ã€‘: è¨­å®šãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨ä¸€è‡´ã‚’ç¢ºèªã—ã€ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ä¿è¨¼ ğŸŸ¢
      expect(mockChromeStorage.local.set).toHaveBeenCalledWith({
        namespace_settings: testSettings,
      }); // ã€ç¢ºèªå†…å®¹ã€‘: Chrome APIãŒæ­£ã—ã„åå‰ç©ºé–“ä»˜ãã‚­ãƒ¼ã§å‘¼ã³å‡ºã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('presetsåå‰ç©ºé–“ã¸ã®é…åˆ—ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨å–å¾—', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: presetsåå‰ç©ºé–“ã«é…åˆ—å½¢å¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ‡ãƒ¼ã‚¿ãŒæ­£ç¢ºã«ä¿å­˜ãƒ»å–å¾—ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆã®é…åˆ—ã‚’setã§ä¿å­˜ã—ã€getã§å–å¾—ã—ã¦åŒã˜é…åˆ—ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ä¿å­˜ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé…åˆ—ãŒé †åºã¨å†…å®¹ã‚’ä¿æŒã—ãŸçŠ¶æ…‹ã§å–å¾—ã§ãã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚¿ã‚¹ã‚¯å®šç¾©ã®åå‰ç©ºé–“ã€Œpresetsã€è¦ä»¶ã«åŸºã¥ãç¢ºå®Ÿãªãƒ†ã‚¹ãƒˆ

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: config/prompts.jsonã®æ§‹é€ ã«åŸºã¥ã„ãŸãƒ—ãƒªã‚»ãƒƒãƒˆé…åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: å®Ÿéš›ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¨¡æ“¬ã—ãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
      const testPresets = [
        {
          id: 'preset-1',
          name: 'Fantasy Character',
          prompt: 'beautiful fantasy character, detailed artwork',
          negative: 'low quality, blurry',
          parameters: {
            steps: 28,
            cfgScale: 7.5,
          },
        },
        {
          id: 'preset-2',
          name: 'Landscape',
          prompt: 'beautiful landscape, nature scenery',
          negative: 'people, buildings',
          parameters: {
            steps: 20,
            cfgScale: 8.0,
          },
        },
      ];

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã®setæ©Ÿèƒ½ã§presetsåå‰ç©ºé–“ã«é…åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      // ã€å‡¦ç†å†…å®¹ã€‘: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆé…åˆ—ã‚’JSONå½¢å¼ã§Chromeã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã™ã‚‹å‡¦ç†
      await storage.set('presets', testPresets);

      // Chrome API ãƒ¢ãƒƒã‚¯ã®è¨­å®š: ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒªã‚»ãƒƒãƒˆé…åˆ—ãŒå–å¾—æ™‚ã«è¿”ã•ã‚Œã‚‹ã‚ˆã†è¨­å®š
      mockChromeStorage.local.get.mockResolvedValue({
        namespace_presets: testPresets,
      });

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã®getæ©Ÿèƒ½ã§presetsåå‰ç©ºé–“ã‹ã‚‰é…åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      // ã€å‡¦ç†å†…å®¹ã€‘: chrome.storage.local.getã‚’å‘¼ã³å‡ºã—ã€ãƒ—ãƒªã‚»ãƒƒãƒˆé…åˆ—ã‚’JSONã‹ã‚‰å¾©å…ƒã™ã‚‹å‡¦ç†
      const retrievedPresets = await storage.get('presets');

      // ã€çµæœæ¤œè¨¼ã€‘: ä¿å­˜ã—ãŸãƒ—ãƒªã‚»ãƒƒãƒˆé…åˆ—ã¨å–å¾—ã—ãŸé…åˆ—ãŒå®Œå…¨ã«ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: é…åˆ—ã®è¦ç´ æ•°ã€é †åºã€å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å…¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒåŒã˜å€¤ã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      expect(retrievedPresets).toEqual(testPresets); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ—ãƒªã‚»ãƒƒãƒˆé…åˆ—ã®å®Œå…¨ä¸€è‡´ã‚’ç¢ºèªã—ã€é…åˆ—ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ä¿è¨¼ ğŸŸ¢
      expect(Array.isArray(retrievedPresets)).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: å–å¾—ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—å½¢å¼ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(retrievedPresets).toHaveLength(2); // ã€ç¢ºèªå†…å®¹ã€‘: é…åˆ—ã®è¦ç´ æ•°ãŒä¿å­˜æ™‚ã¨åŒã˜ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });
  });

  describe('åˆæœŸå€¤ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®å‡¦ç†', () => {
    test('æœªåˆæœŸåŒ–ã®settingsåå‰ç©ºé–“ã‹ã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å–å¾—', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: settingsåå‰ç©ºé–“ãŒæœªåˆæœŸåŒ–ã®å ´åˆã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒæ­£ã—ãè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ç©ºã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ…‹ã§settingsã‚’å–å¾—ã—ã€äºˆã‚å®šç¾©ã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒç©ºã§ã‚‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‚ˆã†ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãŒæä¾›ã•ã‚Œã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚¿ã‚¹ã‚¯å®šç¾©ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¦ä»¶ã€ŒæœªåˆæœŸåŒ–ã®å ´åˆã«æ—¢å®šå€¤ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ã«åŸºã¥ãç¢ºå®Ÿãªãƒ†ã‚¹ãƒˆ

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒç©ºã®çŠ¶æ…‹ã‚’æ¨¡æ“¬ï¼ˆChrome API ãŒç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ã‚±ãƒ¼ã‚¹ï¼‰
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: æ–°è¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã‚„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒã‚¯ãƒªã‚¢ã•ã‚ŒãŸçŠ¶æ…‹ã‚’æƒ³å®š
      mockChromeStorage.local.get.mockResolvedValue({});

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã®getæ©Ÿèƒ½ã§æœªåˆæœŸåŒ–ã®settingsã‚’å–å¾—
      // ã€å‡¦ç†å†…å®¹ã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒç©ºã®å ´åˆã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šå€¤ã‚’è¿”ã™ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆ
      const defaultSettings = await storage.get('settings');

      // ã€çµæœæ¤œè¨¼ã€‘: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸å‹•ä½œã™ã‚‹ãŸã‚ã«å¿…è¦ãªæœ€å°é™ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãŒæä¾›ã•ã‚Œã‚‹
      expect(defaultSettings).toEqual({
        imageCount: 1,
        seed: -1,
        filenameTemplate: '{date}_{prompt}_{seed}_{idx}',
        retrySettings: {
          maxAttempts: 5,
          baseDelayMs: 500,
          factor: 2.0,
        },
      }); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šå€¤ãŒä»•æ§˜é€šã‚Šã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(mockChromeStorage.local.get).toHaveBeenCalledWith(['namespace_settings']); // ã€ç¢ºèªå†…å®¹ã€‘: Chrome APIãŒæ­£ã—ã„ã‚­ãƒ¼ã§å‘¼ã³å‡ºã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('æœªåˆæœŸåŒ–ã®jobsåå‰ç©ºé–“ã‹ã‚‰ç©ºé…åˆ—ã‚’å–å¾—', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: jobsåå‰ç©ºé–“ãŒæœªåˆæœŸåŒ–ã®å ´åˆã«ç©ºé…åˆ—ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚¸ãƒ§ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒãªã„çŠ¶æ…‹ã§jobsã‚’å–å¾—ã—ã€ç©ºé…åˆ—ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¸ãƒ§ãƒ–å±¥æ­´ãŒãªã„æ–°è¦çŠ¶æ…‹ã§ã‚‚é…åˆ—æ“ä½œãŒå®‰å…¨ã«è¡Œãˆã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚¿ã‚¹ã‚¯å®šç¾©ã®åå‰ç©ºé–“ã€Œjobsã€è¦ä»¶ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«åŸºã¥ãç¢ºå®Ÿãªãƒ†ã‚¹ãƒˆ

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒç©ºã®çŠ¶æ…‹ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚¸ãƒ§ãƒ–å±¥æ­´ãŒãªã„åˆæœŸçŠ¶æ…‹ã‚’æƒ³å®š
      mockChromeStorage.local.get.mockResolvedValue({});

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã®getæ©Ÿèƒ½ã§æœªåˆæœŸåŒ–ã®jobsã‚’å–å¾—
      // ã€å‡¦ç†å†…å®¹ã€‘: é…åˆ—å‹ã®ãƒ‡ãƒ¼ã‚¿ãŒæœªåˆæœŸåŒ–ã®å ´åˆã«ç©ºé…åˆ—ã‚’è¿”ã™ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆ
      const defaultJobs = await storage.get('jobs');

      // ã€çµæœæ¤œè¨¼ã€‘: ç©ºé…åˆ—ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: é…åˆ—æ“ä½œãŒå®‰å…¨ã«è¡Œãˆã‚‹ã‚ˆã†ã€nullã‚„undefinedã§ã¯ãªãç©ºé…åˆ—ãŒè¿”ã•ã‚Œã‚‹
      expect(defaultJobs).toEqual([]); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç©ºé…åˆ—ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(Array.isArray(defaultJobs)).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: æˆ»ã‚Šå€¤ãŒé…åˆ—å‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });
  });

  describe('å¤‰æ›´ç›£è¦–æ©Ÿèƒ½', () => {
    test('settingsåå‰ç©ºé–“ã®å¤‰æ›´ã‚’ç›£è¦–ã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: settingsåå‰ç©ºé–“ã®å¤‰æ›´æ™‚ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ãŒæ­£ã—ãå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: observeãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç™»éŒ²ã—ã€settingså¤‰æ›´æ™‚ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã«UIã‚„ä»–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é€šçŸ¥ã•ã‚Œã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚¿ã‚¹ã‚¯å®šç¾©ã®å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶ã€Œå¤‰æ›´ç›£è¦–ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰ã€ã«åŸºã¥ãç¢ºå®Ÿãªãƒ†ã‚¹ãƒˆ

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å¤‰æ›´æ¤œçŸ¥ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ãƒ¢ãƒƒã‚¯ã‚’ç”¨æ„
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: Chrome storage onChanged ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æ§‹ç¯‰
      const mockCallback = vi.fn();
      const changeData = {
        namespace_settings: {
          newValue: { imageCount: 3 },
          oldValue: { imageCount: 1 },
        },
      };

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã®observeæ©Ÿèƒ½ã§settingså¤‰æ›´ç›£è¦–ã‚’é–‹å§‹
      // ã€å‡¦ç†å†…å®¹ã€‘: chrome.storage.onChanged.addListenerã‚’å†…éƒ¨ã§å‘¼ã³å‡ºã—ã€å¤‰æ›´ç›£è¦–ã‚’è¨­å®šã™ã‚‹å‡¦ç†
      storage.observe('settings', mockCallback);

      // Chrome storage onChanged ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‰‹å‹•ã§ç™ºç«ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
      const registeredCallback = mockChromeStorage.local.onChanged.addListener.mock.calls[0][0];
      registeredCallback(changeData, 'local');

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ãŒæ­£ã—ã„å¼•æ•°ã§å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: å¤‰æ›´ãƒ‡ãƒ¼ã‚¿ãŒé©åˆ‡ã«åŠ å·¥ã•ã‚Œã¦ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«æ¸¡ã•ã‚Œã‚‹
      expect(mockCallback).toHaveBeenCalledWith({
        newValue: { imageCount: 3 },
        oldValue: { imageCount: 1 },
      }); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå¤‰æ›´ãƒ‡ãƒ¼ã‚¿ã¨å…±ã«å‘¼ã³å‡ºã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(mockChromeStorage.local.onChanged.addListener).toHaveBeenCalledTimes(1); // ã€ç¢ºèªå†…å®¹ã€‘: Chrome APIã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒ1å›ã ã‘ç™»éŒ²ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('è¤‡æ•°ã®åå‰ç©ºé–“ã‚’åŒæ™‚ç›£è¦–ã™ã‚‹å ´åˆã®åˆ†é›¢å‡¦ç†', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: è¤‡æ•°ã®åå‰ç©ºé–“ã‚’åŒæ™‚ç›£è¦–ã—ãŸéš›ã«ã€é©åˆ‡ãªåå‰ç©ºé–“ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ã¿ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: settingsã¨jobsã®ä¸¡æ–¹ã‚’ç›£è¦–ã—ã€settingså¤‰æ›´æ™‚ã«ã¯settingsã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ã¿ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: åå‰ç©ºé–“ãŒåˆ†é›¢ã•ã‚Œã¦ãŠã‚Šã€ç„¡é–¢ä¿‚ãªå¤‰æ›´é€šçŸ¥ãŒé€ã‚‰ã‚Œãªã„
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚¿ã‚¹ã‚¯è¦ä»¶ã‹ã‚‰æ¨æ¸¬ã—ãŸé«˜åº¦ãªåˆ†é›¢æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: è¤‡æ•°ã®åå‰ç©ºé–“ç›£è¦–ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’åˆ†ã‘ã¦ç”¨æ„
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: settingsç”¨ã¨jobsç”¨ã®ç‹¬ç«‹ã—ãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨­å®š
      const settingsCallback = vi.fn();
      const jobsCallback = vi.fn();
      const changeData = {
        namespace_settings: {
          newValue: { imageCount: 5 },
          oldValue: { imageCount: 3 },
        },
      };

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã§è¤‡æ•°åå‰ç©ºé–“ã®ç›£è¦–ã‚’è¨­å®š
      // ã€å‡¦ç†å†…å®¹ã€‘: è¤‡æ•°ã®observeå‘¼ã³å‡ºã—ã§ç•°ãªã‚‹åå‰ç©ºé–“ã‚’åŒæ™‚ç›£è¦–ã™ã‚‹å‡¦ç†
      storage.observe('settings', settingsCallback);
      storage.observe('jobs', jobsCallback);

      // Chrome storage onChanged ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‰‹å‹•ã§ç™ºç«ï¼ˆsettingså¤‰æ›´ã®ã¿ï¼‰
      const registeredCallback = mockChromeStorage.local.onChanged.addListener.mock.calls[0][0];
      registeredCallback(changeData, 'local');

      // ã€çµæœæ¤œè¨¼ã€‘: è©²å½“ã™ã‚‹åå‰ç©ºé–“ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ã¿ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: settingså¤‰æ›´æ™‚ã«ã¯settingsã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ã¿ãŒå‘¼ã°ã‚Œã€jobsã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯å‘¼ã°ã‚Œãªã„
      expect(settingsCallback).toHaveBeenCalledTimes(1); // ã€ç¢ºèªå†…å®¹ã€‘: settingsã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒ1å›å®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      expect(jobsCallback).not.toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: jobsã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã—ã€åå‰ç©ºé–“åˆ†é›¢ã‚’æ¤œè¨¼ ğŸŸ¡
    });
  });

  describe('ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°', () => {
    test('Chrome storage APIã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: Chrome storage APIå‘¼ã³å‡ºã—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: Chrome APIãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ãŸå ´åˆã«ã€é©åˆ‡ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: APIã‚¨ãƒ©ãƒ¼ã§ã‚‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã›ãšã€å®‰å…¨ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚¿ã‚¹ã‚¯å®šç¾©ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¦ä»¶ã€Œå–å¾—å¤±æ•—æ™‚ã«æ—¢å®šå€¤ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ã«åŸºã¥ãç¢ºå®Ÿãªãƒ†ã‚¹ãƒˆ

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: Chrome API ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚¨ãƒ©ãƒ¼ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚’æƒ³å®š
      const storageError = new Error('Storage quota exceeded');
      mockChromeStorage.local.get.mockRejectedValue(storageError);

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹çŠ¶æ…‹ã§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã®getæ©Ÿèƒ½ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: Chrome API ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”ã™ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆ
      const result = await storage.get('settings');

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç¶™ç¶šå‹•ä½œã§ãã‚‹ã‚ˆã†é©åˆ‡ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ãŒæä¾›ã•ã‚Œã‚‹
      expect(result).toEqual({
        imageCount: 1,
        seed: -1,
        filenameTemplate: '{date}_{prompt}_{seed}_{idx}',
        retrySettings: {
          maxAttempts: 5,
          baseDelayMs: 500,
          factor: 2.0,
        },
      }); // ã€ç¢ºèªå†…å®¹ã€‘: APIã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã®ä¿å­˜æ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”å´', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºä¸å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜æ™‚ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: å¾ªç’°å‚ç…§ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã©ã€JSONåŒ–ã§ããªã„ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚’äº‹å‰ã«æ¤œçŸ¥ã—ã€æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æä¾›ã™ã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚¿ã‚¹ã‚¯å®šç¾©ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¦ä»¶ã€ŒJSONã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºæ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”å´ã—ãƒ­ã‚°è¨˜éŒ²ã€ã«åŸºã¥ãç¢ºå®Ÿãªãƒ†ã‚¹ãƒˆ

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºä¸å¯èƒ½ãªå¾ªç’°å‚ç…§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: JSON.stringify() ãŒå¤±æ•—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ„å›³çš„ã«ä½œæˆ
      const circularRef: any = { name: 'test' };
      circularRef.self = circularRef; // å¾ªç’°å‚ç…§ã‚’ä½œæˆ

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã®setæ©Ÿèƒ½ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆ
      const result = await storage.set('settings', circularRef);

      // ã€çµæœæ¤œè¨¼ã€‘: é©åˆ‡ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã¨ç†ç”±ãŒæ˜ç¢ºã«ç¤ºã•ã‚Œã€é–‹ç™ºè€…ãŒå•é¡Œã‚’ç‰¹å®šã§ãã‚‹
      expect(result).toEqual({
        success: false,
        error: 'Failed to serialize data: Converting circular structure to JSON',
        context: { namespace: 'settings' },
      }); // ã€ç¢ºèªå†…å®¹ã€‘: JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«æ¤œçŸ¥ã•ã‚Œã‚¨ãƒ©ãƒ¼æƒ…å ±ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });

    test('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡åˆ¶é™è¶…éæ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: Chrome extension storage ã®å®¹é‡åˆ¶é™è¶…éæ™‚ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: å¤§é‡ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã§QuotaExceededErrorãŒç™ºç”Ÿã—ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ãƒ†ã‚¹ãƒˆ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: å®¹é‡è¶…éã‚’æ¤œçŸ¥ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æä¾›ã™ã‚‹
      // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚¿ã‚¹ã‚¯è¦ä»¶ã‹ã‚‰æ¨æ¸¬ã—ãŸå®¹é‡åˆ¶é™ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: Chrome storage ã®å®¹é‡åˆ¶é™è¶…éã‚¨ãƒ©ãƒ¼ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: QUOTA_BYTES_PER_ITEM åˆ¶é™ã‚’è¶…ãˆã‚‹ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã‚’æƒ³å®š
      const quotaError = new Error('QUOTA_BYTES_PER_ITEM quota exceeded');
      quotaError.name = 'QuotaExceededError';
      mockChromeStorage.local.set.mockRejectedValue(quotaError);

      const largeData = {
        imageCount: 1000,
        largeArray: new Array(10000).fill('large data item'),
      };

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿ã§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã®setæ©Ÿèƒ½ã‚’å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: å®¹é‡åˆ¶é™ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆ
      const result = await storage.set('settings', largeData);

      // ã€çµæœæ¤œè¨¼ã€‘: å®¹é‡åˆ¶é™ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ã‚¨ãƒ©ãƒ¼ç¨®é¡ã®ç‰¹å®šã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæä¾›ã•ã‚Œã‚‹
      expect(result).toEqual({
        success: false,
        error: 'Storage quota exceeded. Please reduce data size or clear old data.',
        context: { namespace: 'settings', errorType: 'QuotaExceededError' },
      }); // ã€ç¢ºèªå†…å®¹ã€‘: å®¹é‡åˆ¶é™ã‚¨ãƒ©ãƒ¼ãŒæ¤œçŸ¥ã•ã‚Œé©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
    });
  });

  describe('çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆãƒ¢ãƒƒã‚¯ç’°å¢ƒï¼‰', () => {
    test('Popup ã¨ Service Worker é–“ã§ã®settingsãƒ‡ãƒ¼ã‚¿åŒæœŸ', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: Popupã¨Service Workeré–“ã§settingsãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãåŒæœŸã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: Popupå´ã§settingsæ›´æ–°å¾Œã€Service Workerå´ã§åŒã˜ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ä¸¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ‡ãƒ¼ã‚¿ãŒå…±æœ‰ã•ã‚Œã‚‹
      // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚¿ã‚¹ã‚¯å®šç¾©ã®çµ±åˆãƒ†ã‚¹ãƒˆè¦ä»¶ã€ŒPopup ã¨ SW é–“ã®åŒæœŸã€ã«åŸºã¥ãç¢ºå®Ÿãªãƒ†ã‚¹ãƒˆ

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: Popupå´ã¨Service Workerå´ã§ã®è¨­å®šãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: å®Ÿéš›ã®æ‹¡å¼µæ©Ÿèƒ½ã«ãŠã‘ã‚‹ Popup â†” Service Worker é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¨¡æ“¬
      const initialSettings = {
        imageCount: 1,
        seed: -1,
        filenameTemplate: '{date}_{prompt}_{seed}_{idx}',
      };

      const updatedSettings = {
        imageCount: 5,
        seed: 42,
        filenameTemplate: '{Character}_{date}_{seed}_{idx}',
      };

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: Popupå´ã§ã®è¨­å®šä¿å­˜ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      // ã€å‡¦ç†å†…å®¹ã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä½¿ç”¨ã—ã¦Popupå´ã§è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹å‡¦ç†
      await storage.set('settings', initialSettings);

      // Chrome storage ã®çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆService Workerå´ã§å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãƒ¢ãƒƒã‚¯è¨­å®šï¼‰
      mockChromeStorage.local.get.mockResolvedValue({
        namespace_settings: initialSettings,
      });

      // Service Workerå´ã§ã®åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      const serviceWorkerData1 = await storage.get('settings');

      // Popupå´ã§ã®è¨­å®šæ›´æ–°ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      await storage.set('settings', updatedSettings);

      // Chrome storage ã®çŠ¶æ…‹ã‚’æ›´æ–°å¾Œã®å€¤ã«å¤‰æ›´
      mockChromeStorage.local.get.mockResolvedValue({
        namespace_settings: updatedSettings,
      });

      // Service Workerå´ã§ã®æ›´æ–°å¾Œãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      const serviceWorkerData2 = await storage.get('settings');

      // ã€çµæœæ¤œè¨¼ã€‘: ä¸¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã§ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãåŒæœŸã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: åŒã˜ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ä¸€è²«ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãŒå®Ÿç¾ã•ã‚Œã‚‹
      expect(serviceWorkerData1).toEqual(initialSettings); // ã€ç¢ºèªå†…å®¹ã€‘: Service Workerå´ã§åˆå›ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå–å¾—ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(serviceWorkerData2).toEqual(updatedSettings); // ã€ç¢ºèªå†…å®¹ã€‘: Service Workerå´ã§æ›´æ–°å¾Œãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå–å¾—ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
      expect(mockChromeStorage.local.set).toHaveBeenCalledTimes(2); // ã€ç¢ºèªå†…å®¹ã€‘: Chrome APIãŒä¸¡å›ã¨ã‚‚æ­£ã—ãå‘¼ã³å‡ºã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    });
  });
});
