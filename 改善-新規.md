# 改善計画書 - NovelAI Auto Generator

## 概要

TASK-000完了後の改善点とNext Stepsを整理したドキュメント。TypeScript + Vitest環境での実装品質向上を目指す。

## 完了済み項目 ✅

### TASK-000: プロジェクト構成と基本ツール設定

- [x] Manifest V3対応のChrome拡張機能基盤構築
- [x] TypeScript + Vitestによる開発環境構築
- [x] ESLint + Prettierによるコード品質管理
- [x] 基本的なService Worker、Content Script、Popup UI実装
- [x] Chrome API モック環境でのテスト基盤構築
- [x] 型安全性を重視したTypeScript設定

## 緊急改善項目 🔴

### 1. 型安全性の大幅向上

現在の`any`型多用を厳密な型定義に置き換える必要がある。

#### 現在の問題:

```typescript
// any型の危険な多用
function handleMessage(message: any, sender: any, sendResponse: any)
chrome.tabs.sendMessage(tabId, message: any)
async function applyParameters(parameters: any): Promise<void>
```

#### 改善すべき型定義:

```typescript
// 厳密なメッセージ型定義
interface ChromeMessage {
  type: 'START_GENERATION' | 'APPLY_PROMPT' | 'PROGRESS_UPDATE';
  correlationId: string;
  payload: MessagePayload;
}

interface StartGenerationPayload {
  prompt: string;
  parameters: GenerationParameters;
  settings: GenerationSettings;
}

// 名目型でID取り違えを防止
type JobId = string & { __brand: 'JobId' };
type PresetId = string & { __brand: 'PresetId' };
```

### 2. DOM操作の堅牢性強化

現在のセレクタ戦略は単純で、NovelAI UIの変更に脆弱。

#### 現在の問題:

```typescript
// 静的セレクタ配列 - 脆弱
const generateSelectors = ['button[type="submit"]', 'button[data-testid="generate-button"]'];

// タイムアウトやリトライ機能なし
const button = document.querySelector(selector);
if (button) button.click();
```

#### 改善後の設計:

```typescript
// 動的セレクタ解決システム
class DOMResolver {
  async findElement(
    config: SelectorConfig,
    options: { timeout: number; retries: number }
  ): Promise<HTMLElement | null> {
    // MutationObserver活用
    // 複数段階フォールバック
    // タイムアウト付き待機
  }
}

interface SelectorConfig {
  primary: string[];
  fallback: string[];
  attributes: Record<string, string>;
  validation?: (el: HTMLElement) => boolean;
}
```

### 3. エラーハンドリングの統一

現在は各所でバラバラなエラー処理。

#### 現在の問題:

```typescript
// 各所でバラバラなエラー処理
catch (error) {
  console.error('Failed...', error instanceof Error ? error.message : String(error));
  sendResponse({ success: false, error: error.message });
}
```

#### 改善後:

```typescript
// 統一されたエラーハンドリング
enum ErrorCode {
  DOM_NOT_FOUND = 'DOM_NOT_FOUND',
  TIMEOUT = 'TIMEOUT',
  NETWORK_ERROR = 'NETWORK_ERROR',
  PERMISSION_DENIED = 'PERMISSION_DENIED',
}

class ExtensionError extends Error {
  constructor(
    public code: ErrorCode,
    message: string,
    public context?: Record<string, unknown>
  ) {
    super(message);
  }
}

function handleError(error: unknown, context: string): ExtensionError {
  // 統一されたエラー変換とログ記録
}
```

## 中優先度改善項目 🟡

### 4. ファイル名テンプレート機能

現在の単純なテンプレートを拡張。

```typescript
// 改善されたファイル名生成
interface FilenameVars {
  date: Date;
  prompt: string;
  seed: number | 'random';
  index: number;
  paramHash: string; // パラメータのハッシュ
}

function generateFilename(template: string, vars: FilenameVars): string {
  return template
    .replace('{date}', vars.date.toISOString().slice(0, 10))
    .replace('{prompt}', sanitizeFilename(vars.prompt))
    .replace('{seed}', String(vars.seed))
    .replace('{idx}', String(vars.index).padStart(3, '0'))
    .replace('{hash}', vars.paramHash.slice(0, 4));
}
```

### 5. リトライ機能の実装

指数バックオフによる堅牢なリトライ機能。

```typescript
interface RetryPolicy {
  maxAttempts: number;
  baseDelayMs: number;
  factor: number;
  maxDelayMs?: number;
}

class RetryEngine {
  async withRetry<T>(operation: () => Promise<T>, policy: RetryPolicy): Promise<T> {
    // 指数バックオフ実装
    // キャンセル可能
    // 詳細ログ記録
  }
}
```

### 6. 設定管理の改善

現在の設定システムを拡張。

```typescript
interface ExtensionSettings {
  // 現在の設定
  imageCount: number;
  seed: number;
  filenameTemplate: string;

  // 新規追加
  ui: {
    theme: 'light' | 'dark' | 'auto';
    language: 'ja' | 'en';
    compactMode: boolean;
  };

  automation: {
    autoDownload: boolean;
    autoRetry: boolean;
    retryPolicy: RetryPolicy;
  };

  advanced: {
    customSelectors: Record<string, string>;
    debugMode: boolean;
    maxConcurrentDownloads: number;
  };
}
```

## 低優先度改善項目 🟢

### 7. テストカバレッジ拡充

```typescript
// DOM操作テスト
describe('Content Script DOM Operations', () => {
  beforeEach(() => {
    // NovelAI DOM構造をモック
    document.body.innerHTML = mockNovelAIDom;
  });

  it('should find prompt input with fallback', async () => {
    // セレクタフォールバック機能をテスト
  });

  it('should handle UI changes gracefully', async () => {
    // DOM変更への対応をテスト
  });
});

// E2Eテスト
describe('Full Generation Workflow', () => {
  it('should complete generation from popup to download', async () => {
    // Playwrightによる実際のブラウザテスト
  });
});
```

### 8. パフォーマンス最適化

```typescript
// メモリリーク対策
class ExtensionManager {
  private listeners = new Map<string, Function>();
  private abortController = new AbortController();

  cleanup() {
    this.abortController.abort();
    this.listeners.clear();
  }
}

// バックグラウンド処理最適化
class JobQueue {
  private queue: GenerationJob[] = [];
  private processing = false;

  async processNext(): Promise<void> {
    // 効率的なジョブ処理
  }
}
```

## Next Steps（実装優先順位）

### Phase 1: 基盤強化 🔴

1. **TASK-001**: CI/CD設定（GitHub Actions）
2. **TASK-010**: ストレージラッパー実装
3. **TASK-020**: DOM操作の堅牢化

### Phase 2: 機能拡充 🟡

4. **TASK-030**: Service Worker機能群
5. **TASK-040**: Popup UI改善
6. **TASK-050**: 設定・ユーティリティ

### Phase 3: 品質向上 🟢

7. **TASK-070**: エッジケース対応
8. **TASK-080**: テストカバレッジ拡充
9. **TASK-090**: ドキュメント整備

## 技術的課題と対策

### NovelAI固有の課題

#### UI変更への対応

- **課題**: NovelAIのアップデートでDOM構造が変更
- **対策**:
  - 複数レベルのセレクタフォールバック
  - MutationObserverによる動的検知
  - コミュニティベースのセレクタ更新機能

#### レート制限対応

- **課題**: NovelAIのAPI制限や生成間隔
- **対策**:
  - 適応的な待機時間調整
  - エラーレスポンス解析
  - ユーザー通知とガイダンス

### Chrome拡張機能の制約

#### Manifest V3制限

- **課題**: Service Workerの制限、eval禁止
- **対策**:
  - 効率的なメッセージパッシング
  - WebAssembly活用（必要に応じて）
  - ストレージAPIの有効活用

#### 権限管理

- **課題**: 最小権限での機能実現
- **対策**:
  - 段階的権限要求
  - ユーザーへの明確な説明
  - オプトイン方式

## 開発環境改善

### Git管理戦略

```bash
# ブランチ戦略
main                    # 安定版・リリース用
develop                 # 開発統合
feature/TASK-XXX-desc   # 機能開発
hotfix/issue-desc       # 緊急修正
```

### 自動化パイプライン

```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci
      - run: npm run test:coverage
      - run: npm run lint
      - run: npm run type-check
      - run: npm run build

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
```

### 品質ゲート

```json
// package.json scripts
{
  "scripts": {
    "precommit": "lint-staged && npm run test:unit",
    "prepush": "npm run test:coverage && npm run build",
    "release": "npm run test:e2e && npm run build:prod"
  }
}
```

## ドキュメント整備計画

### 必要なドキュメント

- [ ] **開発者ガイド** - セットアップ、アーキテクチャ
- [ ] **API仕様書** - メッセージング、型定義
- [ ] **ユーザーマニュアル** - インストール、使用方法
- [ ] **トラブルシューティング** - よくある問題と解決策
- [ ] **コントリビューションガイド** - 貢献方法、コーディング規約

### ドキュメント自動化

```typescript
// 型定義からドキュメント生成
// JSDocコメントから仕様書生成
// テストから使用例抽出
```

## まとめ

TASK-000で基盤は完成したが、実用性と堅牢性の大幅な向上が必要。特に：

1. **型安全性の徹底** - `any`型の完全排除
2. **DOM操作の堅牢化** - NovelAI UI変更への対応
3. **エラーハンドリング統一** - ユーザーフレンドリーな体験

これらの改善により、実際の運用に耐える品質の Chrome 拡張機能を実現できる。

次は **TASK-001（CI設定）**から開始し、**TASK-010（ストレージ）**、**TASK-020（DOM操作）**の順で段階的に改善を進める。
