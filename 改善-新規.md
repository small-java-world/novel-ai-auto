# æ”¹å–„è¨ˆç”»æ›¸ - NovelAI Auto Generator

## æ¦‚è¦

TASK-000å®Œäº†å¾Œã®æ”¹å–„ç‚¹ã¨Next Stepsã‚’æ•´ç†ã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚TypeScript + Vitestç’°å¢ƒã§ã®å®Ÿè£…å“è³ªå‘ä¸Šã‚’ç›®æŒ‡ã™ã€‚

## å®Œäº†æ¸ˆã¿é …ç›® âœ…

### TASK-000: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã¨åŸºæœ¬ãƒ„ãƒ¼ãƒ«è¨­å®š

- [x] Manifest V3å¯¾å¿œã®Chromeæ‹¡å¼µæ©Ÿèƒ½åŸºç›¤æ§‹ç¯‰
- [x] TypeScript + Vitestã«ã‚ˆã‚‹é–‹ç™ºç’°å¢ƒæ§‹ç¯‰
- [x] ESLint + Prettierã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰å“è³ªç®¡ç†
- [x] åŸºæœ¬çš„ãªService Workerã€Content Scriptã€Popup UIå®Ÿè£…
- [x] Chrome API ãƒ¢ãƒƒã‚¯ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆåŸºç›¤æ§‹ç¯‰
- [x] å‹å®‰å…¨æ€§ã‚’é‡è¦–ã—ãŸTypeScriptè¨­å®š

## ç·Šæ€¥æ”¹å–„é …ç›® ğŸ”´

### 1. å‹å®‰å…¨æ€§ã®å¤§å¹…å‘ä¸Š

ç¾åœ¨ã®`any`å‹å¤šç”¨ã‚’å³å¯†ãªå‹å®šç¾©ã«ç½®ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

#### ç¾åœ¨ã®å•é¡Œ:

```typescript
// anyå‹ã®å±é™ºãªå¤šç”¨
function handleMessage(message: any, sender: any, sendResponse: any)
chrome.tabs.sendMessage(tabId, message: any)
async function applyParameters(parameters: any): Promise<void>
```

#### æ”¹å–„ã™ã¹ãå‹å®šç¾©:

```typescript
// å³å¯†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‹å®šç¾©
interface ChromeMessage {
  type: 'START_GENERATION' | 'APPLY_PROMPT' | 'PROGRESS_UPDATE';
  correlationId: string;
  payload: MessagePayload;
}

interface StartGenerationPayload {
  prompt: string;
  parameters: GenerationParameters;
  settings: GenerationSettings;
}

// åç›®å‹ã§IDå–ã‚Šé•ãˆã‚’é˜²æ­¢
type JobId = string & { __brand: 'JobId' };
type PresetId = string & { __brand: 'PresetId' };
```

### 2. DOMæ“ä½œã®å …ç‰¢æ€§å¼·åŒ–

ç¾åœ¨ã®ã‚»ãƒ¬ã‚¯ã‚¿æˆ¦ç•¥ã¯å˜ç´”ã§ã€NovelAI UIã®å¤‰æ›´ã«è„†å¼±ã€‚

#### ç¾åœ¨ã®å•é¡Œ:

```typescript
// é™çš„ã‚»ãƒ¬ã‚¯ã‚¿é…åˆ— - è„†å¼±
const generateSelectors = ['button[type="submit"]', 'button[data-testid="generate-button"]'];

// ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚„ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ãªã—
const button = document.querySelector(selector);
if (button) button.click();
```

#### æ”¹å–„å¾Œã®è¨­è¨ˆ:

```typescript
// å‹•çš„ã‚»ãƒ¬ã‚¯ã‚¿è§£æ±ºã‚·ã‚¹ãƒ†ãƒ 
class DOMResolver {
  async findElement(
    config: SelectorConfig,
    options: { timeout: number; retries: number }
  ): Promise<HTMLElement | null> {
    // MutationObserveræ´»ç”¨
    // è¤‡æ•°æ®µéšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãå¾…æ©Ÿ
  }
}

interface SelectorConfig {
  primary: string[];
  fallback: string[];
  attributes: Record<string, string>;
  validation?: (el: HTMLElement) => boolean;
}
```

### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€

ç¾åœ¨ã¯å„æ‰€ã§ãƒãƒ©ãƒãƒ©ãªã‚¨ãƒ©ãƒ¼å‡¦ç†ã€‚

#### ç¾åœ¨ã®å•é¡Œ:

```typescript
// å„æ‰€ã§ãƒãƒ©ãƒãƒ©ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
catch (error) {
  console.error('Failed...', error instanceof Error ? error.message : String(error));
  sendResponse({ success: false, error: error.message });
}
```

#### æ”¹å–„å¾Œ:

```typescript
// çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
enum ErrorCode {
  DOM_NOT_FOUND = 'DOM_NOT_FOUND',
  TIMEOUT = 'TIMEOUT',
  NETWORK_ERROR = 'NETWORK_ERROR',
  PERMISSION_DENIED = 'PERMISSION_DENIED',
}

class ExtensionError extends Error {
  constructor(
    public code: ErrorCode,
    message: string,
    public context?: Record<string, unknown>
  ) {
    super(message);
  }
}

function handleError(error: unknown, context: string): ExtensionError {
  // çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼å¤‰æ›ã¨ãƒ­ã‚°è¨˜éŒ²
}
```

## ä¸­å„ªå…ˆåº¦æ”¹å–„é …ç›® ğŸŸ¡

### 4. ãƒ•ã‚¡ã‚¤ãƒ«åãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½

ç¾åœ¨ã®å˜ç´”ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ‹¡å¼µã€‚

```typescript
// æ”¹å–„ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
interface FilenameVars {
  date: Date;
  prompt: string;
  seed: number | 'random';
  index: number;
  paramHash: string; // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒãƒƒã‚·ãƒ¥
}

function generateFilename(template: string, vars: FilenameVars): string {
  return template
    .replace('{date}', vars.date.toISOString().slice(0, 10))
    .replace('{prompt}', sanitizeFilename(vars.prompt))
    .replace('{seed}', String(vars.seed))
    .replace('{idx}', String(vars.index).padStart(3, '0'))
    .replace('{hash}', vars.paramHash.slice(0, 4));
}
```

### 5. ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã®å®Ÿè£…

æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã«ã‚ˆã‚‹å …ç‰¢ãªãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã€‚

```typescript
interface RetryPolicy {
  maxAttempts: number;
  baseDelayMs: number;
  factor: number;
  maxDelayMs?: number;
}

class RetryEngine {
  async withRetry<T>(operation: () => Promise<T>, policy: RetryPolicy): Promise<T> {
    // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•å®Ÿè£…
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½
    // è©³ç´°ãƒ­ã‚°è¨˜éŒ²
  }
}
```

### 6. è¨­å®šç®¡ç†ã®æ”¹å–„

ç¾åœ¨ã®è¨­å®šã‚·ã‚¹ãƒ†ãƒ ã‚’æ‹¡å¼µã€‚

```typescript
interface ExtensionSettings {
  // ç¾åœ¨ã®è¨­å®š
  imageCount: number;
  seed: number;
  filenameTemplate: string;

  // æ–°è¦è¿½åŠ 
  ui: {
    theme: 'light' | 'dark' | 'auto';
    language: 'ja' | 'en';
    compactMode: boolean;
  };

  automation: {
    autoDownload: boolean;
    autoRetry: boolean;
    retryPolicy: RetryPolicy;
  };

  advanced: {
    customSelectors: Record<string, string>;
    debugMode: boolean;
    maxConcurrentDownloads: number;
  };
}
```

## ä½å„ªå…ˆåº¦æ”¹å–„é …ç›® ğŸŸ¢

### 7. ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ‹¡å……

```typescript
// DOMæ“ä½œãƒ†ã‚¹ãƒˆ
describe('Content Script DOM Operations', () => {
  beforeEach(() => {
    // NovelAI DOMæ§‹é€ ã‚’ãƒ¢ãƒƒã‚¯
    document.body.innerHTML = mockNovelAIDom;
  });

  it('should find prompt input with fallback', async () => {
    // ã‚»ãƒ¬ã‚¯ã‚¿ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆ
  });

  it('should handle UI changes gracefully', async () => {
    // DOMå¤‰æ›´ã¸ã®å¯¾å¿œã‚’ãƒ†ã‚¹ãƒˆ
  });
});

// E2Eãƒ†ã‚¹ãƒˆ
describe('Full Generation Workflow', () => {
  it('should complete generation from popup to download', async () => {
    // Playwrightã«ã‚ˆã‚‹å®Ÿéš›ã®ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆ
  });
});
```

### 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

```typescript
// ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–
class ExtensionManager {
  private listeners = new Map<string, Function>();
  private abortController = new AbortController();

  cleanup() {
    this.abortController.abort();
    this.listeners.clear();
  }
}

// ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†æœ€é©åŒ–
class JobQueue {
  private queue: GenerationJob[] = [];
  private processing = false;

  async processNext(): Promise<void> {
    // åŠ¹ç‡çš„ãªã‚¸ãƒ§ãƒ–å‡¦ç†
  }
}
```

## Next Stepsï¼ˆå®Ÿè£…å„ªå…ˆé †ä½ï¼‰

### Phase 1: åŸºç›¤å¼·åŒ– ğŸ”´

1. **TASK-001**: CI/CDè¨­å®šï¼ˆGitHub Actionsï¼‰
2. **TASK-010**: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼å®Ÿè£…
3. **TASK-020**: DOMæ“ä½œã®å …ç‰¢åŒ–

### Phase 2: æ©Ÿèƒ½æ‹¡å…… ğŸŸ¡

4. **TASK-030**: Service Workeræ©Ÿèƒ½ç¾¤
5. **TASK-040**: Popup UIæ”¹å–„
6. **TASK-050**: è¨­å®šãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

### Phase 3: å“è³ªå‘ä¸Š ğŸŸ¢

7. **TASK-070**: ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å¯¾å¿œ
8. **TASK-080**: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ‹¡å……
9. **TASK-090**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™

## æŠ€è¡“çš„èª²é¡Œã¨å¯¾ç­–

### NovelAIå›ºæœ‰ã®èª²é¡Œ

#### UIå¤‰æ›´ã¸ã®å¯¾å¿œ

- **èª²é¡Œ**: NovelAIã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§DOMæ§‹é€ ãŒå¤‰æ›´
- **å¯¾ç­–**:
  - è¤‡æ•°ãƒ¬ãƒ™ãƒ«ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  - MutationObserverã«ã‚ˆã‚‹å‹•çš„æ¤œçŸ¥
  - ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒ¬ã‚¯ã‚¿æ›´æ–°æ©Ÿèƒ½

#### ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œ

- **èª²é¡Œ**: NovelAIã®APIåˆ¶é™ã‚„ç”Ÿæˆé–“éš”
- **å¯¾ç­–**:
  - é©å¿œçš„ãªå¾…æ©Ÿæ™‚é–“èª¿æ•´
  - ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ã¨ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹

### Chromeæ‹¡å¼µæ©Ÿèƒ½ã®åˆ¶ç´„

#### Manifest V3åˆ¶é™

- **èª²é¡Œ**: Service Workerã®åˆ¶é™ã€evalç¦æ­¢
- **å¯¾ç­–**:
  - åŠ¹ç‡çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒƒã‚·ãƒ³ã‚°
  - WebAssemblyæ´»ç”¨ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
  - ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸APIã®æœ‰åŠ¹æ´»ç”¨

#### æ¨©é™ç®¡ç†

- **èª²é¡Œ**: æœ€å°æ¨©é™ã§ã®æ©Ÿèƒ½å®Ÿç¾
- **å¯¾ç­–**:
  - æ®µéšçš„æ¨©é™è¦æ±‚
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ˜ç¢ºãªèª¬æ˜
  - ã‚ªãƒ—ãƒˆã‚¤ãƒ³æ–¹å¼

## é–‹ç™ºç’°å¢ƒæ”¹å–„

### Gitç®¡ç†æˆ¦ç•¥

```bash
# ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥
main                    # å®‰å®šç‰ˆãƒ»ãƒªãƒªãƒ¼ã‚¹ç”¨
develop                 # é–‹ç™ºçµ±åˆ
feature/TASK-XXX-desc   # æ©Ÿèƒ½é–‹ç™º
hotfix/issue-desc       # ç·Šæ€¥ä¿®æ­£
```

### è‡ªå‹•åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci
      - run: npm run test:coverage
      - run: npm run lint
      - run: npm run type-check
      - run: npm run build

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
```

### å“è³ªã‚²ãƒ¼ãƒˆ

```json
// package.json scripts
{
  "scripts": {
    "precommit": "lint-staged && npm run test:unit",
    "prepush": "npm run test:coverage && npm run build",
    "release": "npm run test:e2e && npm run build:prod"
  }
}
```

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™è¨ˆç”»

### å¿…è¦ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ ] **é–‹ç™ºè€…ã‚¬ã‚¤ãƒ‰** - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- [ ] **APIä»•æ§˜æ›¸** - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã€å‹å®šç¾©
- [ ] **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«** - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ä½¿ç”¨æ–¹æ³•
- [ ] **ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°** - ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–
- [ ] **ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰** - è²¢çŒ®æ–¹æ³•ã€ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè‡ªå‹•åŒ–

```typescript
// å‹å®šç¾©ã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
// JSDocã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ä»•æ§˜æ›¸ç”Ÿæˆ
// ãƒ†ã‚¹ãƒˆã‹ã‚‰ä½¿ç”¨ä¾‹æŠ½å‡º
```

## ã¾ã¨ã‚

TASK-000ã§åŸºç›¤ã¯å®Œæˆã—ãŸãŒã€å®Ÿç”¨æ€§ã¨å …ç‰¢æ€§ã®å¤§å¹…ãªå‘ä¸ŠãŒå¿…è¦ã€‚ç‰¹ã«ï¼š

1. **å‹å®‰å…¨æ€§ã®å¾¹åº•** - `any`å‹ã®å®Œå…¨æ’é™¤
2. **DOMæ“ä½œã®å …ç‰¢åŒ–** - NovelAI UIå¤‰æ›´ã¸ã®å¯¾å¿œ
3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±ä¸€** - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªä½“é¨“

ã“ã‚Œã‚‰ã®æ”¹å–„ã«ã‚ˆã‚Šã€å®Ÿéš›ã®é‹ç”¨ã«è€ãˆã‚‹å“è³ªã® Chrome æ‹¡å¼µæ©Ÿèƒ½ã‚’å®Ÿç¾ã§ãã‚‹ã€‚

æ¬¡ã¯ **TASK-001ï¼ˆCIè¨­å®šï¼‰**ã‹ã‚‰é–‹å§‹ã—ã€**TASK-010ï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰**ã€**TASK-020ï¼ˆDOMæ“ä½œï¼‰**ã®é †ã§æ®µéšçš„ã«æ”¹å–„ã‚’é€²ã‚ã‚‹ã€‚
