# TASK-102: 新フォーマット対応・メタデータ管理 テストケース仕様書

## 概要

TASK-102の新フォーマット対応・メタデータ管理機能のテストケースを定義する。TDDのRedフェーズで実装するテストケースを詳細に記述する。

## テストケース一覧

### 機能要件テストケース

#### TC-102-001: 新フォーマット（v1.0）の正常読み込み
- **目的**: REQ-102-001の検証
- **前提条件**: 有効なv1.0フォーマットのプロンプトファイルが存在
- **実行手順**:
  1. v1.0フォーマットのプロンプトファイルを読み込み
  2. メタデータとプリセット情報を取得
  3. バリデーション結果を確認
- **期待結果**: 
  - ファイルが正常に読み込まれる
  - メタデータが正しく解析される
  - プリセット情報が正しく取得される
- **失敗条件**: ファイル読み込みエラー、メタデータ解析エラー

#### TC-102-002: メタデータの表示・管理機能
- **目的**: REQ-102-002の検証
- **前提条件**: メタデータを含むプロンプトファイルが読み込まれている
- **実行手順**:
  1. メタデータの各項目を表示
  2. メタデータの編集機能を実行
  3. 変更内容の保存を実行
- **期待結果**:
  - 名前、作成者、説明、タグが正しく表示される
  - メタデータの編集が正常に動作する
  - 変更内容が正しく保存される
- **失敗条件**: 表示エラー、編集エラー、保存エラー

#### TC-102-003: 既存JSON形式との互換性保持
- **目的**: REQ-102-003の検証
- **前提条件**: 既存のJSON形式プロンプトファイルが存在
- **実行手順**:
  1. 既存JSON形式ファイルを読み込み
  2. 新フォーマットへの自動変換を実行
  3. 変換結果の検証を実行
- **期待結果**:
  - 既存ファイルが正常に読み込まれる
  - 新フォーマットに正しく変換される
  - データの損失がない
- **失敗条件**: 読み込みエラー、変換エラー、データ損失

#### TC-102-004: プロンプトセットのバージョン管理
- **目的**: REQ-102-004の検証
- **前提条件**: 異なるバージョンのプロンプトファイルが存在
- **実行手順**:
  1. 異なるバージョンのファイルを読み込み
  2. バージョン情報の確認
  3. 適切な変換処理の実行
- **期待結果**:
  - バージョン情報が正しく識別される
  - 適切な変換処理が実行される
  - 最新バージョンに正しく変換される
- **失敗条件**: バージョン識別エラー、変換処理エラー

#### TC-102-005: タグベースのフィルタリング機能
- **目的**: REQ-102-005の検証
- **前提条件**: 複数のタグを持つプリセットが存在
- **実行手順**:
  1. タグリストを取得
  2. 特定のタグでフィルタリング
  3. フィルタリング結果の確認
- **期待結果**:
  - 全タグが正しく取得される
  - 指定したタグのプリセットが正しくフィルタリングされる
  - フィルタリング結果が正確である
- **失敗条件**: タグ取得エラー、フィルタリングエラー

### 条件付き要件テストケース

#### TC-102-101: メタデータが不完全な場合のデフォルト値設定
- **目的**: REQ-102-101の検証
- **前提条件**: 不完全なメタデータを含むファイルが存在
- **実行手順**:
  1. 不完全なメタデータのファイルを読み込み
  2. デフォルト値の設定を実行
  3. 設定結果の確認
- **期待結果**:
  - 不完全な項目にデフォルト値が設定される
  - ファイルが正常に読み込まれる
  - デフォルト値が適切である
- **失敗条件**: デフォルト値設定エラー、読み込みエラー

#### TC-102-102: 既存形式の自動変換
- **目的**: REQ-102-102の検証
- **前提条件**: 既存形式のプロンプトファイルが存在
- **実行手順**:
  1. 既存形式ファイルを読み込み
  2. 自動変換処理を実行
  3. 変換結果の検証
- **期待結果**:
  - 既存形式が正しく認識される
  - 新形式に正しく変換される
  - データの整合性が保たれる
- **失敗条件**: 形式認識エラー、変換エラー、データ不整合

#### TC-102-103: バージョンが異なる場合の適切な変換処理
- **目的**: REQ-102-103の検証
- **前提条件**: 異なるバージョンのファイルが存在
- **実行手順**:
  1. 異なるバージョンファイルを読み込み
  2. バージョン変換処理を実行
  3. 変換結果の検証
- **期待結果**:
  - バージョンが正しく識別される
  - 適切な変換処理が実行される
  - 最新バージョンに正しく変換される
- **失敗条件**: バージョン識別エラー、変換処理エラー

#### TC-102-104: タグ重複の除去
- **目的**: REQ-102-104の検証
- **前提条件**: 重複するタグを含むプリセットが存在
- **実行手順**:
  1. 重複タグを含むプリセットを読み込み
  2. 重複除去処理を実行
  3. 結果の確認
- **期待結果**:
  - 重複タグが正しく除去される
  - 元のタグ情報が保持される
  - 処理が正常に完了する
- **失敗条件**: 重複除去エラー、データ損失

### 制約要件テストケース

#### TC-102-401: JSON Schema v7準拠
- **目的**: REQ-102-401の検証
- **前提条件**: JSON Schema v7で定義されたスキーマが存在
- **実行手順**:
  1. プロンプトファイルのスキーマ検証を実行
  2. JSON Schema v7での検証結果を確認
  3. 準拠性の確認
- **期待結果**:
  - JSON Schema v7に準拠している
  - スキーマ検証が正常に完了する
  - 準拠性が確認される
- **失敗条件**: スキーマ検証エラー、準拠性違反

#### TC-102-402: Unicode正規化（NFC）使用
- **目的**: REQ-102-402の検証
- **前提条件**: Unicode文字を含むメタデータが存在
- **実行手順**:
  1. Unicode文字を含むメタデータを処理
  2. NFC正規化を実行
  3. 正規化結果の確認
- **期待結果**:
  - Unicode文字がNFC形式に正規化される
  - 正規化処理が正常に完了する
  - 文字の整合性が保たれる
- **失敗条件**: 正規化エラー、文字化け

#### TC-102-403: メタデータ文字数制限遵守
- **目的**: REQ-102-403の検証
- **前提条件**: 文字数制限を超えるメタデータが存在
- **実行手順**:
  1. 制限を超えるメタデータを処理
  2. 文字数制限チェックを実行
  3. 制限超過時の処理を確認
- **期待結果**:
  - 文字数制限が正しく検出される
  - 適切なエラーハンドリングが実行される
  - 制限内のデータが正しく処理される
- **失敗条件**: 制限チェックエラー、処理エラー

### Edgeケーステストケース

#### TC-102-501: 無効なメタデータの処理
- **目的**: EDGE-102-001の検証
- **前提条件**: 無効なメタデータを含むファイルが存在
- **実行手順**:
  1. 無効なメタデータのファイルを読み込み
  2. エラーハンドリングを実行
  3. 回復処理の確認
- **期待結果**:
  - 無効なメタデータが正しく検出される
  - 適切なエラーメッセージが表示される
  - 回復処理が正常に動作する
- **失敗条件**: 検出エラー、回復処理エラー

#### TC-102-502: 破損したバージョン情報の処理
- **目的**: EDGE-102-002の検証
- **前提条件**: 破損したバージョン情報を含むファイルが存在
- **実行手順**:
  1. 破損したバージョン情報のファイルを読み込み
  2. バージョン情報の修復を実行
  3. 修復結果の確認
- **期待結果**:
  - 破損が正しく検出される
  - バージョン情報が適切に修復される
  - ファイルが正常に処理される
- **失敗条件**: 検出エラー、修復エラー

#### TC-102-503: 文字エンコーディング問題の処理
- **目的**: EDGE-102-003の検証
- **前提条件**: 異なるエンコーディングのファイルが存在
- **実行手順**:
  1. 異なるエンコーディングのファイルを読み込み
  2. エンコーディング変換を実行
  3. 変換結果の確認
- **期待結果**:
  - エンコーディングが正しく検出される
  - 適切な変換が実行される
  - 文字化けが発生しない
- **失敗条件**: 検出エラー、変換エラー、文字化け

#### TC-102-504: メタデータサイズ制限超過の処理
- **目的**: EDGE-102-004の検証
- **前提条件**: サイズ制限を超えるメタデータが存在
- **実行手順**:
  1. サイズ制限を超えるメタデータを処理
  2. サイズ制限チェックを実行
  3. 制限超過時の処理を確認
- **期待結果**:
  - サイズ制限が正しく検出される
  - 適切なエラーハンドリングが実行される
  - 制限内のデータが正しく処理される
- **失敗条件**: 検出エラー、処理エラー

### 非機能要件テストケース

#### NFR-102-001: メタデータ読み込み処理のパフォーマンス
- **目的**: NFR-102-001の検証
- **前提条件**: 大量のメタデータを含むファイルが存在
- **実行手順**:
  1. メタデータ読み込み処理を実行
  2. 処理時間を測定
  3. 200ms以内の完了を確認
- **期待結果**:
  - 処理時間が200ms以内で完了する
  - メタデータが正しく読み込まれる
  - パフォーマンス要件を満たす
- **失敗条件**: 処理時間超過、読み込みエラー

#### NFR-102-002: タグフィルタリングのパフォーマンス
- **目的**: NFR-102-002の検証
- **前提条件**: 大量のタグを含むプリセットが存在
- **実行手順**:
  1. タグフィルタリング処理を実行
  2. 処理時間を測定
  3. 100ms以内の完了を確認
- **期待結果**:
  - 処理時間が100ms以内で完了する
  - フィルタリングが正しく動作する
  - パフォーマンス要件を満たす
- **失敗条件**: 処理時間超過、フィルタリングエラー

#### NFR-102-003: 形式変換処理のパフォーマンス
- **目的**: NFR-102-003の検証
- **前提条件**: 大容量のプロンプトファイルが存在
- **実行手順**:
  1. 形式変換処理を実行
  2. 処理時間を測定
  3. 500ms以内の完了を確認
- **期待結果**:
  - 処理時間が500ms以内で完了する
  - 変換が正しく完了する
  - パフォーマンス要件を満たす
- **失敗条件**: 処理時間超過、変換エラー

#### NFR-102-101: メタデータ検証の信頼性
- **目的**: NFR-102-101の検証
- **前提条件**: 多様なメタデータパターンが存在
- **実行手順**:
  1. メタデータ検証処理を実行
  2. 検証成功率を測定
  3. 99%以上の成功率を確認
- **期待結果**:
  - 検証成功率が99%以上である
  - メタデータが正しく検証される
  - 信頼性要件を満たす
- **失敗条件**: 成功率不足、検証エラー

#### NFR-102-102: 形式変換の信頼性
- **目的**: NFR-102-102の検証
- **前提条件**: 多様な形式のファイルが存在
- **実行手順**:
  1. 形式変換処理を実行
  2. 変換成功率を測定
  3. 95%以上の成功率を確認
- **期待結果**:
  - 変換成功率が95%以上である
  - 形式変換が正しく完了する
  - 信頼性要件を満たす
- **失敗条件**: 成功率不足、変換エラー

#### NFR-102-103: データ損失の防止
- **目的**: NFR-102-103の検証
- **前提条件**: 重要なデータを含むファイルが存在
- **実行手順**:
  1. データ処理を実行
  2. データ損失の有無を確認
  3. データ損失率が0%であることを確認
- **期待結果**:
  - データ損失が発生しない
  - 全データが正しく保持される
  - 信頼性要件を満たす
- **失敗条件**: データ損失発生

## テスト実装方針

### Redフェーズ
- すべてのテストケースを実装し、未実装の機能により失敗することを確認
- モッククラスを使用してインターフェースを定義
- エラーハンドリングのテストケースも含める

### Greenフェーズ
- 最小限の実装でテストを通す
- パフォーマンス要件を満たす実装
- エラーハンドリングの実装

### Refactorフェーズ
- コードの可読性と保守性を向上
- パフォーマンスの最適化
- エラーハンドリングの改善

## 実装ファイル

### テストファイル
- `src/popup/metadata-manager.test.ts`: MetadataManagerクラスのテスト
- `src/popup/format-converter.test.ts`: FormatConverterクラスのテスト

### 実装ファイル
- `src/popup/metadata-manager.ts`: MetadataManagerクラスの実装
- `src/popup/format-converter.ts`: FormatConverterクラスの実装
- `src/types/metadata.ts`: メタデータ関連の型定義

## 品質保証

### テストカバレッジ
- 機能要件: 100%
- 条件付き要件: 100%
- 制約要件: 100%
- Edgeケース: 100%
- 非機能要件: 100%

### パフォーマンス要件
- メタデータ読み込み: 200ms以内
- タグフィルタリング: 100ms以内
- 形式変換: 500ms以内

### 信頼性要件
- メタデータ検証成功率: 99%以上
- 形式変換成功率: 95%以上
- データ損失率: 0%
