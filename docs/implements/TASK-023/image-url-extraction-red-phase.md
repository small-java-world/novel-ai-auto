# TASK-023 Image URL Extraction - Redフェーズ設計書

## 実行日時

2025-09-16

## フェーズ概要

TDDのRedフェーズ: 実装前に失敗するテストを作成し、要求仕様を明確化

## テストケース設計

### 1. URL抽出と重複削除

#### 1.1 基本的なURL抽出
- **テスト名**: `生成された画像URLを正常に抽出できる`
- **目的**: NovelAIギャラリーから複数画像のURLを正常に抽出
- **入力**: 3個の画像要素を持つDOM構造
- **期待出力**: 3個のHTTPS URLを含む配列
- **信頼性レベル**: 🟢 要件定義書REQ-004に基づく

#### 1.2 重複除去機能
- **テスト名**: `重複したURLを削除して一意のURL配列を返す`
- **目的**: 同じURLを持つ複数画像要素から重複を除去
- **入力**: 5個の画像要素（3個の異なるURL、2個の重複）
- **期待出力**: 3個のユニークなURL配列
- **信頼性レベル**: 🟢 タスク定義の重複削除要件に基づく

#### 1.3 無効URL除外
- **テスト名**: `無効なURLや空のsrc属性を除外する`
- **目的**: セキュリティとデータ品質の確保
- **入力**: 有効・無効URL混在の6個の画像要素
- **期待出力**: 2個の有効HTTPS URLのみ
- **信頼性レベル**: 🟢 セキュリティベストプラクティスに基づく

### 2. 順序管理

#### 2.1 順序保持
- **テスト名**: `複数画像生成時に正しい順序でURLを返す`
- **目的**: DOM内順序の維持
- **入力**: 番号付きファイル名の4個の画像要素
- **期待出力**: DOM順序と一致するURL配列
- **信頼性レベル**: 🟢 タスク定義の順序管理要件に基づく

#### 2.2 数量制限
- **テスト名**: `指定された数の画像URLのみを順序通りに返す`
- **目的**: 画像生成数の上限制御
- **入力**: 5個の画像要素、上限3個指定
- **期待出力**: 最初の3個のURLのみ
- **信頼性レベル**: 🟢 ユーザビリティ要件に基づく

### 3. エラーハンドリング

#### 3.1 画像要素不在
- **テスト名**: `画像要素が見つからない場合は空配列を返す`
- **目的**: 異常系の適切な処理
- **入力**: 画像要素を含まないDOM
- **期待出力**: 空配列（例外なし）
- **信頼性レベル**: 🟢 異常系処理のベストプラクティス

#### 3.2 DOM解析エラー
- **テスト名**: `DOM解析エラー時に適切なエラーメッセージで例外を投げる`
- **目的**: DOM操作エラーの適切な処理
- **入力**: querySelector をエラーを投げるモックに置換
- **期待出力**: 「DOM解析中にエラーが発生しました」例外
- **信頼性レベル**: 🟡 DOM操作エラーパターンは推測を含む

#### 3.3 タイムアウト処理
- **テスト名**: `URLタイムアウト時に適切なエラーハンドリングを行う`
- **目的**: 長時間処理の制御
- **入力**: 1ms タイムアウト設定
- **期待出力**: 「URL抽出処理がタイムアウトしました」例外
- **信頼性レベル**: 🟡 タイムアウト処理は実装上の推測を含む

### 4. GenerationMonitorとの統合

#### 4.1 IMAGE_READYメッセージ送信
- **テスト名**: `生成完了時にIMAGE_READYメッセージを送信する`
- **目的**: Service Workerとの連携機能確認
- **入力**: 2個の画像要素、ジョブID、ファイル名パラメータ
- **期待出力**: 2回のchrome.runtime.sendMessage呼び出し
- **信頼性レベル**: 🟢 メッセージ形式定義に基づく

#### 4.2 ファイル名テンプレート
- **テスト名**: `ファイル名テンプレートが正しく適用される`
- **目的**: ファイル名生成とサニタイゼーション確認
- **入力**: 特殊文字を含むプロンプト
- **期待出力**: サニタイゼーション済みファイル名
- **信頼性レベル**: 🟢 ファイル名テンプレート仕様に基づく

#### 4.3 Chrome API不在対応
- **テスト名**: `Chrome runtime APIが利用できない場合のエラーハンドリング`
- **目的**: 非Chrome Extension環境での動作確認
- **入力**: chrome オブジェクトを undefined に設定
- **期待出力**: 例外を投げずに正常完了
- **信頼性レベル**: 🟢 ロバストネス要件に基づく

## 実装要求仕様

### ImageUrlExtractor クラス設計

```typescript
class ImageUrlExtractor {
  // 基本URL抽出メソッド
  async extractImageUrls(maxCount?: number, timeoutMs?: number): Promise<string[]>

  // 統合メッセージ送信メソッド
  async extractAndNotifyImageUrls(
    jobId: string,
    templateParams: { date: string; prompt: string; seed: string }
  ): Promise<void>
}
```

### DOM要素セレクタ

- **ギャラリー要素**: `.novelai-gallery`
- **画像要素**: `img` タグのsrc属性
- **URL形式**: HTTPS URLのみ有効

### メッセージ形式

```typescript
{
  type: 'IMAGE_READY',
  payload: {
    jobId: string,
    url: string,
    index: number,
    fileName: string
  }
}
```

### ファイル名テンプレート

- **形式**: `{date}_{prompt}_{seed}_{idx}.png`
- **サニタイゼーション**: 特殊文字（/, :, *）をアンダースコアに置換

## テスト実行結果

### 失敗確認

```
Error: Failed to resolve import "./image-url-extractor" from "src/utils/image-url-extractor.test.ts". Does the file exist?
```

**失敗理由**: ImageUrlExtractorクラスが未実装のため、期待通りのインポートエラー

### 品質判定

**評価**: ✅ 高品質
- **テスト実行**: 成功（失敗することを確認）
- **期待値**: 明確で具体的
- **アサーション**: 適切
- **実装方針**: 明確

## 次のステップ

**推奨コマンド**: `/tdd-green` でGreenフェーズ（最小実装）を開始

### Greenフェーズで実装すべき項目

1. **ImageUrlExtractorクラス定義**
2. **extractImageUrlsメソッド実装**
3. **extractAndNotifyImageUrlsメソッド実装**
4. **URL検証ロジック**
5. **ファイル名生成・サニタイゼーション**
6. **エラーハンドリング実装**

### 重点実装箇所

- DOM要素検索とURL抽出
- 重複除去（Set利用）
- HTTPS URL検証
- Chrome runtime API呼び出し
- 例外処理とタイムアウト制御