# TASK-040: UIスケルトン/状態管理 — テストケース洗い出し（TDD）

対象ファイル: `src/popup/ui-state-manager.ts`
テスト環境: TypeScript + Vitest（happy-dom）

## 1. 正常系テストケース（基本動作）

- テスト名: 初期化時のデフォルト設定読み込み
  - 何をテストするか: 初回起動で `chrome.storage.local` に設定がない場合、既定値をUIに反映する
  - 期待される動作: `imageCount=1`, `seed=-1`, `filenameTemplate='{date}_{prompt}_{seed}_{idx}'` が設定される
- 入力値: storage.get が `{}` を返す
  - 入力データの意味: 設定未保存状態の代表
- 期待される結果: UI要素の値が既定値で更新される
  - 期待結果の理由: `DEFAULT_SETTINGS` に基づく初期化仕様
- テストの目的: 既定設定の適用確認
  - 確認ポイント: storage未設定時の安全な初期化
- 🟢 信頼性レベル

- テスト名: 設定の保存（即時反映）
  - 何をテストするか: UIで値変更時に設定を `chrome.storage.local.set` に保存する
  - 期待される動作: 変更値で `namespace_settings` が保存される
- 入力値: `imageCount=1`, `seed=-1`, `filenameTemplate='{date}_{prompt}_{seed}_{idx}'`
  - 入力データの意味: 代表的な最小構成
- 期待される結果: setが期待引数で1回呼ばれる
  - 期待結果の理由: 保存APIの仕様
- テストの目的: 保存パスの正当性
  - 確認ポイント: キー名・値の妥当性
- 🟢 信頼性レベル

- テスト名: 既存設定の復元
  - 何をテストするか: 保存済み設定をUIへ反映
  - 期待される動作: storageから取得した値でUIが更新される
- 入力値: `namespace_settings` に有効値
  - 入力データの意味: 既存ユーザ設定の代表
- 期待される結果: UI要素更新とログ出力（オプション）
  - 期待結果の理由: 設計コメント・実装
- テストの目的: 復元処理の正当性
  - 確認ポイント: 欠損時のスキップと安全性
- 🟢 信頼性レベル

- テスト名: 待機状態のUI表示制御
  - 何をテストするか: `status='idle'`, `isGenerating=false` のUI状態
  - 期待される動作: ボタン/入力の有効化、待機表示
- 入力値: `UIState { isGenerating:false, status:'idle' }`
- 期待される結果: ステータス表示/ボタン可視性/入力活性が期待どおり
- テストの目的: 状態遷移の表示整合
  - 確認ポイント: クラス付与、不可視領域
- 🟢 信頼性レベル

- テスト名: 生成中のUI表示制御
  - 何をテストするか: `isGenerating=true` のUI状態
  - 期待される動作: 実行中表示・操作ロック・中止ボタン可視
- 入力値: `UIState { isGenerating:true, status:'generating' }`
- 期待される結果: ステータス/ボタン/入力が生成中仕様に一致
- テストの目的: 生成中UIの正当性
  - 確認ポイント: disable/enable切り替え
- 🟢 信頼性レベル

- テスト名: 進捗バー更新
  - 何をテストするか: `updateProgress` でバー幅とテキスト更新
  - 期待される動作: `(current/total)` に応じた%幅、テキスト、ETA表示
- 入力値: `{current:3,total:10,eta:120}`
- 期待される結果: 幅=30%、`3 / 10`、ETA `formatDuration(120)`
- テストの目的: 進捗表示の正確性
  - 確認ポイント: total=0時の0%ガード（NaN回避）
- 🟢 信頼性レベル

- テスト名: 生成開始メッセージ送信
  - 何をテストするか: `startGeneration` が `chrome.runtime.sendMessage` を正しく呼ぶ
  - 期待される動作: `START_GENERATION` メッセージ送信と成功応答で完了
- 入力値: `promptData.prompt='Hello'`, `settings(seed=-1,imageCount=1,filenameTemplate=...)`
- 期待される結果: sendMessageが1回、payloadが期待構造
- テストの目的: メッセージ連携の正当性
  - 確認ポイント: パラメータ合成とエラーハンドリング
- 🟢 信頼性レベル

- テスト名: ログエントリ追加
  - 何をテストするか: `addLog` でDOMへ行追加、上限管理
  - 期待される動作: 末尾追加、上限超過時に先頭を削除
- 入力値: 連続追加（`UI_LIMITS.maxLogEntries+1` 回）
- 期待される結果: 最終件数が上限で安定
- テストの目的: ログUIの安定性
  - 確認ポイント: テキストノード挿入（XSS耐性）
- 🟢 信頼性レベル

- テスト名: テンプレート検証（許可変数のみ）
  - 何をテストするか: 許可された `{date,prompt,seed,idx}` のみ受理
  - 期待される動作: 未知変数は拒否または除去/sanitize
- 入力値: "{date}_{unknown}_{seed}"
- 期待される結果: unknownが除去/置換され、最終テンプレ一致
- テストの目的: ファイル名安全性
  - 確認ポイント: 変数検証と文字サニタイズ
- 🟢 信頼性レベル

- テスト名: 空テンプレートでの代替処理
  - 何をテストするか: 空/空白テンプレで `DEFAULT_SETTINGS.filenameTemplate` を使用
  - 期待される動作: 既定テンプレに自動置き換え
- 入力値: "" / "   "
- 期待される結果: 既定テンプレが採用される
- テストの目的: フォールバックの堅牢性
  - 確認ポイント: 前後空白除去
- 🟢 信頼性レベル

## 2. 異常系テストケース（エラーハンドリング）

- テスト名: 設定読込失敗時の安全動作
  - エラーケースの概要: `chrome.storage.local.get` が例外/エラー
  - エラー処理の重要性: 起動不能を防ぐため
- 入力値: get が例外を投げる
  - 不正な理由: API障害/権限不足
  - 実際の発生シナリオ: 一時的なストレージ不整合
- 期待される結果: 例外捕捉・ログ出力・UIは可能な範囲で継続
  - エラーメッセージの内容: “Settings load failed”系
  - システムの安全性: クラッシュしない
- テストの目的: ロバスト性
  - 品質保証の観点: 起動時安定性
- 🟢 信頼性レベル

- テスト名: 設定保存失敗時の安全動作
  - エラーケースの概要: `chrome.storage.local.set` が例外/エラー
  - エラー処理の重要性: データ損失/クラッシュ回避
- 入力値: set が例外を投げる
  - 不正な理由: API障害/容量超過
  - 実際の発生シナリオ: ストレージ一杯
- 期待される結果: 例外捕捉・ログ出力・UI継続
  - エラーメッセージの内容: “Settings save failed”系（実装に準拠）
  - システムの安全性: 継続動作
- テストの目的: 保存時の堅牢性
  - 品質保証の観点: ユーザビリティ
- 🟢 信頼性レベル

- テスト名: 生成開始失敗時のエラーメッセージ
  - エラーケースの概要: `sendMessage` 応答が `success=false`/例外
  - エラー処理の重要性: ユーザーに分かる失敗通知
- 入力値: 応答 `{success:false,error:'...'} / 例外`
  - 不正な理由: バックグラウンド側の拒否
  - 実際の発生シナリオ: 無効パラメータ/内部エラー
- 期待される結果: 例外投げ or ログ出力 “Generation start failed”
  - エラーメッセージの内容: 実装の文言
  - システムの安全性: UIは制御可能のまま
- テストの目的: 失敗通知の適切さ
  - 品質保証の観点: エラーの可観測性
- 🟢 信頼性レベル

- テスト名: 必須DOM要素欠如時のデグレ防止
  - エラーケースの概要: 重要な要素が存在しない
  - エラー処理の重要性: NPE回避
- 入力値: `logsContainer` などを未定義に
  - 不正な理由: HTMLの変更/古いバージョン
  - 実際の発生シナリオ: マークアップ差分
- 期待される結果: “Missing DOM elements” を出力し処理継続
  - エラーメッセージの内容: 欠如ID一覧
  - システムの安全性: 影響範囲限定
- テストの目的: 防御的プログラミング
  - 品質保証の観点: 回帰耐性
- 🟡 信頼性レベル（ログ文言は実装準拠のため）

- テスト名: テンプレートに危険文字が含まれる
  - エラーケースの概要: `<>:"/\|?*` を含むファイル名
  - エラー処理の重要性: OS依存エラー回避
- 入力値: "abc<def>|g*"
  - 不正な理由: ファイル名として不正
  - 実際の発生シナリオ: ユーザー入力
- 期待される結果: `UNSAFE_FILENAME_CHARS` によりサニタイズ
  - エラーメッセージの内容: 必須なし（静かに修正）
  - システムの安全性: 正常保存
- テストの目的: 安全なファイル名生成
  - 品質保証の観点: 互換性
- 🟢 信頼性レベル

## 3. 境界値テストケース（最小/最大/null 等）

- テスト名: progress.total=0 のパーセンテージ計算
  - 境界値の意味: 0除算ガード
  - 境界値での動作保証: 0%として処理
- 入力値: `{current:0,total:0}`
  - 境界値選択の根拠: 実装の条件分岐
  - 実際の使用場面: 未集計時
- 期待される結果: 幅=0%、テキスト `0 / 0`
  - 境界での正確性: NaN発生なし
  - 一貫した動作: 他値と整合
- テストの目的: 除算安全性
  - 堅牢性の確認: UI崩れ防止
- 🟢 信頼性レベル

- テスト名: ログ上限数ちょうど/超過
  - 境界値の意味: `UI_LIMITS.maxLogEntries`
  - 境界値での動作保証: 上限維持、FIFOで削除
- 入力値: 上限回/上限+1回追加
  - 境界値選択の根拠: 定数仕様
  - 実際の使用場面: 長時間稼働
- 期待される結果: 件数=上限、先頭から削除
  - 境界での正確性: 安定
  - 一貫した動作: 常に上限
- テストの目的: メモリ/UI安定
  - 堅牢性の確認: 劣化防止
- 🟢 信頼性レベル

- テスト名: ファイル名テンプレ長の上限
  - 境界値の意味: `UI_LIMITS.maxFilenameLength`
  - 境界値での動作保証: 文字数をトリム
- 入力値: ちょうど上限/上限+1 文字列
  - 境界値選択の根拠: 定数仕様
  - 実際の使用場面: 長いテンプレ
- 期待される結果: 上限以内に収まる
  - 境界での正確性: バイト/文字単位の扱い
  - 一貫した動作: 常にトリム
- テストの目的: 互換性/UI崩れ防止
  - 堅牢性の確認: 入力上限
- 🟡 信頼性レベル（文字種依存は実装準拠）

- テスト名: seed の境界（センチネル -1 と大きな正数）
  - 境界値の意味: ランダム化指定/固定シード
  - 境界値での動作保証: -1 は許容、正数はそのまま
- 入力値: `-1`, `2147483647` など
  - 境界値選択の根拠: 仕様/慣例
  - 実際の使用場面: ランダム/再現性
- 期待される結果: バリデーションを通過
  - 境界での正確性: 許容範囲
  - 一貫した動作: 常に同一
- テストの目的: 入力許容範囲
  - 堅牢性の確認: 例外不要
- 🟡 信頼性レベル（仕様補完の推測を含む）

## 4. 開発言語・フレームワーク

- プログラミング言語: TypeScript
  - 言語選択の理由: 既存実装がTSで型安全性が高く、テスト支援が豊富
  - テストに適した機能: 型補完、ESM対応、DOM型の恩恵
- テストフレームワーク: Vitest（happy-dom 環境）
  - フレームワーク選択の理由: 既存プロジェクト標準で、高速・Jest互換API
  - テスト実行環境: happy-dom によりDOM APIを軽量提供
- 🟢 信頼性レベル

## 5. 品質判定

- テストケース分類: 正常系・異常系・境界値を網羅 → 充足
- 期待値定義: 各ケースで明示 → 充足
- 技術選択: TypeScript + Vitest（happy-dom）に確定 → 充足
- 実装可能性: 既存スタックに適合 → 充足
- 判定: ✅ 高品質

## 6. 次のステップ

次のお勧めステップ: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。
