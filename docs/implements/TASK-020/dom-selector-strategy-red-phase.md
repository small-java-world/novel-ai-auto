# TDD Red Phase: DOM セレクタ戦略とフォールバック

**Task**: TASK-020
**Phase**: Red (失敗するテスト作成)
**Date**: 2025-09-14 23:47
**Status**: 完了 ✅

## 実装されたテストケース

### 1. セレクタ解決の優先順位テスト（3テスト）

#### テスト1: 第1候補が見つかった場合は第1候補を返す

- **目的**: セレクタの優先順位が正しく動作することを確認
- **内容**: 複数候補が存在する際に最優先セレクタが選択される
- **期待動作**: 第1候補の要素が即座に返される
- **信頼性レベル**: 🟢（REQ-105とcontent.tsパターンに基づく）

#### テスト2: 第1候補が失敗した場合は第2候補を試行

- **目的**: フォールバック機能が正常に動作することを確認
- **内容**: 第1候補が不在時の第2候補への自動切り替え
- **期待動作**: 第2候補が正しく選択される
- **信頼性レベル**: 🟢（REQ-105フォールバック探索要件に基づく）

#### テスト3: 全セレクタが失敗した場合はnullを返す

- **目的**: 全フォールバック失敗時のエラーハンドリングを確認
- **内容**: 全セレクタ不一致時の適切な戻り値
- **期待動作**: nullを返し後続エラーハンドリングに連携
- **信頼性レベル**: 🟢（EDGE-001エラーハンドリング要件に基づく）

### 2. タイムアウト時のエラー通知（2テスト）

#### テスト4: タイムアウト時にTimeoutErrorを投げる

- **目的**: タイムアウト機能の適切な動作を確認
- **内容**: 設定時間内に要素が見つからない場合のエラー処理
- **期待動作**: DOMSelectorError例外の発生
- **信頼性レベル**: 🟡（EDGE-001要件に基づくが具体的仕様は実装時決定）

#### テスト5: タイムアウトエラーに診断情報が含まれる

- **目的**: エラーオブジェクトに必要な診断情報が含まれることを確認
- **内容**: 要素タイプ、経過時間、エラーメッセージの検証
- **期待動作**: 詳細な診断情報を含むエラーオブジェクト
- **信頼性レベル**: 🟡（EDGE-001要件から推定）

### 3. 要素の可視性とインタラクタビリティ検証（2テスト）

#### テスト6: 非表示要素はnullを返す

- **目的**: CSS非表示要素の適切な判定を確認
- **内容**: display:none等の非表示要素の除外
- **期待動作**: 非表示要素は操作不可能として扱う
- **信頼性レベル**: 🟢（content.tsのoffsetParentチェック実装済み）

#### テスト7: 無効化要素は警告付きで返す

- **目的**: disabled要素の適切なハンドリングを確認
- **内容**: 無効化されたフォーム要素の検出
- **期待動作**: 警告情報付きの検証結果を返す
- **信頼性レベル**: 🟡（UI操作安定性に必要な機能として推測）

### 4. エラーハンドリング要件（1テスト）

#### テスト8: 包括的なフォールバック探索とエラー通知

- **目的**: REQ-105の核心要件である包括的エラーハンドリングを確認
- **内容**: 全セレクタ探索後の明確なエラーメッセージ生成
- **期待動作**: ユーザーが理解できる詳細エラー情報
- **信頼性レベル**: 🟢（REQ-105とEDGE-001の中核要件）

### 5. パフォーマンス要件（1テスト）

#### テスト9: 500ms以内での要素探索完了

- **目的**: NFR-002進捗更新間隔要件への準拠を確認
- **内容**: 通常ケースでの処理時間ベンチマーク
- **期待動作**: 500ms以内での処理完了
- **信頼性レベル**: 🟡（NFR-002から推定される性能要件）

## テストコード特徴

### 日本語コメントの充実

```typescript
// 【テスト目的】: [このテストで何を確認するかを明記]
// 【テスト内容】: [具体的にどのような処理をテストするか]
// 【期待される動作】: [正常に動作した場合の結果]
// 🟢🟡🔴 信頼性レベル: [元資料のどの程度に基づいているか]

// 【テストデータ準備】: [なぜこのデータを用意するかの理由]
// 【初期条件設定】: [テスト実行前の状態を説明]

// 【実際の処理実行】: [どの機能/メソッドを呼び出すか]
// 【処理内容】: [実行される処理の内容を日本語で説明]

// 【結果検証】: [何を検証するかを具体的に説明]
// 【期待値確認】: [期待される結果とその理由]
expect(result).toBe(expected); // 【確認内容】: [この検証で確認している具体的項目] 🟢🟡🔴
```

### Given-When-Then構造

- **Given** (テストデータ準備): 適切な初期条件設定
- **When** (実際の処理実行): テスト対象機能の実行
- **Then** (結果検証): 期待値との詳細比較

### リアルなテストデータ

```typescript
// NovelAI UIを模擬したHTML構造
document.body.innerHTML = `
  <textarea id="prompt-input-v1" class="primary-prompt"></textarea>
  <textarea id="prompt-input-v2" class="fallback-prompt"></textarea>
`;
```

## 失敗メッセージ分析

### 関数未実装エラー（6テスト）

```
Error: Function 'findElementWithFallback' is not implemented yet.
This will be implemented in TASK-020 Green phase.
```

### 型不一致エラー（3テスト）

```
AssertionError: expected error to be instance of DOMSelectorError
```

## 実装が必要な機能

### Core Functions

1. **`findElementWithFallback`**
   - セレクタ配列による優先順位付き探索
   - 可視性チェック統合
   - フォールバック チェーン実行

2. **`waitForElementWithTimeout`**
   - 非同期要素待機
   - タイムアウト制御
   - 詳細エラー情報生成

3. **`validateElementInteractable`**
   - 要素の操作可能性判定
   - disabled状態検出
   - 警告メッセージ生成

### Error Handling

- **DOMSelectorError クラス**の完全実装
- 要素タイプ、経過時間、試行セレクタ情報の記録
- ユーザーフレンドリーなエラーメッセージ

### Performance Optimization

- 効率的なセレクタ解決アルゴリズム
- 500ms以内での処理完了保証

## 品質評価結果

✅ **高品質テストコード**

- **テスト実行**: 全テストが期待通り失敗
- **期待値**: 明確で具体的な検証項目
- **アサーション**: 適切なマッチャー使用
- **実装方針**: 要件準拠で明確

## Next Steps

**推奨コマンド**: `/tdd-green TASK-020` でGreenフェーズ（最小実装）を開始

### Greenフェーズでの実装順序

1. 基本的な `findElementWithFallback` 実装
2. `DOMSelectorError` クラス完全実装
3. `waitForElementWithTimeout` 非同期機能
4. `validateElementInteractable` 詳細検証
5. パフォーマンス最適化とエラーハンドリング強化

### 統合計画

- `content.ts` の既存セレクタ機能をリファクタリング
- 新しいDOM戦略への段階的移行
- 既存機能との後方互換性維持
