# TASK-011: ファイル名テンプレート/サニタイズ - Greenフェーズ

## 実装日時

2025-09-14

## 実装目標

TDDのGreenフェーズとして、Redフェーズで作成した全13テストケースを通すための**最小限の実装**を行う。

## 実装方針

### 基本原則

- **テスト成功最優先**: コードの美しさよりもテスト通過を重視
- **シンプル実装**: 複雑なロジックは避け、直接的な処理で対応
- **段階的開発**: 1つずつテストケースを確実に通す
- **リファクタ前提**: 次のフェーズで品質改善予定

### 実装アプローチ

1. **基本的な正規表現置換**: テンプレートトークンの直接置換
2. **Windows禁止文字対策**: 標準的な禁止文字セットで置換
3. **基本バリデーション**: エラーケーステストに対応
4. **最小限のエラーハンドリング**: 必要最小限の例外処理

## 実装コード詳細

### ファイル構成

- **実装ファイル**: `src/utils/fileNameTemplate.ts` (120行)
- **主要関数**: 2個 + 補助関数1個

### 関数実装

#### 1. generateFileName関数 (40行)

```typescript
export function generateFileName(template: string, context: FileNameTemplateContext): string;
```

**実装内容**:

- 入力値バリデーション（非文字列・null検出）
- テンプレート構文検証（未閉括弧検出）
- トークン置換処理（{date}, {prompt}, {seed}, {idx}）
- デフォルト値処理（idx=1, seed=空文字）
- 未知トークン除去（正規表現による一括処理）
- 空結果フォールバック（"untitled"）

**特徴**:

- 直接的な `replace()` による置換
- シンプルな条件分岐
- エラー時即座に例外投出

#### 2. sanitizeFileName関数 (65行)

```typescript
export function sanitizeFileName(input: string, options?: FileNameSanitizeOptions): string;
```

**実装内容**:

- 入力値・設定値バリデーション
- Windows禁止文字置換（`<>:"/\|?*` → `_`）
- 連続置換文字集約（`___` → `_`）
- 末尾不正文字除去（ピリオド・空白）
- 長さ制限適用（デフォルト255文字）
- 拡張子保持機能
- 衝突回避コールバック実行

**特徴**:

- オプション初期化とデフォルト値設定
- 正規表現による文字列処理
- 拡張子検出ロジック（最後の`.`から判定）

#### 3. escapeRegExp補助関数 (10行)

```typescript
function escapeRegExp(string: string): string;
```

**実装内容**:

- 正規表現特殊文字のエスケープ処理
- 配列型禁止文字処理の補助機能

## テスト実行結果

### 成功結果

- **テストファイル**: 1個 ✅
- **テストケース**: 13個 ✅
- **実行時間**: 15ms
- **総実行時間**: 1.70秒

### 全テストケース成功確認

1. ✅ 基本テンプレート展開
2. ✅ オプショナルトークン未定義処理
3. ✅ 未知トークン空文字解決
4. ✅ Windows禁止文字置換
5. ✅ 連続禁止文字集約
6. ✅ 末尾不正文字除去
7. ✅ 255文字超過切り詰め
8. ✅ 拡張子保持切り詰め
9. ✅ 空結果"untitled"フォールバック
10. ✅ 無効テンプレートエラー
11. ✅ 非文字列入力バリデーションエラー
12. ✅ 無効設定値バリデーションエラー
13. ✅ 重複サフィックス付与

### 実装中に修正した問題

1. **Windows禁止文字のグローバル置換**: 正規表現のグローバルフラグが複数回実行で問題
2. **テンプレート構文検証**: 括弧の開閉数チェックによる精度向上
3. **バリデーション条件**: maxLength <= 0 の厳密な検証
4. **連続文字集約**: テスト期待値に合わせた適切な処理

## コード品質評価

### 実装品質

- **可読性**: 日本語コメント完備で理解しやすい
- **保守性**: シンプルな構造で修正が容易
- **テスタビリティ**: 全テストケース通過で検証済み
- **型安全性**: TypeScript厳密型チェック対応

### 信頼性レベル

- 🟢 **青信号**: 11箇所（要件に直接対応）
- 🟡 **黄信号**: 7箇所（妥当な推測）
- 🔴 **赤信号**: 0箇所（推測なし）

## リファクタリング候補

### 改善すべき点

1. **関数分割**: 長い関数をより小さな単位に分解
2. **正規表現最適化**: パターンの事前コンパイルによる高速化
3. **エラーメッセージ統一**: 一貫したメッセージ形式
4. **型定義強化**: より厳密な型チェック
5. **設定のバリデーション強化**: より詳細な入力チェック

### 機能的な問題

**なし** - 要件を完全に満たし、全テストケースが成功している

## 次のフェーズへの準備

**Refactorフェーズで実施予定**:

1. コードの美観と構造の改善
2. パフォーマンス最適化
3. セキュリティレビュー
4. ドキュメント整備
5. 拡張性の検討

**現在の実装**: ✅ 高品質

- テスト結果: 全て成功
- 実装品質: シンプルかつ動作する
- リファクタ箇所: 明確に特定済み
- 機能的問題: なし

## 結論

TASK-011のGreenフェーズは成功に完了。全13テストケースが通過し、要件を満たす最小実装が完成しました。次のRefactorフェーズでコード品質をさらに向上させる準備が整っています。
