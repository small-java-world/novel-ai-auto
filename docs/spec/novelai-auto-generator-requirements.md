# NovelAI Auto Generator 要件定義書

## 概要

本プロジェクトは、NovelAI のWebインターフェース上で、あらかじめ定義されたプロンプトを用いて画像生成を自動化する Chrome 拡張（Manifest V3）である。ユーザは拡張のポップアップからプロンプトを選択・実行し、コンテンツスクリプトが NovelAI のDOMを操作して生成を開始、バックグラウンド（Service Worker）が生成完了後の画像を自動ダウンロードする。設定やプロンプトはストレージに保存・復元され、進捗表示・リトライ・適切なエラーハンドリングを提供する。

## ユーザストーリー

### ストーリー1: プロンプトからワンクリック生成

- である NovelAI ユーザ として
- 私は 事前定義のプロンプトを選びワンクリックで画像生成 をしたい
- そうすることで 毎回入力せず素早く一貫した画像を得られる

### ストーリー2: 自動ダウンロードと命名

- である 画像収集者 として
- 私は 生成完了後に画像が自動で所定のファイル名ルールで保存される ことを望む
- そうすることで 手動保存の手間や命名ミスを避け整理が容易になる

### ストーリー3: 進捗と失敗時の再試行

- である 作業効率を重視するユーザ として
- 私は 進捗表示・キャンセル・失敗時の自動再試行 をしたい
- そうすることで 長い待ち時間や一時的な失敗に適切に対処できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは ポップアップから選択したプロンプトを `config/prompts.json` から読み込み 適用 しなければならない。
- REQ-002: システムは NovelAI ページのプロンプト入力欄に値を設定し 生成ボタンをクリック しなければならない。
- REQ-003: システムは 生成進捗（待機/実行/完了/失敗）をポップアップに表示 しなければならない。
- REQ-004: システムは 生成完了後の画像を自動的にダウンロード しなければならない。
- REQ-005: システムは 設定（例: 画像枚数・シード・ファイル名テンプレート等）を保存/復元 しなければならない。
- REQ-006: システムは コンテンツスクリプト、ポップアップ、Service Worker 間でメッセージを送受信 しなければならない。

### 条件付き要件

- REQ-101: NovelAI タブが存在しない場合、システムは タブを新規作成またはアクティブ化 しなければならない。
- REQ-102: ログインが必要な場合、システムは ユーザにログインを促し処理を一時停止 しなければならない。
- REQ-103: 複数枚生成が指定された場合、システムは 指定枚数に達するまで生成・取得を繰り返さなければならない。
- REQ-104: ダウンロードが失敗した場合、システムは 最大N回まで指数バックオフで再試行 しなければならない。
- REQ-105: 想定DOMが取得できない場合、システムは セレクタのフォールバック探索を行い、失敗時はエラー通知 しなければならない。

### 状態要件

- REQ-201: レートリミットやキュー待ち状態にある場合、システムは バックオフしつつ待機して再開 しなければならない。
- REQ-202: ダウンロード許可が未付与の状態では、システムは 権限要求ダイアログを提示 しなければならない。
- REQ-203: ストレージ容量制限に達している状態では、システムは 保存をスキップしユーザに警告 しなければならない。

### オプション要件

- REQ-301: システムは シードを固定またはランダムから選択 してもよい。
- REQ-302: システムは バッチ/スケジュール実行（指定枚数の連続生成）を提供 してもよい。
- REQ-303: システムは ユーザ定義のファイル名テンプレート（例: `{date}_{prompt}_{seed}_{idx}`）をサポート してもよい。
- REQ-304: システムは キーボードショートカットで生成開始 を提供してもよい。

### 制約要件

- REQ-401: システムは Chrome Manifest V3 を使用 しなければならない。
- REQ-402: システムは NovelAI Web UI のDOM操作と Chrome拡張API 以外に外部ネットワーク通信を行わない（最小権限の原則） しなければならない。
- REQ-403: システムは 最小権限（`activeTab`、`scripting`、`downloads` 等必要範囲）で動作 しなければならない。
- REQ-404: システムは 最低サポートChromeバージョンを定義 しなければならない。

## 非機能要件

### パフォーマンス

- NFR-001: 準備完了（DOM取得後）から単枚生成・ダウンロード完了までを 30 秒以内（標準条件）とする。
- NFR-002: 進捗表示・ログ更新は 500ms 以内の周期でユーザに反映する。
- NFR-003: バックグラウンドのメッセージ往復は 200ms 以内のレイテンシを目標とする。

### セキュリティ

- NFR-101: 外部送信は行わず、プロンプト・設定はローカルストレージ（またはchrome.storage）に保存する。
- NFR-102: 収集するデータは最小化し、権限は原則最小で要求する。
- NFR-103: ユーザ入力（ファイル名テンプレート等）はサニタイズして不正文字やパスインジェクションを防止する。

### ユーザビリティ

- NFR-201: 進捗・残枚数・推定残り時間・直近のエラーを明確に表示する。
- NFR-202: 生成処理はユーザがいつでもキャンセルできる。
- NFR-203: 主要UIはキーボード操作に対応し、視認性の高いコントラストで提供する。

## Edgeケース

### エラー処理

- EDGE-001: DOMセレクタ不一致/タイムアウト時は処理を中断しユーザ通知、設定に応じてリトライ。
- EDGE-002: ネットワーク不安定（オフライン/復帰）時は待機し復帰後に再試行。
- EDGE-003: ダウンロード失敗（権限/容量/ファイル名不正）時はテンプレートを自動修正しつつ再試行。
- EDGE-004: ログイン切れ時はログイン誘導後に直前のジョブを再開可能にする。

### 境界値

- EDGE-101: プロンプト文字数が上限近傍の場合でも安全に適用し、切り詰め時は警告する。
- EDGE-102: 生成枚数が 0/1/最大（設定上限）でも正しく動作する。
- EDGE-103: ファイル名長・禁止文字・重複時に衝突回避（インデックス付与）する。
- EDGE-104: バックオフ上限・リトライ回数上限に達した場合は明示的に失敗として確定する。

## 受け入れ基準

### 機能テスト

- [ ] ポップアップからプロンプト選択→NovelAIで生成が開始される。
- [ ] 単枚生成後に画像が自動ダウンロードされる（所定の命名規則）。
- [ ] 複数枚指定で指定枚数ぶん繰り返し生成・保存される。
- [ ] タブ未存在時にNovelAIタブが作成/アクティブ化される。
- [ ] DOM変更時にフォールバック探索→失敗時にユーザ通知される。
- [ ] ダウンロード失敗時に指数バックオフでN回再試行される。
- [ ] シード固定/ランダムの切替が正しく反映される。
- [ ] 進捗表示・キャンセル・ログ出力が機能する。

### 非機能テスト

- [ ] 標準条件で単枚 30 秒以内に完了する。
- [ ] 最小権限でインストール・実行できる（権限監査パス）。
- [ ] ファイル名テンプレートの不正文字が適切にサニタイズされる。
- [ ] オフライン→復帰の間で安全に再試行できる。
- [ ] アクセシビリティ（コントラスト/フォーカス/キーボード操作）が満たされる。

