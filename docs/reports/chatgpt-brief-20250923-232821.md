### 実行停止（メインPositiveにフォーカスしたまま停止）原因分析メモ（2025-09-23 23:28）

目的
- ChatGPT に相談するための事実ベース報告。該当ログの抜粋と、停止に至る直接要因、修正案を短く高密度で提示。

---

## 事象

- ユーザー体験: 「メインのポジティブプロンプトのテキストボックスにフォーカスが当たって、そのまま止まる」
- ログ上の最新実行で、Negative 読み戻し検証が失敗し、エラーを投げて以降の処理が進まず停止。

---

## 直接の根拠（ログ抜粋）

1) Positive 適用は成功
```324:328:logs-20250923-232821.json
{"kind":"DIAG","data":{"step":"apply-payload", ...}}
{"kind":"DIAG","data":{"step":"positive-set","data":{"length":123}}}
{"kind":"DIAG","data":{"step":"positive-confirm-ok","data":{"len":123}}}
```

2) Negative ターゲット選定 → メインプロンプト領域を指している（誤特定）
```334:336:logs-20250923-232821.json
{"kind":"DIAG","data":{"step":"negative-target-picked",
  "data":{
    "cls":"ProseMirror",
    "path":"... > div.image-gen-prompt-main > div.prompt-input-box-プロンプト:nth-of-type(2) > ... > div.ProseMirror"
  }
}}
```

3) 読み戻し検証で不一致（ok:false）→ 直後に error
```336:338:logs-20250923-232821.json
{"kind":"DIAG","data":{"step":"confirm-proof",
  "data":{
    "ok":false,
    "cls":"ProseMirror ProseMirror-focused",
    "sample":"",
    "tag":"negative"
  }
}}
{"kind":"DIAG","data":{"step":"error","data":{"error":"negative: readback mismatch"}}}
```

ポイント
- `negative-target-picked` が `prompt-input-box-プロンプト` 直下の `.ProseMirror` を指しており、Negative ではなく Positive 側を掴んでいる。
- `confirm-proof.ok:false` となり、`negative: readback mismatch` を throw。`applyNegativePrompt()` が例外を投げるため、上位の処理が停止。

---

## 技術的原因の整理（仮説の優先度順）

- H1: Negative セマンティック解決の範囲が広すぎ、近傍ラベル解釈で Positive 側スコープを拾っている（JP UIで `プロンプト` を含むセクションに引きずられる）
- H2: `confirmAppliedWithProof` のエラーを即 throw しており、フォールバック戦略に遷移できず処理停止に至る
- H3: フォーカス維持（`ProseMirror-focused`）が Positive 側に残存し、書込み先と読戻し先の不一致を誘発

---

## 最小修正案（順に適用推奨）

1) Negative ターゲット選定の厳格化（誤特定回避）
- スコープ限定: `prompt-input-box-undesired-content`, `prompt-input-box-negative-prompt`, `[data-negative=true]`, `aria/placeholder*="negative"` を優先
- 除外条件: `prompt-input-box-プロンプト`（Positive 断面）が祖先に含まれる要素は Negative 候補から除外
- 近傍ラベル探索でも、ラベル文字列に `除外/Negative/Undesired` が含まれない限り Negative と見なさない

2) 失敗時のフォールバック制御
- `confirmAppliedWithProof()` の不一致（ok:false）は「DIAGを出して次の戦略へ継続」に降格（throwしない）
- 全戦略失敗時のみ最終的に警告ログ＋継続（停止させない・生成へは進めるかは設定で）

3) 読戻し対象の「同一要素」保証
- `set → confirm` は同じ `HTMLElement` 参照を渡す（再探索禁止）
- 追加ログ: `confirm-proof` に `outerHTML` 先頭断片と `data-*` を併記済（今回ログで確認済）

---

## 追加で ChatGPT に聞きたいこと

Q1: JP UI で Negative フィールドを最も安定して特定できる追加セレクタ/構造（祖先クラス/ラベル/aria）は？

Q2: 生成フローを止めない設計として、Negative 未設定時の扱い（警告で進める or 必須にする）のベストプラクティスは？

Q3: ProseMirror で `insertText` が無効な場合、paste 駆動と組み合わせた確実な適用手順の順序（選択削除→paste→blur→input/change）で改善余地は？

---

## 参考: 流れの見取り図（今回）

- Positive: set → confirm OK
- Negative: 誤ターゲット（Positive領域）→ confirm NG → 例外 → 停止（ユーザー体感と一致）


