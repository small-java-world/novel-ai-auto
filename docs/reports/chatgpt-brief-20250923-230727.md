### NovelAI拡張 実行結果ブリーフ（2025-09-23 23:07 / logs-20250923-230727.json）

目的
- ChatGPT への相談材料。どこまで動作し、どこが未達かをログ根拠付きで共有。

---

## できていること（この実行）

- ポジティブ入力→読戻しOK（該当UI要素に対して）
- ネガティブ入力→読戻しOKというログ出力はある（後述の通り、UIでの未反映懸念あり）
- 生成ボタン解決→クリック→無効化→再有効化で1枚生成完了
- ダウンロード: ギャラリー内の保存ボタン検出→クリック（前回のフォールバックではなく実ボタン）

代表ログ抜粋

```318:329:logs-20250923-230727.json
{"kind":"DIAG","data":{"data":{"profile":"character-anime","ts":1758636425814},"step":"selector-profile-selected"}}
{"kind":"DIAG","data":{"data":{"editable":false,"tag":"TEXTAREA","ts":1758636425817},"step":"prompt-input-found"}}
{"kind":"DIAG","data":{"data":{"charMeta":{"id":"anime-heroine","index":0,"name":"アニメヒロイン","total":3},"negLen":121,"posLen":123,"selectorProfile":"character-anime","ts":1758636425818},"step":"apply-payload"}}
{"kind":"DIAG","data":{"data":{"length":123,"ts":1758636425819},"step":"positive-set"}}
{"kind":"DIAG","data":{"data":{"len":123,"ts":1758636425819},"step":"positive-confirm-ok"}}
```

```358:366:logs-20250923-230727.json
{"kind":"DIAG","data":{"data":{"attempt":1,"ts":1758636425891},"step":"before-generate-click"}}
{"kind":"DIAG","data":{"data":{"ariaDisabled":null,"classes":"sc-4f026a5f-2 sc-883533e0-3 iaNkyw dISzhx","disabled":false,"tag":"BUTTON","text":"１枚のみ生成0Anlas","ts":1758636425892},"step":"generate-target"}}
{"kind":"DIAG","data":{"data":{"ts":1758636426124},"step":"generate-state-change-detected"}}
{"kind":"DIAG","data":{"data":{"attempt":1,"ts":1758636426124},"step":"after-generate-click"}}
{"kind":"DIAG","data":{"data":{"state":"disabled","ts":1758636426125},"step":"generate-button-state"}}
...
{"kind":"DIAG","data":{"data":{"state":"enabled","ts":1758636437239},"step":"generate-button-state"}}
{"kind":"DIAG","data":{"data":{"attempt":1,"ts":1758636437554},"step":"generate-cycle-complete"}}
```

```416:425:logs-20250923-230727.json
{"kind":"DIAG","data":{"data":{"top":[],"total":0,"ts":1758636437806},"step":"dl-hint-candidates"}}
{"kind":"DIAG","data":{"data":{"classes":"sc-4f026a5f-2 iaNkyw","strategy":"gallery-first","ts":1758636437808},"step":"dl-selected"}}
{"kind":"DL_CLICKED","data":{"classes":"sc-4f026a5f-2 iaNkyw","tag":"BUTTON"}}
{"kind":"DIAG","data":{"data":{"ts":1758636437809},"step":"download-button-clicked-simple"}}
{"kind":"DIAG","data":{"data":{"timeoutMs":120000,"ts":1758636437833},"step":"site-download-wait-start"}}
```

---

## できていない/懸念点

- マルチキャラ遷移なし: 2人目以降への遷移ログ（`MULTI_CHAR_DONE`→次の`MULTI_CHAR_APPLY`）が発火していない
- ダウンロード完了イベントが未記録（`SITE_DOWNLOAD_COMPLETE` 等が無い）
- ネガティブ入力の「UI未反映」懸念
  - ログ上は「負例を見つけ、2番目のProseMirrorに書き込み→読戻し一致」を示すが、利用者観測ではUIに反映されていない
  - 読戻し対象が“別エディタ”を拾っている可能性があり、DOMパス出力/outerHTML併記の追加診断が必要

ネガティブ関連ログ（今回根拠とした箇所）

```334:344:logs-20250923-230727.json
{"kind":"DIAG","data":{"data":{"count":2,"ts":1758636425825},"step":"prosemirror-editors-found"}}
{"kind":"DIAG","data":{"data":{"count":2,"ts":1758636425825},"step":"trying-second-prosemirror"}}
{"kind":"DIAG","data":{"data":{"length":121,"sample":"realistic, lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, cropped, worst quality, low qualit","strategy":0,"ts":1758636425881},"step":"negative-after-set"}}
{"kind":"DIAG","data":{"data":{"length":121,"ts":1758636425889},"step":"negative-set"}}
{"kind":"DIAG","data":{"data":{"len":121,"ts":1758636425889},"step":"negative-confirm-ok"}}
{"kind":"DIAG","data":{"data":{"contentMatch":true,"elementDataAttrs":"","elementId":"no-id","expectedLen":121,"expectedSample":"realistic, lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, cropped, worst","negativeElementClass":"ProseMirror","negativeElementFound":true,"negativeElementTag":"DIV","negativeLen":121,"negativeSample":"realistic, lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, cropped, worst","positiveLen":636,"ts":1758636425890},"step":"confirm-readback-after-negative-detailed"}}
```

利用者観測との齟齬
- 「UI上はネガティブが入っていない」→ 読戻し対象の選定に誤りがあり、別のProseMirrorから読んでいる可能性

---

## ChatGPT への質問

1) ネガティブ入力の読戻しが真に同一フィールドを指しているかの検証手順として、どのメタ情報（例: DOMPath、`outerHTML` の先頭、`data-*`属性）をログに追加すべきか？
2) ProseMirrorが複数ある画面で、ネガティブ欄を安定同定するセマンティック手がかり（ラベル階層、近傍テキスト、親カードの役割属性等）の優先度設計はどうすべきか？
3) 生成→サイトDL完了→次キャラ進行の一連制御は、どのイベント（`downloads.onChanged`/`onCreated`）をトリガーにするのが堅牢か？

補足（前提）
- 現在の実装では「プロンプト入力→生成→保存ボタン押下」までが実行可能。キャラ追加UIのDOM操作（＋ボタン押下/カード入力）は未実装。


