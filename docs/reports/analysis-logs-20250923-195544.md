## NovelAI 自動化ログ詳細サマリ（2025-09-23 10:55:10Z ～）

対象ログ: `logs-20250923-195544.json`

### 1) ページロードとプロファイル選択
- NovelAI Image ページへ遷移し、静的リソースのロード多数
- セレクタープロファイル選択: `selector-profile-selected: "$default"`（初期ロード時）、実行開始時は `character-anime` に切り替わり

### 2) プロンプト入力の解決と適用
- `resolve-element-start` → `resolve-element-ok` にて `prompt-input` が `DIV.ProseMirror` として解決（XPath/CSS強化が効いている）
  - 例: step `prompt-input-found` { tag: DIV, editable: true }
- Positive 適用: `positive-set length=123` を記録
- Negative 入力探索:
  - 既存 CSS セレクタ群は 0 件（`selector-explore negative-input` の各selが count:0）
  - `.ProseMirror` エディタ数 `count:2`
  - Strategy 0（文脈推定 → 2番目エディタ）で成功:
    - `trying-second-prosemirror`
    - `negative-after-set { strategy:0, length:121 }`
    - `negative-set length:121`
    - 読み戻し検証: `confirm-readback-after-negative-detailed { contentMatch: true, negativeLen:121 }`

結論: メイン/ネガティブともに DOM 書き込みは成功し、読み戻しでも一致を確認済み。

### 3) パラメータ適用と実行開始
- `params-applied { count:1, seed:-1 }`
- 実行開始: `simple-mode-start`, `next-iteration-start`, `before-generate-click`
- 生成ボタン解決: `generate-target { tag: BUTTON, text:"１枚のみ生成0Anlas", disabled:false }`
- クリック後ステート遷移:
  - `generate-enter-fallback`（Enter/Ctrl+Enterフォールバックも発火）
  - 確認ダイアログ: `confirm-dialog-found` → `confirm-dialog-clicked { text:"close this dialog" }`
  - `generate-state-change-detected`
  - `generate-button-state: disabled`

### 4) 生成リクエストと完了判定
- 生成API送信: `POST /ai/generate-image-stream`
- 推奨タグAPI: `GET /ai/generate-image/suggest-tags`（200）
- 進行ログ:
  - `generate-button-state enabled`（無効→有効へ復帰）
  - `generate-cycle-complete`（サイクル完了検知）

結論: 単発生成サイクルは UI 状態変化で正常完了と判定。

### 5) ダウンロード段階の挙動
- ギャラリー検査: `dl-gallery { scoped:false }`
- 直近画像検出: `dl-target-image { src: data:image/png..., rect:{w:826,h:565} }`（サイト上に画像は表示済み）
- 画像近傍ダウンロード候補: `dl-candidates { total:0, top:[] }`
- 追加ヒント候補: `dl-hint-candidates { total:0, top:[] }`

結論: 画像は出ているが、近傍/ギャラリー内ダウンロードボタンが検出できず（0件）。NovelAI 側 UI で保存ボタンが隠れる/別レイヤにある/権限UI重なりの可能性。

### 6) 重要ポイント（成功 / 失敗）
- 成功
  - プロンプト入力（Positive/Negative）: 成功、読み戻し一致
  - 生成ボタン検出/クリック/状態遷移: 成功
  - 単発生成サイクル: 正常完了
- 未達（改善余地）
  - サイト内ダウンロードボタン検出: 0件 → 保存クリック未実施

### 7) 想定される原因と追加確認
- 原因候補
  - 保存ボタンがオーバーレイ/ポップオーバー/Shadow DOM 内でセレクタが届いていない
  - ホバーで表示される UI（カード右上アイコン等）が、現在のマウスイベント疑似化で露出していない
  - 画像ビューア（モーダル）内にのみ保存ボタンが存在し、ギャラリー側に無い
  - サイトの A/B テストやロールアウト差分でクラス名/構造が異なる
- ログからのヒント
  - `dl-target-image` は data:image の大きな画像を捕捉
  - その直近/カードスコープで候補 0 件 → 探索スコープ/ホバー表示に問題がある可能性

### 8) 次のアクション（提案）
- 検出強化
  - オーバーレイを強制的に開いてから、`[role="dialog"], .ReactModal__Content` スコープで `button[aria-label*="save" i], a[download]` を再探索
  - 画像上で十分な hover/mousemove シーケンスを広い範囲で送出して、隠しアイコンを露出
  - Shadow DOM 探索（`querySelectorAll('*')` で `shadowRoot` 再帰走査）を追加し `download` を含む aria/title/class を集計
- ログ強化
  - `dl-candidates` 0 件時、周辺の `button, [role="button"], a` の上位 20 件のクラス/テキスト/rect をスナップショット
  - 画像クリックでモーダルを開く分岐（既に実装済み）後の探索結果もダンプ
- フォールバック
  - 既に `data:`/`blob:` → `a[download]` 直作成の最終フォールバックあり。今回 `data:` 画像があるので、直ダウンロード分岐を早期トリガにして保存成功率を上げる

### 9) チャット相談用ポイント（要回答事項）
- 保存ボタンはギャラリーカード上にありますか？それとも画像ビューア（拡大モーダル）内のみですか？
- 保存ボタンの aria-label / title / クラス名の例（可能ならスクショまたは `outerHTML` 抜粋）
- 直近 UI（A/B テスト含む）でダウンロード導線が変更されていないか

---

このログでは「入力と生成」は通っており、「保存ボタン検出」がボトルネックです。上記の探索強化/フォールバック前倒しを適用すれば、保存の安定度を上げられます。必要なら、この分析に沿った修正 PR を作成します。


