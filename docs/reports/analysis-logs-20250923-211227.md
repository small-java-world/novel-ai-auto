### NovelAI automation: 現状・問題点・コード根拠（2025-09-23 21:12 実行ログ解析）

このメモは ChatGPT へ相談するための事実ベース資料です。添付ログ `logs-20250923-211227.json` と現行コードを突き合わせ、何が起きたか／残る問題点／該当コードを端的にまとめます。

---

## 実行結果サマリ（ログ根拠付き）

- **拡張の起動とセレクタープロファイル適用**
  - content 起動・バージョン診断 OK。
  - プロファイル選択ログあり。
  
```54:56:logs-20250923-211227.json
{"ts":1758629497315,"iso":"2025-09-23T12:11:37.315Z","kind":"MSG","data":{"from":1972432178,"type":"GENERATION_DIAGNOSTICS"}}
{"ts":1758629497316,"iso":"2025-09-23T12:11:37.316Z","kind":"DIAG","data":{"data":{"features":["multi-layer-download","enhanced-logging","cache-busted","debug-logging-enabled"],"name":"Enhanced","timestamp":"2025-09-23T12:11:37.285Z","ts":1758629497285,"version":"1.0.2-FIXED"},"step":"content-script-enhanced-version"}}
```

- **マルチキャラ開始（3キャラ入力リクエスト）→ 実際は1キャラのみ処理**
  - `START_PAYLOAD_SHAPE` で 3 キャラ。
  - count=1 のため最初の1件のみ進行、残り2件は `MULTI_CHAR_SKIPPED`。

```318:320:logs-20250923-211227.json
{"ts":1758629516691,"iso":"2025-09-23T12:11:56.691Z","kind":"START_PAYLOAD_SHAPE","data":{"characters":3,"composite":true}}
{"ts":1758629516694,"iso":"2025-09-23T12:11:56.694Z","kind":"MULTI_START","data":{"characters":3}}
```

```444:445:logs-20250923-211227.json
{"ts":1758629531273,"iso":"2025-09-23T12:12:11.273Z","kind":"MULTI_CHAR_DONE","data":{"index":0,"name":"アニメヒロイン","ok":true}}
{"ts":1758629531276,"iso":"2025-09-23T12:12:11.276Z","kind":"MULTI_CHAR_SKIPPED","data":{"skipped":2}}
```

- **プロンプト適用（Positive/Negative）成功**
  - Positive 設定・確認 OK。
  - Negative は ProseMirror 二番目推定→設定→読取一致 OK。

```330:346:logs-20250923-211227.json
{"ts":1758629516930,"iso":"2025-09-23T12:11:56.930Z","kind":"DIAG","data":{"data":{"length":123,"ts":1758629516920},"step":"positive-set"}}
{"ts":1758629516934,"iso":"2025-09-23T12:11:56.934Z","kind":"DIAG","data":{"data":{"len":123,"ts":1758629516920},"step":"positive-confirm-ok"}}
{"ts":1758629516945,"iso":"2025-09-23T12:11:56.945Z","kind":"DIAG","data":{"data":{"count":2,"ts":1758629516923},"step":"prosemirror-editors-found"}}
{"ts":1758629516949,"iso":"2025-09-23T12:11:56.949Z","kind":"DIAG","data":{"data":{"count":2,"ts":1758629516923},"step":"trying-second-prosemirror"}}
{"ts":1758629516984,"iso":"2025-09-23T12:11:56.984Z","kind":"DIAG","data":{"data":{"length":121,"sample":"realistic, lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, cropped, worst quality, low qualit","strategy":0,"ts":1758629516981},"step":"negative-after-set"}}
{"ts":1758629516994,"iso":"2025-09-23T12:11:56.994Z","kind":"DIAG","data":{"data":{"length":121,"ts":1758629516992},"step":"negative-set"}}
{"ts":1758629516999,"iso":"2025-09-23T12:11:56.999Z","kind":"DIAG","data":{"data":{"len":121,"ts":1758629516992},"step":"negative-confirm-ok"}}
```

- **生成ボタンクリック→無効化→再有効化サイクルで完了検知 OK**

```362:366:logs-20250923-211227.json
{"ts":1758629517037,"iso":"2025-09-23T12:11:57.037Z","kind":"DIAG","data":{"data":{"attempt":1,"ts":1758629516994},"step":"before-generate-click"}}
{"ts":1758629517045,"iso":"2025-09-23T12:11:57.045Z","kind":"DIAG","data":{"data":{"ariaDisabled":null,"classes":"sc-4f026a5f-2 sc-883533e0-3 iaNkyw dISzhx","disabled":false,"tag":"BUTTON","text":"１枚のみ生成0Anlas","ts":1758629516995},"step":"generate-target"}}
```

- **ダウンロード処理**
  - 画像サムネ検知→近傍ボタン探索 0 件。
  - フォールバックアンカー（data: URL）でダウンロード発火→complete まで検知。

```410:418:logs-20250923-211227.json
{"ts":1758629527060,"iso":"2025-09-23T12:12:07.060Z","kind":"DIAG","data":{"data":{"classes":null,"scoped":false,"ts":1758629527052},"step":"dl-gallery"}}
{"ts":1758629527064,"iso":"2025-09-23T12:12:07.064Z","kind":"DIAG","data":{"data":{"rect":{"h":565,"w":826},"src":"data:image/png;base64,/9j/4AAQSkZJRgABAgAAAQABAAD/2wBDADUlKC8oITUvKy88OTU/UIVXUElJUKN1e2GFwarLyL6qurfV8P//1eL/5re6//////","ts":1758629527052},"step":"dl-target-image"}}
{"ts":1758629527069,"iso":"2025-09-23T12:12:07.069Z","kind":"DIAG","data":{"data":{"scope":"scoped","top":[],"total":0,"ts":1758629527052},"step":"dl-candidates"}}
```

```421:442:logs-20250923-211227.json
{"ts":1758629530756,"iso":"2025-09-23T12:12:10.756Z","kind":"DIAG","data":{"data":{"ts":1758629530753},"step":"download-button-not-found-simple"}}
{"ts":1758629530760,"iso":"2025-09-23T12:12:10.760Z","kind":"MSG","data":{"from":1972432178,"type":"DOWNLOAD_CLICKED"}}
{"ts":1758629530764,"iso":"2025-09-23T12:12:10.764Z","kind":"MSG","data":{"from":1972432178,"type":"GENERATION_DIAGNOSTICS"}}
{"ts":1758629530773,"iso":"2025-09-23T12:12:10.773Z","kind":"DIAG","data":{"data":{"hrefSample":"data:image/png;base64,/9j/4AAQSkZJRgABAgAAAQABAAD/2wBDADUlKC","kind":"data","ts":1758629530754},"step":"dl-fallback-anchor"}}
{"ts":1758629530782,"iso":"2025-09-23T12:12:10.782Z","kind":"DL_CREATED","data":{"filename":"","id":67450,"url":"data:image/png;base64,/9j/4AAQSkZJRgABAgAAAQABAAD/2wBDADUlKC8oITUvKy88OTU/UIVXUElJUKN1e2GFwarLyL6qurfV8P//1eL/5re6////////////zv//////////////2wBDATk8PFBGUJ1XV53/3Lrc//////////////////////////////////"}}
{"ts":1758629531210,"iso":"2025-09-23T12:12:11.210Z","kind":"DL_COMPLETE","data":{"id":67450,"tabId":1972432178}}
```

- **全体の終了状態**
  - 1枚生成成功で `GENERATION_COMPLETE`。

```440:447:logs-20250923-211227.json
{"ts":1758629531262,"iso":"2025-09-23T12:12:11.262Z","kind":"MSG","data":{"from":1972432178,"type":"GENERATION_PROGRESS"}}
{"ts":1758629531267,"iso":"2025-09-23T12:12:11.267Z","kind":"DIAG","data":{"data":{"count":1,"timestamp":"2025-09-23T12:12:11.214Z","ts":1758629531214},"step":"generation-completed-successfully"}}
{"ts":1758629531271,"iso":"2025-09-23T12:12:11.271Z","kind":"MSG","data":{"from":1972432178,"type":"GENERATION_COMPLETE"}}
```

---

## 何が「変わっていないように見えた」か（体感と実際のギャップ）

- UI上では「複数キャラが全て適用されていない」「保存ボタンが押されてない」に見える可能性。
  - 実際の挙動は「count=1 のため最初のキャラのみ」「保存はフォールバック（`<a download>` を自前生成）」で完了。

---

## 直接の原因と改善余地（コード根拠）

1) マルチキャラが1人で止まる（仕様）

```456:458:src/background.ts
const lastIndex = baseParams.count === 1 ? Math.min(1, composite.characters.length) : composite.characters.length;
for (let idx = 0; idx < lastIndex; idx++) {
```

→ 複数キャラすべて適用・生成したい場合は `count` を2以上にするか、このループ条件を UI オプションで切替できるよう変更が必要。

2) ダウンロードボタン直接検出がゼロ→フォールバックアンカーに流れる

```1813:2058:src/content.ts
async function clickPrimaryDownloadButton(): Promise<boolean> {
  // ... 候補列挙（画像近傍スコアリング）→ 0件ならヒント探索
  diag('download-button-not-found-simple');
  // 最終フォールバック: 表示中の画像の data/blob を直接ダウンロード
  const a = document.createElement('a');
  a.href = href; a.download = `novelai_${Date.now()}.png`;
  a.click();
}
```

→ NovelAI の最新 UI で per-image ボタンが Shadow/Portal 内にある可能性。`findPerImageDownloadButtons`/`waitForDownloadButtons` が ShadowRoot を跨がないと 0 件になりやすい。Shadow 再帰探索とオーバーレイ（Portal）内の優先探索を強化すべき。

3) ans2.md の“可視・最前面エディタ”選択と “paste駆動→読戻し” は適用済み（効果あり）

```2553:2570:src/content.ts
function pickTopVisibleEditor(scope: ParentNode = document): HTMLElement | null {
  const candidates = Array.from(scope.querySelectorAll<HTMLElement>('.ProseMirror, textarea'))
    .filter(/* 可視判定 */)
    .sort(/* z-index降順 */);
  return candidates[0] || null;
}
```

```1218:1259:src/content.ts
// contenteditable: execCommand('insertText') → 追い paste → confirmTextApplied()
// mismatchなら例外で検出
```

→ 「ポジティブが入らない」症状は今回のログでは再現せず。対策は効いている可能性が高い。

4) 生成ボタン検出は XPath/ヒューリスティックで成功

```1671:1717:src/content.ts
function fallbackFindGenerateControl(): HTMLElement | null {
  // XPath優先（日本語/英語） + 語彙スコアリング
}
```

---

## 追加で必要な修正提案（ChatGPT への相談ポイント）

- **マルチキャラ仕様**: `count===1` 時のスキップ仕様を UI に明示するか、ポップアップで「キャラ全部1枚ずつ」モードを選べるよう切替。実装は `background.ts` の `lastIndex` 算出に分岐追加。
- **ダウンロード検出の Shadow/Portal 強化**: `findPerImageDownloadButtons` と `waitForDownloadButtons` に ShadowRoot 再帰、Dialog/Portal 内優先探索、hover 待機をより強化。候補 0 件時のフォールバック前にもう一段の再探索を追加。
- **保存ファイル名**: フォールバックアンカー時の `download` 名が空（ログ上）。ファイル名テンプレ（キャラ名/idx/時刻）を適用して一貫命名へ。

---

## 参照コード（抜粋）

```515:733:src/content.ts
async function handleApplyPrompt(...) { /* apply positive/negative, generate loop, download fallback */ }
```

```1512:1545:src/content.ts
async function setSteps(steps: number) { /* 28以上で明示エラー */ }
```

```180:325:src/background.ts
// Logging, downloads mapping, START generation handler（onMessage～）
```

---

## まとめ

- 実行自体は「1キャラ・1枚・保存完了」まで成功。体感の不一致は「count=1 仕様」と「保存ボタンの直接押下が見えない（フォールバック動作）」が要因。
- 次段は「マルチキャラの処理ポリシーの明示/切替」と「ダウンロードボタン検出の Shadow/Portal 強化」を優先するのが効果的。


